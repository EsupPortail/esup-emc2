<?php

/**
 * @see \UnicaenValidation\Controller\ValidationInstanceController::indexAction()
 * @var ValidationInstance[] $instances
 */

use UnicaenValidation\Entity\Db\ValidationInstance;
use UnicaenValidation\Provider\Privilege\ValidationinstancePrivileges;

$this->headTitle("Index des instances de validation");

$canAfficher = $this->isAllowed(ValidationinstancePrivileges::getResourceId(ValidationinstancePrivileges::VALIDATIONINSTANCE_AFFICHER));
$canAjouter = $this->isAllowed(ValidationinstancePrivileges::getResourceId(ValidationinstancePrivileges::VALIDATIONINSTANCE_MODIFIER));
$canModifier = $this->isAllowed(ValidationinstancePrivileges::getResourceId(ValidationinstancePrivileges::VALIDATIONINSTANCE_MODIFIER));
$canHistoriser = $this->isAllowed(ValidationinstancePrivileges::getResourceId(ValidationinstancePrivileges::VALIDATIONINSTANCE_HISTORISER));
$canDetruire = $this->isAllowed(ValidationinstancePrivileges::getResourceId(ValidationinstancePrivileges::VALIDATIONINSTANCE_DETRUIRE));

?>

<h1 class="page-header">
    Indes des instances de validation
</h1>

<div class="main">
    <?php if ($canAjouter): ?>
        <a
            <?php /** @see \UnicaenValidation\Controller\ValidationInstanceController::ajouterAction() */ ?>
            href="<?php echo $this->url('validation/instance/ajouter', [], [], true); ?>"
            class="btn btn-primary action ajax-modal"
            data-event="modification"
        >
            <span class="icon ajouter"> Ajouter une instance de validation</span>
        </a>
    <?php endif; ?>

    <table class="table table-condensed">
        <thead>
        <tr>
            <th> Type </th>
            <th> Refus </th>
            <th> Date </th>
            <th> Utilisateur </th>
            <th> EntityClass </th>
            <th> EntityId </th>
            <th> Action </th>
        </tr>
        </thead>
        <tbody>
        <?php /** @var ValidationInstance $instance */ ?>
        <?php foreach ($instances as $instance) : ?>
            <tr>
                <td> <?php echo $instance->getType()->getCode(); ?> </td>
                <td> <?php echo $instance->getValeur(); ?> </td>
                <td> <?php echo $instance->getHistoModification()->format('d/m/Y à H:i:s'); ?> </td>
                <td> <?php echo $instance->getHistoModificateur()->getDisplayName(); ?> </td>
                <td> <?php echo $instance->getEntityClass(); ?> </td>
                <td> <?php echo $instance->getEntityId(); ?> </td>
                <td>
                    <?php if ($canModifier): ?>
                        <a
                            <?php /** @see \UnicaenValidation\Controller\ValidationInstanceController::modifierAction() */?>
                            href="<?php echo $this->url('validation/instance/modifier', ['validation' => $instance->getId()], [], true); ?>"
                            class="ajax-modal" data-event="modification"
                        >
                            <span class="icon editer" title="Modifier l'instance de validation"></a>
                    <?php endif; ?>

                    <?php if ($canHistoriser): ?>
                        <?php if ($instance->estNonHistorise()) :?>
                            <a
                                <?php /** @see \UnicaenValidation\Controller\ValidationInstanceController::modifierAction() */?>
                                href="<?php echo $this->url('validation/instance/historiser', ['validation' => $instance->getId()], [], true); ?>"
                            >
                                <span class="icon historiser" title="Historiser l'instance de validation"></a>
                        <?php else : ?>

                            <a
                                <?php /** @see \UnicaenValidation\Controller\ValidationInstanceController::modifierAction() */?>
                                href="<?php echo $this->url('validation/instance/restaurer', ['validation' => $instance->getId()], [], true); ?>"
                            >
                                <span class="icon restaurer" title="Restaurer l'instance de validation"></a>
                        <?php endif; ?>
                    <?php endif; ?>

                    <?php if ($canDetruire): ?>
                        <a
                            <?php /** @see \UnicaenValidation\Controller\ValidationInstanceController::detruireAction() */?>
                            href="<?php echo $this->url('validation/instance/detruire', ['validation' => $instance->getId()], [], true); ?>"
                            class="ajax-modal" data-event="modification"
                        >
                            <span class="icon detruire" title="Supprimer définitivement l'instance de validation"></a>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>

    <?php echo $this->validationValider('ACCEPTER_ENTRETIEN_AGENT'); ?>

    <?php foreach ($instances as $instance) : ?>
        <?php if ($instance->getId() < 4) : ?>
            <?php echo $this->validationAfficher($instance); ?>
        <?php endif; ?>
    <?php endforeach; ?>
</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>