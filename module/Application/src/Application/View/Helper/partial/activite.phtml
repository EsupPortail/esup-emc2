<?php

use Application\Controller\ActiviteController;
use Application\Controller\FicheMetierController;
use Application\Entity\Db\Activite;
use Application\Entity\Db\FicheMetier;
use Application\Entity\Db\FicheMetierTypeActivite;
use Application\Entity\Db\FichePoste;
use Application\Entity\Db\FicheposteActiviteDescriptionRetiree;

/**
 * Provient de l'appel de l'aide de vue
 * @var Activite|FicheMetierTypeActivite $activite
 * @var string $mode
 * @var array $options
 *
 * Récupéré du tableau d'options
 * @var FichePoste $ficheposte
 * @var FicheMetier $fichemetier
 * @var FicheposteActiviteDescriptionRetiree[] $retirees
 */

$type = null;
if ($activite instanceof FicheMetierTypeActivite) {
    $type = $activite;
    $activite  = $activite->getActivite();
}

$ficheposte  = (isset($options['ficheposte'])) ?   $ficheposte  = $options['ficheposte'] : null;
$fichemetier = (isset($options['fichemetier'])) ?  $fichemetier = $options['fichemetier'] : null;
$retirees    = (isset($options['retirees'])) ?     $retirees    = $options['retirees'] : null;

$competences   = $activite->getCompetences();
$nbCompetence  = count($competences);
$applications  = $activite->getApplications();
$nbApplication = count($applications);
$formations    = $activite->getFormations();
$nbFormation   = count($formations);

$nbObject      = $nbCompetence + $nbFormation + $nbApplication;
?>

<div class="panel panel-info">

    <div class="panel-heading">
        <div class="row">

            <!-- NOM DE L'ACTVITE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
            <div class="col-md-11">
                <h2 style="text-align: justify;">
                    <?php echo $activite->getLibelle(); ?>
                </h2>
            </div>
            <!-- SELECTION DES SOUS-ACTIVITE~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
            <div class="col-md-1">
                <?php if ($mode === 'edition-fiche-poste') : ?>
                    <?php if ($ficheposte !== null AND $fichemetier !== null AND !empty($activite->getDescriptions())) : ?>
                        <a      <?php /** @see \Application\Controller\FichePosteController::selectionnerDescriptionsRetireesAction() */ ?>
                                href="<?php echo $this->url('fiche-poste/selectionner-descriptions-retirees', ['fiche-poste' => $ficheposte->getId(), 'fiche-metier' => $fichemetier->getId(), 'activite' => $activite->getId()], [], true); ?>"
                                class="ajax-modal" data-event="modification">
                            <span class="icon listing" title="Sélection des sous-activités"></span></a>
                    <?php else: ?>
                        <span class="icon listing" style="color:darkred;" title="Pas de fiche de poste, ou de fiche métier, ou pas de sous-activités"></span>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <div class="panel-body">

        <!-- MODIFICATION DE L'ACTIVITE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <?php if ($mode == 'edition-fiche-metier') : ?>
        <div class="col-md-1" style="border:1px lightgray solid; padding: 5px; text-align: center;">
            <?php /** @see ActiviteController::editerAction() */ ?>
            <a href="<?php echo $this->url('activite/editer', ['activite' => $activite->getId()], [], true); ?>"
               class="btn btn-default ajax-modal"
               data-event="modification"
               style="width:5rem; margin: 5px;"
            >
                <span class="icon editer"></span><br/>
            </a>
            <?php /** @see FicheMetierController::retirerActiviteAction() */ ?>
            <a href="<?php echo $this->url('fiche-metier-type/retirer-activite', ['id' => $type->getId()], [], true); ?>"
               class="btn btn-default"
               style="width:5rem; margin: 5px;">
                <span class="icon detruire"></span><br/>
            </a>
            <?php /** @see FicheMetierController::deplacerActiviteAction() */ ?>
            <a href="<?php echo $this->url('fiche-metier-type/deplacer-activite', ['id' => $type->getId(), 'direction' => 'up'], [], true); ?>"
               class="btn btn-default"
               style="width:5rem; margin: 5px;">
                <span class="icon monter"></span><br/>
            </a>
            <?php /** @see FicheMetierController::deplacerActiviteAction() */ ?>
            <a href="<?php echo $this->url('fiche-metier-type/deplacer-activite', ['id' => $type->getId(), 'direction' => 'down'], [], true); ?>"
               class="btn btn-default"
               style="width:5rem; margin: 5px;">
                <span class="icon descendre"></span><br/>
            </a>
        </div>
        <?php endif; ?>

        <!-- AFFICHAGE DES SOUS ACTIVITE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <div class="<?php echo ($mode == 'edition-fiche-metier')?"col-md-7":"col-md-8"; ?>">
            <h4> Description </h4>
            <?php $descriptions = $activite->getDescriptions(); ?>
            <?php if (! empty($activite->getDescriptions())) : ?>
                <ul>
                    <?php foreach ($activite->getDescriptions() as $description) : ?>
                        <?php
                            $display = true;
                            if ($retirees !== null) {
                                foreach ($retirees as $retiree) {
                                    if ($retiree->getDescription()->getId() === $description->getId()) {
                                        $display = false;
                                        break;
                                    }
                                }
                            }
                        ?>
                        <?php if ($display) : ?>
                        <li> <?php echo $description->getDescription(); ?> </li>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </ul>
            <?php else : ?>
                <span class="probleme"> <?php echo $activite->getDescription(); ?> </span>
            <?php endif; ?>
        </div>

        <!-- CARTOUCHE LATERAL ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <?php if ($nbObject !== 0) : ?>
            <div class="col-md-4" style="border:1px lightblue solid">
                <small>
                <?php if ($nbCompetence > 0) : ?>
                    <h4>
                        <span class="icon competence"></span>
                        Compétences
                        <span class="badge"> <?php echo $nbCompetence; ?></span>
                    </h4>

                    <ul>
                        <?php foreach ($competences as $competence) : ?>
                        <li>
                            <?php echo $competence->getLibelle(); ?>
                        </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>

                <?php if ($nbApplication > 0) : ?>
                    <h4>
                        <span class="icon application"></span>
                        Applications
                        <span class="badge"> <?php echo $nbApplication; ?></span>
                    </h4>

                    <ul>
                        <?php foreach ($applications as $application) : ?>
                            <li>
                                <?php echo $application->getLibelle(); ?>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>

                <?php if ($nbFormation > 0) : ?>
                    <h4>
                        <span class="icon formation"></span>
                        Formations
                        <span class="badge"> <?php echo $nbFormation; ?></span>
                    </h4>

                    <ul>
                        <?php foreach ($formations as $formation) : ?>
                            <li>
                                <?php echo $formation->getLibelle(); ?>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
                </small>
            </div>
        <?php endif; ?>
    </div>
</div>

<style>
    a.btn-default {
        background-color: lightgrey;
    }
    a.btn-default:hover {
        background-color: #aaaaaa;
    }
</style>