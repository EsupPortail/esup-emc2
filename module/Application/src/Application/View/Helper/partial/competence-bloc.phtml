<?php

use Application\Entity\Db\Competence;
use Application\Entity\Db\CompetenceElement;
use Application\Entity\Db\CompetenceType;

/**
 * @var array $competences
 * @var CompetenceType[] $types (n.b. deja ordonnée)
 * @var array $options
 *
 * la sutrcture de application est la suivante :
 *
 * $applications = [
 *      ID => [
 *          'entite' => Application,
 *          'display' => true|false,
 *          'raison' => [
 *                  [ 'source', SourceEntity ],
 *                  [ 'source', SourceEntity ],
 *                  ...
 *              ]
 *          ],
 *      ...
 *  ]
 */

$groupes = [];
$sansGroupe = "zzz";
foreach ($competences as $item) {
    /** @var Competence $competence */
    $entite = $item['entite'];
    $competence = $entite;
    if ($entite instanceof CompetenceElement) $competence = $entite->getCompetence();
    if ($competence) {
        $libelleGroupe = ($competence->getType()) ? $competence->getType()->getLibelle() : $sansGroupe;
        if ($item['conserve'] === true) $groupes[$libelleGroupe][] = $item;
    }
}

ksort($groupes);


$niveau_modifiable = true;
?>

<table class="listing">
    <?php foreach ($types as $type) : ?>
        <?php $groupe = $groupes[$type->getLibelle()]; ?>
        <?php if ($groupe !== null AND !empty($groupe)) : ?>
            <tr>
                <th colspan="2">
                    <?php echo $type->getLibelle(); ?>
                </th>
            </tr>
            <?php usort($groupe, function ($a, $b) { return $a['entite']->getLibelle() > $b['entite']->getLibelle(); }); ?>
            <?php foreach ($groupe as $element) : ?>
                <?php
                    $entite = $element['entite'];
                    $competence = $entite;
                    if ($competence instanceof CompetenceElement) $competence = $competence->getCompetence();
                ?>
                <tr>
                    <td class="libelle">
                        <?php echo $competence->getLibelle(); ?>
                        <?php echo $this->raisons($element['raison']); ?>
                    </td>
                    <td class="niveau">
                        <?php if ($entite instanceof CompetenceElement) : ?>
                            <?php echo ($entite->getNiveauMaitrise())?$entite->getNiveauMaitrise()->getLibelle():"Niveau non précisé"; ?>
                            <?php if ($niveau_modifiable) : ?>
                                <a  <?php /** @see \Application\Controller\CompetenceController::changerNiveauAction() */ ?>
                                    href="<?php echo $this->url("competence/changer-niveau", ['competence-element' => $entite->getId()], [], true); ?>"
                                    class="ajax-modal" data-event="modification" data-toggle="tooltip" data-html="true"
                                    title="Modifier le niveau de la compétence <span class='highlight competence'><?php echo $competence->getLibelle(); ?></span>">
                                    <span class="icon editer"></span>
                                </a>
                            <?php endif; ?>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        <?php endif; ?>
    <?php endforeach; ?>
</table>




