<?php

/**
 * @var Agent $agent
 */

use Application\Entity\Db\Agent;
use Application\Entity\Db\AgentGrade;
use Application\Entity\Db\AgentMissionSpecifique;
use Application\Entity\Db\AgentStatut;

$now = new DateTime();
?>

<div class="alert alert-warning">
    <strong><span class="icon information"></span> Informations affichés :</strong>
    <ul>
        <li> Seuls les statuts et les grades actifs sont affichés par choix voir avec le groupe GPEEC pour ce que l'on affiche. </li>
    </ul>
</div>

<h2> Présentation de l'agent </h2>

<?php
?>

<dl class="dl-horizontal">
    <dt> Prénom </dt>
    <dd> <?php echo $agent->getPrenom(); ?> </dd>
    <dt> Nom </dt>
    <dd> <?php echo $agent->getNomUsuel(); ?> </dd>
    <dt> Quotité travaillée </dt>
    <dd> <?php echo $agent->getQuotite(); ?> </dd>
</dl>

<?php
    $statutAll = $agent->getStatuts();
    usort($statutAll, function (AgentStatut $a, AgentStatut $b) { return $a->getDebut() < $b->getDebut();});
    $statuts = [];
    foreach($statutAll as $statut) {
        if ($statut->getFin() === null or $statut->getFin() > $now) {
            $statuts[] = $statut;
        }
    }
    $nbStatus = count($statuts);
?>


<?php if ($nbStatus !== 0) : ?>
    <h2>
        Statuts actifs
        <span class="badge">
        <?php echo $nbStatus; ?>
        </span>
    </h2>

    <?php foreach ($statuts as $statut) : ?>
        <?php echo $this->agentStatut($statut, ['denomination' => false]); ?>
    <?php endforeach; ?>
<?php endif; ?>

<?php
    $gradeAll = $agent->getGrades();
    usort($gradeAll, function (AgentGrade $a, AgentGrade $b) { return $a->getDateDebut() < $b->getDateDebut();});
    $grades = [];
    foreach($gradeAll as $grade) {
        if ($grade->getDateFin() === null or $grade->getDateFin() > $now) {
            $grades[] = $grade;
        }
    }
    $nbGrades = count($grades);
?>

<?php if ($nbGrades !== 0) : ?>
    <h2>
        Grades actifs
        <span class="badge">
        <?php echo $nbGrades; ?>
        </span>
    </h2>

    <?php foreach ($grades as $grade) : ?>
        <?php echo $this->agentGrade($grade, ['id' => false, 'denomination' => false]); ?>
    <?php endforeach; ?>
<?php endif; ?>


<?php if (!empty($agent->getMissionsSpecifiques())) : ?>
    <h2> Missions spécifiques </h2>

    <ul>
        <?php /** @var AgentMissionSpecifique $mission */ ?>
        <?php foreach ($agent->getMissionsSpecifiques() as $mission) : ?>
            <li>
                <?php echo $mission->getMission()->getLibelle(); ?>
                <?php if ($mission->getStructure()) echo  " pour ".$mission->getStructure()->getLibelleCourt(); ?>
                 du
                <?php echo ($mission->getDateDebut()?$mission->getDateDebut()->format('d/m/Y'):"---"); ?>
                au
                <?php echo ($mission->getDateFin()?$mission->getDateFin()->format('d/m/Y'):"---"); ?>
            </li>
        <?php endforeach; ?>
    </ul>
<?php endif; ?>