<?php

use Application\Controller\FicheMetierController;
use Application\Entity\Db\Application;
use Application\Entity\Db\Competence;
use Application\Entity\Db\FicheMetier;
use Application\Entity\Db\FicheMetierTypeActivite;
use Application\Entity\Db\Formation;

/**
 * @var FicheMetier $fiche
 */

/**
 * @var FicheMetierTypeActivite[] $activites
 */
$activites = $fiche->getActivites();
usort($activites, function (FicheMetierTypeActivite $a, FicheMetierTypeActivite $b) { return $a->getPosition() > $b->getPosition();});

$this->headTitle("Affichage de la fiche métier : ".$fiche->getId());

$editMode = false;
if (isset($options['edit-mode'])) $editMode = ($options['edit-mode'] === true);

$array = $fiche->getCompetences();
$competences = [];
/** @var Competence $competence */
foreach ($array as $competence)  {
    $type = $competence->getType();
    if (!isset($competences[$type->getLibelle()])) $competences[$type->getLibelle()] = [];
    $competences[$type->getLibelle()][] = $competence;
}
?>

<div class="row">
    <div class="col-md-8">
        <h1 class="page-header">
            Fiche métier #<?php echo $fiche->getId(); ?> <br/>
            <em><?php echo $fiche->getMetier()->getLibelle(); ?></em>
        </h1>
    </div>
    <div class="col-md-4">
        <?php if ($editMode) : ?>
            <br/>
            <br/>
            <br/>
            <?php /** @see FicheMetierController::editerLibelleAction() */ ?>
            <a  class="btn btn-primary action ajax-modal pull-right"
                data-event="modification"
                href="<?php echo $this->url('fiche-metier-type/editer-libelle', ['id' => $fiche->getId()], [] , true); ?>">
                <span class="icon editer"></span>
                Éditer libellé
            </a>
        <?php endif; ?>
    </div>
</div>

<!-- MISSIONS PRINCIPALE ------------------------------------------------------------------------------------------>
<div class="main">
    <h2> Missions principales</h2>

    <?php echo $fiche->getMissionsPrincipales(); ?>
</div>

<!-- ACTIVITES ASSOCIEES ------------------------------------------------------------------------------------------>
<div class="main">
    <div class="row">
        <div class="col-md-5">
            <h2>
                Activités associées
                <span class="badge"> <?php echo count($activites); ?> </span>
            </h2>
        </div>
        <div class="pull-right">
            <br/>
            <?php if ($editMode) : ?>
                <?php /** @see FicheMetierController::ajouterNouvelleActiviteAction() */ ?>
                <a  class="btn btn-primary action ajax-modal pull-right"
                    href="<?php echo $this->url('fiche-metier-type/ajouter-nouvelle-activite', ['id' => $fiche->getId()], [] , true); ?>"
                    data-event="modification"
                >
                    <span class="icon ajouter"></span>
                    Ajouter une nouvelle activité
                </a>
                <?php /** @see FicheMetierController::ajouterActiviteExistanteAction() */ ?>
                <a  class="btn btn-primary action ajax-modal pull-right"
                    data-event="modification"
                    href="<?php echo $this->url('fiche-metier-type/ajouter-activite-existante', ['id' => $fiche->getId()], [] , true); ?>">
                    <span class="icon selectionner"></span>
                    Ajouter une activité existante
                </a>
            <?php endif; ?>
        </div>
    </div>

    <?php foreach ($activites as $ficheActivite): ?>
        <?php echo $this->activite($ficheActivite, ['edit-mode' => $editMode]); ?>
    <?php endforeach;?>
</div>

<!-- AUTRE INFO --------------------------------------------------------------------------------------------------->
<div class="main">
    <h2>
        Parcours de formation de base pour la prise de poste
    </h2>

    <!-- COMPETENCES -------------------------------------------------------------------------------------------------->

    <?php /** @var Application $application */ ?>
    <?php
    $dictionnaireCompetence = [];
    foreach($fiche->getCompetences() as $competence) {
        $type = $competence->getType()->getLibelle();
        $dictionnaireCompetence[$type][$competence->getLibelle()][] = 'fiche|'. $fiche->getMetier()->getLibelle();
    }
    foreach($fiche->getActivites() as $element) {
        foreach ($element->getActivite()->getCompetences() as $competence) {
            $type = $competence->getType()->getLibelle();
            $dictionnaireCompetence[$type][$competence->getLibelle()][] = 'activite|'. $element->getActivite()->getLibelle();
        }
    }
    $count = 0;
    foreach ($dictionnaireCompetence as $type => $dictionnaire) {
        $count += count($dictionnaire);
    }
    ?>

    <div class="panel panel-info">
        <div class="panel-heading">
            <div class="row">
                <div class="col-md-8">
                    <h2>
                        <span class="icon competence"></span>
                        Compétences
                        <span class="badge">
                            <?php echo $count; ?>
                        </span>
                    </h2>
                </div>
                <?php if ($editMode) : ?>
                    <div class="pull-right">
                        <?php /** @see FicheMetierController::gererCompetencesAction() */ ?>
                        <a href="<?php echo $this->url('fiche-metier-type/gerer-competences', ['fiche' => $fiche->getId()], [], true); ?>"
                           class="btn btn-primary action ajax-modal"
                           data-event="modification"
                        >
                            <span class="icon ajouter"></span>
                            Gérer les compétences
                        </a>
                    </div>
                <?php endif; ?>
            </div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <?php foreach ($dictionnaireCompetence as $type => $dictionnaire) : ?>
                        <h3>
                            <?php echo $type; ?>
                            <span class="badge"><?php echo count($dictionnaire); ?></span>
                        </h3>
                        <ul>
                            <?php ksort($dictionnaire); ?>
                            <?php foreach($dictionnaire as $competence => $source) : ?>
                                <li>
                                    <?php echo $competence; ?>
                                    <sup>
                                        <?php foreach($source as $item) : ?>
                                            <?php $split = explode('|', $item); ?>
                                            <?php if($split[0] === 'fiche') : ?>
                                                <span class="fiche-metier" title="Associée à la fiche métier [<?php echo $split[1]; ?>]">F</span>
                                            <?php endif; ?>
                                            <?php if($split[0] === 'activite') : ?>
                                                <span class="activite" title="Associée à l'activité [<?php echo $split[1]; ?>]">A</span>
                                            <?php endif; ?>
                                        <?php endforeach; ?>
                                    </sup>
                                </li>
                            <?php endforeach; ?>
                        </ul>
                    <?php endforeach; ?>
                </div>
                <div class="col-md-6 pull-right" style="border: 1px dashed gray">
                    <h5>
                        Connaissances
                        <?php if ($editMode) : ?>
                        <?php /** @see FicheMetierController::modifierConnaissancesAction() */ ?>
                        <a class="ajax-modal" data-event="modification"
                           href="<?php echo $this->url('fiche-metier-type/modifier-connaissances', ['id' => $fiche->getId()], [], true); ?>">
                            <span class="icon editer"></span></a>
                        <?php endif; ?>
                    </h5>
                    <?php echo $fiche->getConnaissances(); ?>
                    <h5>
                        Competénces opérationnelles
                        <?php if ($editMode) : ?>
                            <?php /** @see FicheMetierController::modifierOperationnelleAction() */ ?>
                        <a class="ajax-modal" data-event="modification"
                           href="<?php echo $this->url('fiche-metier-type/modifier-operationnelle', ['id' => $fiche->getId()], [], true); ?>">
                            <span class="icon editer"></span></a>
                        <?php endif; ?>
                    </h5>
                    <?php echo $fiche->getCompetencesOperationnelles(); ?>
                    <h5>
                        Competénces comportementales
                        <?php if ($editMode) : ?>
                        <?php /** @see FicheMetierController::modifierComportementaleAction() */ ?>
                        <a class="ajax-modal" data-event="modification"
                           href="<?php echo $this->url('fiche-metier-type/modifier-comportementale', ['id' => $fiche->getId()], [], true); ?>">
                            <span class="icon editer"></span></a>
                        <?php endif; ?>
                    </h5>
                    <?php echo $fiche->getCompetencesComportementales(); ?>
                </div>
            </div>
        </div>
    </div>

    <!-- APPLICATION -------------------------------------------------------------------------------------------------->

    <?php /** @var Application $application */ ?>
    <?php
    $dictionnaireApplication = [];
    foreach($fiche->getApplications() as $application) {
        $dictionnaireApplication[$application->getLibelle()][] = 'fiche|'. $fiche->getMetier()->getLibelle();
    }
    foreach($fiche->getActivites() as $element) {
        foreach ($element->getActivite()->getApplications() as $application) {
            $dictionnaireApplication[$application->getLibelle()][] = 'activite|'. $element->getActivite()->getLibelle();
        }
    }
    ?>

    <div class="panel panel-info">
        <div class="panel-heading">
            <div class="row">
                <div class="col-md-8">
                    <h2>
                        <span class="icon application"></span>
                        Applications
                        <span class="badge">
                            <?php echo count($dictionnaireApplication); ?>
                        </span>
                    </h2>
                </div>
                <?php if ($editMode) : ?>
                <div class="pull-right">
                    <?php /** @see FicheMetierController::modifierApplicationAction() */ ?>
                    <a href="<?php echo $this->url('fiche-metier-type/modifier-application', ['id' => $fiche->getId()], [], true); ?>"
                       class="btn btn-primary action ajax-modal"
                       data-event="modification"
                    >
                        <span class="icon ajouter"></span>
                        Gérer les applications
                    </a>
                </div>
                <?php endif; ?>
            </div>
        </div>
        <div class="panel-body">
            <ul>
                <?php ksort($dictionnaireApplication); ?>
                <?php foreach($dictionnaireApplication as $application => $source) : ?>
                    <li>
                        <?php echo $application; ?>
                        <sup>
                            <?php foreach($source as $item) : ?>
                                <?php $split = explode('|', $item); ?>
                                <?php if($split[0] === 'fiche') : ?>
                                    <span class="fiche-metier" title="Associée à la fiche métier [<?php echo $split[1]; ?>]">F</span>
                                <?php endif; ?>
                                <?php if($split[0] === 'activite') : ?>
                                    <span class="activite" title="Associée à l'activité [<?php echo $split[1]; ?>]">A</span>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </sup>
                    </li>
                <?php endforeach; ?>
            </ul>
        </div>
    </div>

    <!-- FORMATION ---------------------------------------------------------------------------------------------------->

    <?php /** @var Formation $formation */ ?>
    <?php
    $dictionnaireFormation = [];
    foreach($fiche->getFormations() as $formation) {
        $dictionnaireFormation[$formation->getLibelle()][] = 'fiche|'. $fiche->getMetier()->getLibelle();
    }
    foreach($fiche->getActivites() as $element) {
        foreach ($element->getActivite()->getFormations() as $formation) {
            $dictionnaireFormation[$formation->getLibelle()][] = 'activite|'. $element->getActivite()->getLibelle();
        }
    }
    ?>

    <div class="panel panel-info">
        <div class="panel-heading">
            <div class="row">
                <div class="col-md-8">
                    <h2>
                        <span class="icon formation"></span>
                        Formations
                        <span class="badge">
                            <?php echo count($dictionnaireFormation); ?>
                        </span>
                    </h2>
                </div>
                <?php if ($editMode) : ?>
                <div class="pull-right">
                    <?php /** @see FicheMetierController::modifierFormationAction() */ ?>
                    <a href="<?php echo $this->url('fiche-metier-type/modifier-formation', ['id' => $fiche->getId()], [], true); ?>"
                       class="btn btn-primary action ajax-modal"
                       data-event="modification"
                    >
                        <span class="icon ajouter"></span>
                        Gérer les formations
                    </a>
                </div>
                <?php endif; ?>
            </div>
        </div>
        <div class="panel-body">
            <ul>
                <?php ksort($dictionnaireFormation); ?>
                <?php foreach($dictionnaireFormation as $formation => $source) : ?>
                    <li>
                        <?php echo $formation; ?>
                        <sup>
                            <?php foreach($source as $item) : ?>
                                <?php $split = explode('|', $item); ?>
                                <?php if($split[0] === 'fiche') : ?>
                                    <span class="fiche-metier" title="Associée à la fiche métier [<?php echo $split[1]; ?>]">F</span>
                                <?php endif; ?>
                                <?php if($split[0] === 'activite') : ?>
                                    <span class="activite" title="Associée à l'activité [<?php echo $split[1]; ?>]">A</span>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </sup>
                    </li>
                <?php endforeach; ?>
            </ul>
        </div>
    </div>
</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });

</script>

<style>
    h2 {
        color: #3c6c8b;
        text-decoration: none;
        margin-bottom: 2rem;
    }

    span.fiche-metier {
        font-weight: bolder;
        color: blue;
        font-family: monospace;
        cursor: help;
    }

    span.activite {
        font-weight: bolder;
        color: orangered;
        font-family: monospace;
        cursor: help;
    }

</style>