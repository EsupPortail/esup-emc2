<?php

use Application\Controller\FicheMetierController;
use Application\Entity\Db\FicheMetier;
use Application\Entity\Db\FicheMetierTypeActivite;
use Application\Entity\Db\FichePoste;
use Application\Entity\Db\FicheposteActiviteDescriptionRetiree;
use Application\Entity\Db\FicheTypeExterne;

/**
 * @see \Application\View\Helper\FicheMetierViewHelper
 * @var FicheMetier $fichemetier
 * @var FichePoste $ficheposte
 * @var FicheTypeExterne $ficheexterne
 * @var array $options
 */

$metier = $fichemetier->getMetier();
$agent = ($ficheposte)?$ficheposte->getAgent():null;

/**
 * @var FicheMetierTypeActivite[] $activites
 */
$activites = $fichemetier->getActivites();

$activitesListe = [];
if (isset($options['activite-liste'])) {
    $activitesListe = explode(';', $options['activite-liste']);
} else {
    foreach ($activites as $activite) $activitesListe[] = $activite->getActivite()->getId();
}

$sansTitre = (isset($options['sans-titre']) AND $options['sans-titre']);
$mode = $options['mode'];
?>

<?php /** Watermark de l'identifiant de la fiche qui peut être utilisée pour des redirections **********************/ ?>
<span style="visibility:hidden;">
    Fiche métier #<?php echo $fichemetier->getId(); ?>
</span>

<?php /** DEBUG *****************************************************************************************************/?>

<?php
    $DEBUG = false;
    if ($DEBUG) :
?>

<div class="alert alert-warning">
    <h3> Debug de l'aide de vue FicheMetierViewHelper </h3>

    <dl class="dl-horizontal">
        <dt> FicheMetier.Id</dt>
        <dd> <?php echo $fichemetier->getId(); ?> </dd>
        <dt>Mode</dt>
        <dd><?php echo $mode; ?></dd>
        <dt>Titre</dt>
        <dd><?php echo ($options['sans-titre'])?"Sans":"Avec"; ?></dd>
    </dl>
</div>

<?php endif; ?>

<?php /** FICHE || ENTETE *******************************************************************************************/?>

<?php if ($sansTitre !== true) : ?>
    <div class="row">
        <div class="col-md-8">
            <h1 class="page-header">
                <strong> <?php echo $metier->getLibelle(); ?> </strong>
            </h1>

            <?php if ($mode === 'edition-fiche-metier') : ?>
                <?php if ($fichemetier->hasExpertise()) : ?>
                    <span class="label" style="background-color: darkgreen;"> Sujet à expertise </span>
                <?php else: ?>
                    <span class="label" style="background-color: darkred;"> Non sujet à expertise </span>
                <?php endif; ?>
            <?php endif; ?>

            <?php if ($metier) : ?>
                <?php foreach($metier->getReferences() as $reference) : ?>
                    <span class="label" style="background-color: #dfc4b2; margin-left: 1rem;"><a href="<?php echo $reference->getUrl(); ?>"> <?php echo $reference->getTitre(); ?> </a></span>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>
        <div class="col-md-4">
            <div class="pull-right" style="margin-right:1rem;">
                <?php if (isset($options['mode']) AND $options['mode'] === 'edition-fiche-metier') : ?>
                    <br/>
                    <?php /** @see FicheMetierController::editerLibelleAction() */ ?>
                    <a  class="btn btn-primary action ajax-modal pull-right"
                        data-event="modification"
                        href="<?php echo $this->url('fiche-metier-type/editer-libelle', ['id' => $fichemetier->getId()], [] , true); ?>">
                        <span class="icon editer"></span>
                        Modifier libellé
                    </a>
                <?php endif; ?>
                <?php if (isset($options['mode']) AND $options['mode'] === 'edition-fiche-metier') : ?>
                    <a
                        <?php /** @see FicheMetierController::changerExpertiseAction() */?>
                            href="<?php echo $this->url('fiche-metier-type/changer-expertise', ['fiche' => $fichemetier->getId()], [], true); ?>"
                            class="btn btn-primary action pull-right"
                    >
                        <?php if ($fichemetier->hasExpertise()) : ?>
                            <span class="icon retirer"></span>
                            Retirer expertise
                        <?php else: ?>
                            <span class="icon ajouter"></span>
                            Ajouter expertise
                        <?php endif; ?>
                    </a>
                <?php endif; ?>
            </div>
        </div>
    </div>
<?php endif; ?>

<?php /** FICHE || ACTIVITES / MISSIONS PRINCIPALES *****************************************************************/?>

<?php
    $activitesRestantes = $activites;
    if ($ficheposte !== null) {
        $activitesRestantes = [];
        foreach ($activites as $activite) {
            if (array_search($activite->getActivite()->getId(), $activitesListe) !== false) {
                $activitesRestantes[] = $activite;
            }
        }
    }
?>
<div class="main">
    <?php if ($ficheposte === null) : ?>
    <br/>
    <div class="panel panel-info">
        <div class="panel-heading">
            <div class="row">
                <div class="col-md-8">
                    Missions principales
                    <span class="badge"> <?php echo count($activitesRestantes); ?>/<?php echo count($activites); ?> </span>
                </div>
                <div class="col-md-4">
                    <?php if (isset($options['mode']) AND $options['mode'] === 'edition-fiche-metier') : ?>
                        <?php /** @see FicheMetierController::ajouterNouvelleActiviteAction() */ ?>
                        <a  class="btn btn-primary action ajax-modal pull-right"
                            href="<?php echo $this->url('fiche-metier-type/ajouter-nouvelle-activite', ['id' => $fichemetier->getId()], [] , true); ?>"
                            data-event="modification"
                        >
                            <span class="icon ajouter"></span>
                            Ajouter une nouvelle activité
                        </a>
                    <br/>
                        <?php /** @see FicheMetierController::ajouterActiviteExistanteAction() */ ?>
                        <a  class="btn btn-primary action ajax-modal pull-right"
                            data-event="modification"
                            href="<?php echo $this->url('fiche-metier-type/ajouter-activite-existante', ['id' => $fichemetier->getId()], [] , true); ?>">
                            <span class="icon selectionner"></span>
                            Ajouter une activité existante
                        </a>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <div class="panel-body">
        <?php else : ?>
            <div>
                <div class="row">
                    <div class="col-md-8">
                        <h2>
                        Missions principales
                        <span class="badge"> <?php echo count($activitesRestantes); ?>/<?php echo count($activites); ?> </span>
                        </h2>
                    </div>
                    <div class="pull-right">
                        <?php if (isset($options['mode']) AND $options['mode'] === 'edition-fiche-poste') : ?>
                            <br/>
                            <a
                                <?php /** @see \Application\Controller\FichePosteController::selectionnerActiviteAction() */ ?>
                                    href="<?php echo $this->url('fiche-poste/selectionner-activite', ['fiche-poste' => $ficheposte->getId(), 'fiche-type-externe' => $ficheexterne->getId()], [], true); ?>"
                                    class="ajax-modal" data-event="modification"
                            >
                                <span class="icon listing" title="Sélectionner les activités associées"></span></a>
                        <?php endif; ?>
                    </div>
                </div>
                <div>
        <?php endif; ?>
            <?php foreach ($activitesRestantes as $ficheActivite): ?>
                <?php
                    $retirees = [];
                    if ($ficheposte) $retirees = FicheposteActiviteDescriptionRetiree::filtrer($ficheActivite->getActivite(), $ficheposte->getDescriptionsRetirees()->toArray());
                ?>
                <?php echo $this->activite($ficheActivite, $options['mode'], ['ficheposte' => $ficheposte, 'fichemetier' => $fichemetier, 'retirees' => $retirees]); ?>
            <?php endforeach;?>
        </div>
    </div>
</div>

<!-- AUTRE INFO --------------------------------------------------------------------------------------------------->

<?php if ($ficheposte === null) : ?>
    <div class="main">

    <!-- COMPETENCES -------------------------------------------------------------------------------------------------->

        <?php if (! isset($options['competences'])) : ?>
            <div class="alert alert-danger">
                Le dictionnaire des compétences n'est pas fourni.
            </div>
        <?php else : ?>
            <?php $dictionnaireCompetence = $options['competences']; ?>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-md-8">
                            <h2>
                                <span class="icon competence"></span>
                                Compétences
                                <span class="badge">
                                    <?php echo count($dictionnaireCompetence); ?>
                                </span>
                            </h2>
                         </div>
                        <div class="col-md-3" style="margin-right:1rem;">
                        <?php if (isset($options['mode']) AND $options['mode'] === 'edition-fiche-metier') : ?>
                                <?php /** @see \Application\Controller\CompetenceController::afficherCompetenceElementAction() */ ?>
                                <a href="<?php echo $this->url('competence/ajouter-competence-element', ['type' => FicheMetier::class, 'id' => $fichemetier->getId()], [], true); ?>"
                                   class="btn btn-primary action ajax-modal"
                                   data-event="modification"
                                >
                                    <span class="icon ajouter"></span>
                                    Ajouter une compétence
                                </a>
                        <?php endif; ?>
                            <?php /** @see FicheMetierController::graphiqueCompetencesAction() */ ?>
                            <a href="<?php echo $this->url('fiche-metier-type/graphique-competences', ['fiche-metier' => $fichemetier->getId(), 'agent' => ($agent)?$agent->getId():null], [], true); ?>"
                               class="btn btn-primary action ajax-modal"
                            >
                                <span class="icon graphique"></span>
                                Afficher les compétences
                            </a>
                        </div>
                </div>
            </div>
            <div class="panel-body">
                <div class="col-md-1"></div>
                <div class="col-md-10"><?php echo $this->competenceBloc($dictionnaireCompetence, $fichemetier, ['display' => ['titre' => false, 'validation' => false], 'actions' => ['valider' => false]]); ?></div>
            </div>
        </div>
        <?php endif; ?>

        <!-- APPLICATION -------------------------------------------------------------------------------------------------->

        <?php if (! isset($options['applications'])) : ?>
            <div class="alert alert-danger">
                Le dictionnaire des applications n'est pas fourni.
            </div>
        <?php else : ?>
            <?php $dictionnaireApplication = $options['applications']; ?>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-md-8">
                            <h2>
                                <span class="icon application"></span>
                                Applications
                                <span class="badge">
                                    <?php echo count($dictionnaireApplication); ?>
                                </span>
                            </h2>
                        </div>
                        <div class="col-md-3" style="margin-right:1rem;">
                            <?php if (isset($options['mode']) AND $options['mode'] === 'edition-fiche-metier'): ?>
                            <?php /** @see \Application\Controller\ApplicationController::ajouterApplicationElementAction() */ ?>
                            <a href="<?php echo $this->url('application/ajouter-application-element', ['type' => FicheMetier::class, 'id' => $fichemetier->getId()], [], true); ?>"
                               class="btn btn-primary action ajax-modal"
                               data-event="modification"
                            >
                                <span class="icon ajouter"></span>
                                Ajouter une application
                            </a>
                            <?php endif; ?>
                            <?php /** @see FicheMetierController::graphiqueApplicationsAction() */ ?>
                            <a href="<?php echo $this->url('fiche-metier-type/graphique-applications', ['fiche-metier' => $fichemetier->getId(), 'agent' => ($agent)?$agent->getId():null], [], true); ?>"
                               class="btn btn-primary action ajax-modal"
                            >
                                <span class="icon graphique"></span>
                                Afficher les applications
                            </a>
                        </div>

                    </div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-10"><?php echo $this->applicationBloc($dictionnaireApplication,$fichemetier, ['display' => ['titre' => false, 'validation' => false], 'actions' => ['valider' => false]]); ?></div>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <!-- FORMATION ---------------------------------------------------------------------------------------------------->

        <?php if (! isset($options['parcours'])) : ?>
            <div class="alert alert-danger">
                Le parcours de formation n'est pas fourni.
            </div>
        <?php else : ?>
            <div class="panel panel-info">
            <div class="panel-heading">
                    <span class="icon formation"></span>
                    Parcours de formation
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
            <?php
                $arrays = $options['parcours'];
                ksort($arrays);
                foreach ( $arrays as $type => $array) : ?>
                <?php $parcours = $array; ?>
                    <?php foreach ($parcours as $parcour) : ?>
                        <?php echo $this->parcoursDeFormation($parcour); ?>
                    <?php endforeach; ?>
                <?php endforeach; ?>

                    <?php echo $this->parcoursApplication($fichemetier); ?>
                    </div>
                </div>

            </div>
            </div>
        <?php endif; ?>
    </div>
<?php else : ?>
        <?php /** @see FicheMetierController::graphiqueCompetencesAction() */ ?>
        <a href="<?php echo $this->url('fiche-metier-type/graphique-competences', ['fiche-metier' => $fichemetier->getId(), 'agent' => ($agent)?$agent->getId():null], [], true); ?>"
           class="btn btn-primary action ajax-modal"
        >
            <span class="icon graphique"></span>
            Afficher les compétences
        </a>

        <?php /** @see FicheMetierController::graphiqueApplicationsAction() */ ?>
        <a href="<?php echo $this->url('fiche-metier-type/graphique-applications', ['fiche-metier' => $fichemetier->getId(), 'agent' => ($agent)?$agent->getId():null], [], true); ?>"
           class="btn btn-primary action ajax-modal"
        >
            <span class="icon graphique"></span>
            Afficher les applications
        </a>
<?php endif; ?>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>

<style>
    h2 {
        color: #3c6c8b;
        text-decoration: none;
        margin-bottom: 2rem;
    }
</style>