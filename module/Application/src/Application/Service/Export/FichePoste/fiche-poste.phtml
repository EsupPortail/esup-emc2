<?php

/**
 * @var FichePoste $fiche
 */

use Application\Entity\Db\Agent;
use Application\Entity\Db\FichePoste;
use Application\Entity\Db\FicheTypeExterne;
use Application\Entity\Db\Poste;

$canAssocierAgent = true;
$canAssocierMetierType = true;

/**
 * @var Agent $agent
 * @var Poste $poste
 */
$metier = null;
if ($fiche->getFicheTypeExternePrincipale()) $metier = $fiche->getFicheTypeExternePrincipale()->getFicheType()->getMetier();
$poste = ($fiche->getPoste())?:null;
$agent = ($fiche->getAgent())?:null;

$now = new DateTime();


?>

<div class="titre-block">
    <div class="titre-intitule">
        <?php if ($metier): ?>
                <?php echo $metier->getLibelle(); ?>
        <?php else: ?>
            Aucun métier principal de renseigné
        <?php endif; ?>
        <?php if ($fiche->getLibelle()) : ?>
            (<?php echo $fiche->getLibelle(); ?>)
        <?php endif; ?>
    </div>
    <div class="titre-affectation">
        <?php if ($poste): ?>
            <?php echo $poste->getStructure()->getLibelleLong(); ?>
        <?php else : ?>
            Aucune structure est associée au poste
        <?php endif; ?>
    </div>
</div>

<!-- AGENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<div class="agent-block">
    <div class="titre-banner">
        Agent occupant le poste
    </div>

    <?php if($agent === null) : ?>
        Aucun agent n'est associé à cette fiche de poste.
    <?php else: ?>
        <table class="info">
            <tr>
                <th> Dénomination </th>
                <td> <?php echo $agent->getDenomination(); ?> </td>
            </tr>
            <tr>
                <th> Statuts </th>
                <?php
                $statuts = [];
                foreach ($agent->getStatuts() as $statut) {
                    if ($statut->getDebut() <= $now AND ($statut->getFin() === null OR $statut->getFin() > $now)) $statuts[] = $statut;
                }
                ?>
                <td>
                    <ul>
                        <?php foreach ($statuts as $statut) : ?>
                            <li>
                                <?php echo $statut->getStructure()->getLibelleLong(); ?>
                                (Du <?php echo $statut->getDebut()->format('d/m/Y'); ?>
                                au
                                <?php if ($statut->getFin()): ?>
                                    <?php echo $statut->getFin()->format('d/m/Y'); ?>)
                                <?php else : ?>
                                    ---)
                                <?php endif; ?>

                                <ul>
                                    <?php if ($statut->isTitulaire()): ?>
                                        <li> Titulaire </li>
                                    <?php endif; ?>
                                    <?php if ($statut->isCdd()): ?>
                                        <li> C.D.D. </li>
                                    <?php endif; ?>
                                    <?php if ($statut->isCdi()): ?>
                                        <li> C.D.I. </li>
                                    <?php endif; ?>
                                    <?php if ($statut->isAdministratif()): ?>
                                        <li> Administratif </li>
                                    <?php endif; ?>
                                </ul>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                </td>
            </tr>
            <tr>
                <th> Grades </th>
                <?php
                $grades = [];
                foreach ($agent->getGrades() as $grade) {
                    if ($grade->getDateDebut() <= $now AND ($grade->getDateFin() === null OR $grade->getDateFin() > $now)) $grades[] = $grade;
                }
                ?>
                <td>
                    <ul>
                        <?php foreach ($grades as $grade): ?>
                        <li>
                            <?php echo $grade->getStructure()->getLibelleLong(); ?>
                            (Du <?php echo $grade->getDateDebut()->format('d/m/Y'); ?>
                            au
                            <?php if ($grade->getDateFin()): ?>
                                <?php echo $grade->getDateFin()->format('d/m/Y'); ?>)
                            <?php else : ?>
                                ---)
                            <?php endif; ?>
                            <ul>
                                <li> <?php echo strtolower($grade->getCorps()->getLibelleLong()); ?> </li>
                                <li> <?php echo strtolower($grade->getGrade()->getLibelleLong()); ?> </li>
                                <li>
                                    BAP
                                    <?php echo $grade->getBap()->getCategorie(); ?>
                                    -
                                    <?php echo strtolower($grade->getBap()->getLibelleLong()); ?>
                                </li>
                            </ul>
                        </li>
                        <?php endforeach; ?>
                    </ul>
                </td>
            </tr>
            <tr>
                <th> Quotité travaillée </th>
                <td>
                    <span class="manquant"> Information remontant de SIHAM ou renseignable dans l'application </span>
                </td>
            </tr>
        </table>
    <?php endif; ?>
</div>

<br/>

<!-- ENVIRONNEMENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<div class="environnement-block">
    <div class="titre-banner">
        Environnement du poste de travail dans l'organisation
    </div>

    <?php if ($fiche->getPoste() !== null && $fiche->getPoste()->getStructure() !== null) : ?>
        <?php if ($fiche->getPoste()->getStructure()->getDescription() !== null) :?>
            <?php echo $fiche->getPoste()->getStructure()->getDescription(); ?>
        <?php else: ?>
            Aucune description de fournie pour l'affectation
        <?php endif; ?>
    <?php else: ?>
        Aucune affectation de renseignée.
    <?php endif; ?>

    <?php if ($poste === null): ?>
        Aucun poste de renseigné
    <?php else : ?>
        <table class="info">
            <tr>
                <th> Numéro de poste </th>
                <td> <?php echo $poste->getId(); ?> </td>
            </tr>
            <tr>
                <th> Affectation  </th>
                <td> <?php echo $poste->getStructure()->getLibelleLong(); ?> </td>
            </tr>
            <tr>
                <th> Rattachement hiérarchique  </th>
                <td> <?php echo $poste->getRattachementHierarchique()->getDenomination(); ?> </td>
            </tr>
            <tr>
                <th> Correspondance  </th>
                <td> BAP <?php echo $poste->getCorrespondance()->getCategorie(); ?> - <?php echo strtolower($poste->getCorrespondance()->getLibelleLong()); ?></td>
            </tr>
            <tr>
                <th> Domaine UniCaen  </th>
                <td> <?php echo $poste->getDomaine()->getLibelle(); ?> </td>
            </tr>
            <tr>
                <th> Fonction  </th>
                <td> <?php echo $poste->getFonction(); ?> </td>
            </tr>
        </table>
    <?php endif; ?>
</div>

<br/>

<!-- ENVIRONNEMENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<?php
$principal = $fiche->getFicheTypeExternePrincipale();

$fichesMetiers = $fiche->getFichesMetiers();
$fichesMetiers = array_filter($fichesMetiers, function (FicheTypeExterne $a) { return !$a->getPrincipale(); });
usort($fichesMetiers, function (FicheTypeExterne $a, FicheTypeExterne $b) { return ($a->getQuotite() > $b->getQuotite()); });
?>

<div class="environnement-block">
    <div class="titre-banner">
        Description des fiches métiers
    </div>

    <div>
    La fiche de poste est composée de <?php echo count($fiche->getFichesMetiers()); ?> fiche(s) type(s).
    <ul>
        <?php if ($principal) : ?>
            <li> <strong> <?php echo $principal->getFicheType()->getMetier() ?> à <?php echo $principal->getQuotite(); ?>%</strong></li>
        <?php endif; ?>
        <?php /** @var FicheTypeExterne $ficheType **/ ?>
        <?php foreach ($fichesMetiers as $ficheType) : ?>
            <li> <?php echo $ficheType->getFicheType()->getMetier(); ?> à <?php echo $ficheType->getQuotite(); ?>% </li>
        <?php endforeach; ?>
    </ul>
    </div>

    <?php
        /** @var FicheTypeExterne[] $fiches */
        $fiches = [];
        if ($principal) $fiches[] = $principal;
        foreach ($fichesMetiers as $ficheType) $fiches[] = $ficheType;
    ?>

    <?php foreach ($fiches as $ficheMetier) : ?>
        <div class="fiche-banner">
            <?php echo  $ficheMetier->getFicheType()->getMetier()->getLibelle(); ?>
        </div>

        <h3>Missions principales :</h3>
        <?php $activites = explode(";",$ficheMetier->getActivites()); ?>
        <ul>
            <?php foreach ($ficheMetier->getFicheType()->getActivites() as $activite) : ?>
                <?php if (array_search($activite->getActivite()->getId(), $activites) !== false) : ?>
                    <li> <?php echo $activite->getActivite()->getLibelle(); ?> </li>
                <?php endif; ?>
            <?php endforeach; ?>
        </ul>

        <h3> Description des missions : </h3>
        <dl>
        <?php foreach ($ficheMetier->getFicheType()->getActivites() as $activite) : ?>
            <?php if (array_search($activite->getActivite()->getId(), $activites) !== false) : ?>
                <dt> <?php echo $activite->getActivite()->getLibelle(); ?> </dt>
                <dd> <?php echo $activite->getActivite()->getDescription(); ?> </dd>
            <?php endif; ?>
        <?php endforeach; ?>
        </dl>

        <h3> Parcours de formation pour la prise de poste : </h3>

        <?php
        $competences = $ficheMetier->getFicheType()->getCompetences()->toArray();
        $connaissances = []; $operationnelles = []; $comportementalles = [];
        /** @var \Application\Entity\Db\Competence $competence */
        foreach ($competences as $competence) {
            switch ($competence->getType()->getLibelle()) {
                case 'Connaissance':
                    $connaissances[] = $competence;
                    break;
                case 'Opérationnelle':
                    $operationnelles[] = $competence; break;
                case 'Comportementale':
                    $comportementalles[] = $competence; break;
            }
        }
        ?>

        <dl>
            <?php if (!empty($connaissances)) : ?>
            <dt> Connaissances  </dt>
            <dd>
                <ul>
                    <?php
                    /** @var \Application\Entity\Db\Competence $competence */
                    foreach ($connaissances as $competence) :
                        ?>
                        <li> <?php echo $competence->getLibelle(); ?> </li>
                    <?php endforeach; ?>
                </ul>
            </dd>
            <?php endif; ?>
            <?php if (!empty($operationnelles)) : ?>
            <dt> Compétences opérationnelles   </dt>
            <dd>
                <ul>
                    <?php
                    /** @var \Application\Entity\Db\Competence $competence */
                    foreach ($operationnelles as $competence) :
                        ?>
                        <li> <?php echo $competence->getLibelle(); ?> </li>
                    <?php endforeach; ?>
                </ul>
            </dd>
            <?php endif; ?>
            <?php if (!empty($comportementalles)) : ?>
            <dt> Compétences comportementales  </dt>
            <dd>
                <ul>
                    <?php
                    /** @var \Application\Entity\Db\Competence $competence */
                    foreach ($comportementalles as $competence) :
                        ?>
                        <li> <?php echo $competence->getLibelle(); ?> </li>
                    <?php endforeach; ?>
                </ul>
            </dd>
            <?php endif; ?>
            <?php if (!empty($ficheMetier->getFicheType()->getApplications()->toArray())) : ?>
                <dt> Applications  </dt>
                <dd>
                    <ul>
                    <?php
                        /** @var \Application\Entity\Db\Application $application */
                    foreach ($ficheMetier->getFicheType()->getApplications() as $application) :
                    ?>
                        <li> <?php echo $application->getLibelle(); ?> </li>
                    <?php endforeach; ?>
                    </ul>
                </dd>
            <?php endif; ?>
            <?php if (!empty($ficheMetier->getFicheType()->getFormations())) : ?>
                <dt> Formations  </dt>
                <dd>
                    <ul>
                        <?php
                        /** @var \Application\Entity\Db\Formation $formation */
                        foreach ($ficheMetier->getFicheType()->getFormations() as $formation) :
                            ?>
                            <li> <?php echo $formation->getLibelle(); ?> </li>
                        <?php endforeach; ?>
                    </ul>
                </dd>
            <?php endif; ?>
        </dl>
    <?php endforeach; ?>

<br/>

<!-- SPECIFICITE DU POSTE --------------------------------------------------------------------------------------------->
<div class="">
    <div class="titre-banner">
        Spécificité du poste
    </div>

    <?php if ($fiche->getSpecificite() === null) : ?>
        Aucune spécificité attachée à ce poste.
    <?php else: ?>
        <?php echo $this->specificitePoste($fiche->getSpecificite()); ?>
    <?php endif; ?>
</div>


<style>
    body {
        font-size: 10pt;
        font-family: Calibri, "Times", monospace;
    }
    div.titre-block{
        width:100%;
        font-family: Arial, monospace;
        color:white;
        font-size: 16pt;
        margin-bottom: 1.5rem;
    }
    div.titre-intitule {
        padding: 1rem;
        background-color: #44a17f;
    }
    div.titre-affectation {
        background-color: #1993a1;
        padding: 0.5rem;
    }

    div.titre-banner {
        background-color: #c6fff8
        margin-top:0.5rem;
        margin-bottom:0.5rem;
        border-top: dashed 1px grey;
        border-bottom: dashed 1px grey;
        font-size: 15pt;
    }

    div.fiche-banner {
        background-color: #c6ffcc
        margin-top:0.5rem;
        margin-bottom:0.5rem;
        border-top: dotted 1px grey;
        border-bottom: dotted 1px grey;
        font-size: 12pt;
    }

    table.info {
        border: solid 1px black ;
        width:100%;
        border-collapse: collapse;
    }

    table.info th {
        width: 30%;
        text-align: left;
        border: solid 1px black ;
    }

    table.info td {
        text-align: left;
        border: solid 1px black ;
    }

    span.manquant {
        background-color: #e798bc;
        color:darkred;
    }

    dl {
        margin-left: 10%;
    }
    dl dt {
        font-weight: bold;
    }
</style>