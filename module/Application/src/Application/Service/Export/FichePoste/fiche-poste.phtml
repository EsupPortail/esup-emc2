<?php

/**
 * TODO tenir compte des "choses" (Compétences, Applications, Formation) provenant des activités
 * @var FichePoste $fiche
 * @var array $applications
 * @var array $competences
 * @var array $formations
 */

use Application\Entity\Db\ActiviteDescription;
use Application\Entity\Db\Agent;
use Application\Entity\Db\CompetenceType;
use Application\Entity\Db\Expertise;
use Application\Entity\Db\FichePoste;
use Application\Entity\Db\FicheposteActiviteDescriptionRetiree;
use Application\Entity\Db\FicheTypeExterne;
use Application\Entity\Db\Poste;
use Application\Entity\Db\Structure;

$canAssocierAgent = true;
$canAssocierMetierType = true;

/**
 * @var Agent $agent
 * @var Poste $poste
 */
$metier = null;
if ($fiche->getFicheTypeExternePrincipale()) $metier = $fiche->getFicheTypeExternePrincipale()->getFicheType()->getMetier();
$poste = ($fiche->getPoste())?:null;
$agent = ($fiche->getAgent())?:null;

$now = new DateTime();

$libelleSupplemantaire = $fiche->getLibelle();
$metierLibelle = ($metier)?$metier->getLibelle():null;

?>

<div class="titre-block">
    <div class="titre-intitule">
        <?php if ($libelleSupplemantaire) : ?>
            <strong><?php echo $libelleSupplemantaire; ?> <br/></strong>
            Rattachée à
        <?php endif; ?>
        <?php if ($metier): ?>
                <strong><?php echo $metier->getLibelle(); ?></strong>
        <?php else: ?>
            Aucun métier principal de renseigné
        <?php endif; ?>
    </div>
    <div class="titre-affectation">
        <?php if ($poste): ?>
            <?php echo $poste->getStructure()->getLibelleLong(); ?>
        <?php else : ?>
            Aucune structure est associée au poste
        <?php endif; ?>
    </div>
</div>

<!-- AGENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<div class="agent-block">
    <div class="titre-banner">
        Agent occupant le poste
    </div>

    <?php if($agent === null) : ?>
        Aucun agent n'est associé à cette fiche de poste.
    <?php else: ?>
        <table class="info">
            <tr>
                <th> Dénomination </th>
                <td> <?php echo $agent->getDenomination(); ?> </td>
            </tr>
            <tr>
                <th> Statuts </th>
                <?php
                $statuts = [];
                foreach ($agent->getStatuts() as $statut) {
                    if ($statut->getDebut() <= $now AND ($statut->getFin() === null OR $statut->getFin() > $now)) $statuts[] = $statut;
                }
                ?>
                <td>
                    <ul>
                        <?php foreach ($statuts as $statut) : ?>
                            <li>
                                <?php echo $statut->getStructure()->getLibelleLong(); ?>
                                (Du <?php echo $statut->getDebut()->format('d/m/Y'); ?>
                                au
                                <?php if ($statut->getFin()): ?>
                                    <?php echo $statut->getFin()->format('d/m/Y'); ?>)
                                <?php else : ?>
                                    ---)
                                <?php endif; ?>

                                <ul>
                                    <?php if ($statut->isTitulaire()): ?>
                                        <li> Titulaire </li>
                                    <?php endif; ?>
                                    <?php if ($statut->isCdd()): ?>
                                        <li> C.D.D. </li>
                                    <?php endif; ?>
                                    <?php if ($statut->isCdi()): ?>
                                        <li> C.D.I. </li>
                                    <?php endif; ?>
                                    <?php if ($statut->isAdministratif()): ?>
                                        <li> Administratif </li>
                                    <?php endif; ?>
                                </ul>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                </td>
            </tr>
            <tr>
                <th> Grades </th>
                <?php $grades = $agent->getGradesActifs(); ?>
                <td>
                    <ul>
                        <?php foreach ($grades as $grade): ?>
                            <?php
                                $structure = $grade->getStructure();
                                $corps = $grade->getCorps();
                                $tgrade = $grade->getGrade();
                                $bap = $grade->getBap();
                            ?>
                        <li>
                            <?php echo ($structure)?$structure->getLibelleLong():"<span class='manquant'>Non renseignée</span>"; ?>
                            (Du <?php echo $grade->getDateDebut()->format('d/m/Y'); ?>
                            au
                            <?php if ($grade->getDateFin()): ?>
                                <?php echo $grade->getDateFin()->format('d/m/Y'); ?>)
                            <?php else : ?>
                                ---)
                            <?php endif; ?>
                            <ul>
                                <li> <?php echo ($corps)?strtolower($grade->getCorps()->getLibelleLong()):"<span class='manquant'>Non renseigné</span>"; ?> </li>
                                <li> <?php echo strtolower($grade->getGrade()->getLibelleLong()); ?> </li>
                                <li>
                                    <?php if ($bap) : ?>
                                        BAP
                                        <?php echo $bap->getCategorie(); ?>
                                        -
                                        <?php echo strtolower($bap->getLibelleLong()); ?>
                                    <?php else : ?>
                                        <span class='manquant'>
                                            Non renseignée
                                        </span>
                                    <?php endif; ?>
                                </li>
                            </ul>
                        </li>
                        <?php endforeach; ?>
                    </ul>
                </td>
            </tr>
            <tr>
                <th> Quotité travaillée </th>
                <td>
                    <span class="manquant"> Information remontant de SIHAM ou renseignable dans l'application </span>
                </td>
            </tr>
        </table>
    <?php endif; ?>
</div>

<br/>

<!-- ENVIRONNEMENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<div class="environnement-block">
    <div class="titre-banner">
        Environnement du poste de travail dans l'organisation
    </div>

    <?php
        /** @var Structure[] $structures */
        $structures = [];
        foreach ($grades as $agentGrade) {
            $structure = $agentGrade->getStructure();
            if ($structure !== null) $structures[] = $structure;
        }
    ?>

    Structures dans lesquelles l'agent est affecté :
    <ul>
        <?php foreach ($structures as $structure) : ?>
            <li><?php echo $structure->getLibelleLong(); ?></li>
        <?php endforeach; ?>
    </ul>

    <?php foreach ($structures as $structure) : ?>
    <div class="fiche-banner">
        <?php echo $structure->getLibelleLong(); ?>
    </div>

        <?php if ($structure->getDescription() !== null) :?>
            <?php echo $structure->getDescription(); ?>
        <?php else: ?>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Aucune description de fournie pour l'affectation <em><?php echo $structure->getLibelleCourt(); ?></em>.
            </div>
        <?php endif; ?>
    <?php endforeach; ?>


<!--    --><?php //if ($poste === null): ?>
<!--        Aucun poste de renseigné-->
<!--    --><?php //else : ?>
<!--        <table class="info">-->
<!--            <tr>-->
<!--                <th> Numéro de poste </th>-->
<!--                <td> --><?php //echo $poste->getNumeroPoste(); ?><!-- </td>-->
<!--            </tr>-->
<!--            <tr>-->
<!--                <th> Affectation  </th>-->
<!--                <td> --><?php //echo $poste->getStructure()->getLibelleLong(); ?><!-- </td>-->
<!--            </tr>-->
<!--            <tr>-->
<!--                <th> Rattachement hiérarchique  </th>-->
<!--                <td> --><?php //echo $poste->getRattachementHierarchique()->getDenomination(); ?><!-- </td>-->
<!--            </tr>-->
<!--            <tr>-->
<!--                <th> Correspondance </th>-->
<!--                <td> BAP --><?php //echo $poste->getCorrespondance()->getCategorie(); ?><!-- - --><?php //echo strtolower($poste->getCorrespondance()->getLibelleLong()); ?><!--</td>-->
<!--            </tr>-->
<!--            <tr>-->
<!--                <th> Domaine professionnel </th>-->
<!--                <td> --><?php //echo $poste->getDomaine()->getLibelle(); ?><!-- </td>-->
<!--            </tr>-->
<!--            <tr>-->
<!--                <th> Fonction </th>-->
<!--                <td> --><?php //echo $poste->getFonction(); ?><!-- </td>-->
<!--            </tr>-->
<!--        </table>-->
<!--    --><?php //endif; ?>
</div>

<br/>

<!-- ENVIRONNEMENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<?php
$principal = $fiche->getFicheTypeExternePrincipale();

$fichesMetiers = $fiche->getFichesMetiers();
$fichesMetiers = array_filter($fichesMetiers, function (FicheTypeExterne $a) { return !$a->getPrincipale(); });
usort($fichesMetiers, function (FicheTypeExterne $a, FicheTypeExterne $b) { return ($a->getQuotite() > $b->getQuotite()); });
?>

<div class="environnement-block">
    <div class="titre-banner">
        Description des fiches métiers
    </div>

    <div>
    La fiche de poste est composée de <?php echo count($fiche->getFichesMetiers()); ?> fiche(s) type(s).
    <ul>
        <?php if ($principal) : ?>
            <li> <strong> <?php echo $principal->getFicheType()->getMetier() ?> à <?php echo $principal->getQuotite(); ?>%</strong></li>
        <?php endif; ?>
        <?php /** @var FicheTypeExterne $ficheType **/ ?>
        <?php foreach ($fichesMetiers as $ficheType) : ?>
            <li> <?php echo $ficheType->getFicheType()->getMetier(); ?> à <?php echo $ficheType->getQuotite(); ?>% </li>
        <?php endforeach; ?>
    </ul>
    </div>

    <?php
        /** @var FicheTypeExterne[] $fiches */
        $fiches = [];
        if ($principal) $fiches[] = $principal;
        foreach ($fichesMetiers as $ficheType) $fiches[] = $ficheType;
    ?>

    <?php foreach ($fiches as $ficheMetier) : ?>
        <div class="fiche-banner">
            <?php echo  $ficheMetier->getFicheType()->getMetier()->getLibelle(); ?>
        </div>

        <h3>Missions principales :</h3>
        <?php $activites = explode(";",$ficheMetier->getActivites()); ?>
        <ul>
            <?php foreach ($ficheMetier->getFicheType()->getActivites() as $activite) : ?>
                <?php if (array_search($activite->getActivite()->getId(), $activites) !== false) : ?>
                    <li> <?php echo $activite->getActivite()->getLibelle(); ?> </li>
                <?php endif; ?>
            <?php endforeach; ?>
        </ul>

        <h3> Description des missions : </h3>
        <dl>
        <?php foreach ($ficheMetier->getFicheType()->getActivites() as $activite) : ?>
            <?php if (array_search($activite->getActivite()->getId(), $activites) !== false) : ?>
                <dt> <?php echo $activite->getActivite()->getLibelle(); ?> </dt>
                <dd>
                    <?php if (empty($activite->getActivite()->getDescriptions())) : ?>
                        <?php echo $activite->getActivite()->getDescription(); ?>
                    <?php else: ?>

                    <?php
                        /** @var ActiviteDescription[]  $descriptions */
                        $descriptions = $activite->getActivite()->getDescriptions();
                        /** @var FicheposteActiviteDescriptionRetiree[] $descriptionsRetirees */
                        $descriptionsRetirees = $fiche->getDescriptionsRetirees()->toArray();
                    ?>

                    <ul>
                        <?php foreach ($descriptions as $description) : ?>
                            <?php
                                $found = false;
                                foreach ($descriptionsRetirees as $descriptionRetiree) {
                                    if ($descriptionRetiree->getDescription()->getId() === $description->getId()) {
                                        $found = true;
                                        break;
                                    }
                                }
                            ?>
                            <?php if (!$found) : ?>
                                <li> <?php echo $description->getDescription(); ?> </li>
                            <?php endif; ?>
                        <?php endforeach; ?>

                    </ul>


                    <?php endif; ?>
                </dd>
            <?php endif; ?>
        <?php endforeach; ?>
        </dl>
    <?php endforeach; ?>
<br/>

<!-- PRISE DE POSTE ------>

<div class="">
    <div class="titre-banner">
        Compétences attendues - Formations proposées
    </div>

    <?php $cCompetences = array_filter($competences, function ($a) { return $a["conserve"];}); ?>

    <?php if (!empty($cCompetences)) : ?>
        <?php
            $types = [];
            foreach ($cCompetences as $item) {
                $competence = $item["object"];
                $type = $competence->getType();
                $types[$type->getLibelle()] = $type;
            }

            usort($types, function (CompetenceType $a, CompetenceType $b) { return $a->getOrdre() > $b->getOrdre();});

            $dictionnaires = [];
            foreach ($types as $type) {
                $dictionnaires[$type->getLibelle()] = [];
            }

            foreach ($cCompetences as $item) {
                $competence = $item["object"];
                $type = $competence->getType()->getLibelle();
                $dictionnaires[$type][] = $competence;
            }

        ?>

        <h3> Compétences </h3>

        <?php foreach ($dictionnaires as $clef => $listing) : ?>
            <h4> <?php echo $clef; ?></h4>
            <ul>
                <?php foreach ($listing as $competence) : ?>
                    <li> <?php echo $competence->getLibelle(); ?> </li>
                <?php endforeach; ?>
            </ul>
        <?php endforeach; ?>
    <?php endif; ?>

    <?php $cApplications = array_filter($applications, function ($a) { return $a["conserve"];}); ?>

    <?php if (!empty($cApplications)) : ?>
        <h3> Applications </h3>

        <ul>
        <?php foreach ($cApplications as $application) : ?>
            <li> <?php echo $application["entite"]->getLibelle(); ?> </li>
        <?php endforeach; ?>
        </ul>
    <?php endif; ?>

    <?php $cFormations = array_filter($formations, function ($a) { return $a["conserve"];}); ?>

    <?php if (!empty($cFormations)) : ?>
        <h3> Formations </h3>

        <ul>
            <?php foreach ($cFormations as $formation) : ?>
                <li> <?php echo $formation["object"]->getLibelle(); ?> </li>
            <?php endforeach; ?>
        </ul>
    <?php endif; ?>
</div>

<!-- EXPERTISE ----------->

<?php
    /** @var Expertise[] $expertises */
    $expertises = $fiche->getExpertises()->toArray();
    $expertises = array_filter($expertises, function (Expertise $e) { return $e->getHistoDestruction() === null;});
?>

<?php if (!empty($expertises) AND $fiche->hasExpertise()) : ?>
    <div class="">
        <div class="titre-banner">
            Expertises
        </div>

        <ul>
        <?php foreach ($expertises as $expertise) : ?>
            <li> <strong> <?php echo $expertise->getLibelle(); ?> </strong>
            <?php echo $expertise->getDescription(); ?> </li>
        <?php endforeach; ?>
        </ul>
    </div>
<?php endif; ?>

<!-- SPECIFICITE DU POSTE --------------------------------------------------------------------------------------------->
<?php if ($fiche->getSpecificite() !== null) : ?>
<div class="">
    <div class="titre-banner">
        Spécificités du poste
    </div>

        <?php echo $this->specificitePoste($fiche->getSpecificite()); ?>
</div>

<?php endif; ?>

<style>
    body {
        font-size: 10pt;
        font-family: Calibri, "Times", monospace;
    }
    div.titre-block{
        width:100%;
        font-family: Arial, monospace;
        color:white;
        font-size: 16pt;
        margin-bottom: 1.5rem;
    }
    div.titre-intitule {
        padding: 1rem;
        background-color: #44a17f;
    }
    div.titre-affectation {
        background-color: #1993a1;
        padding: 0.5rem;
    }

    div.titre-banner {
        background-color: #c6fff8
        margin-top:0.5rem;
        margin-bottom:0.5rem;
        border-top: dashed 1px grey;
        border-bottom: dashed 1px grey;
        font-size: 15pt;
    }

    div.fiche-banner {
        background-color: #c6ffcc
        margin-top:0.5rem;
        margin-bottom:0.5rem;
        border-top: dotted 1px grey;
        border-bottom: dotted 1px grey;
        font-size: 12pt;
    }

    table.info {
        border: solid 1px black ;
        width:100%;
        border-collapse: collapse;
    }

    table.info th {
        width: 30%;
        text-align: left;
        border: solid 1px black ;
    }

    table.info td {
        text-align: left;
        border: solid 1px black ;
    }

    span.manquant {
        background-color: #e798bc;
        color:darkred;
    }

    dl {
        margin-left: 10%;
    }
    dl dt {
        font-weight: bold;
    }

</style>