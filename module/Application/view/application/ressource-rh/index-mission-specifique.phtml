<?php

/**
 * @var Application\Entity\Db\MissionSpecifique[] $missions
 * @var Application\Entity\Db\MissionSpecifiqueType[] $types
 * @var Application\Entity\Db\MissionSpecifiqueTheme[] $themes
 */

use Application\Controller\RessourceRhController;
use Application\Provider\Privilege\RessourceRhPrivileges;

$this->headTitle('Index des missions spécifique');

$canVoirRessource       = $this->isAllowed(RessourceRhPrivileges::getResourceId(RessourceRhPrivileges::AFFICHER));
$canAjouterRessource    = $this->isAllowed(RessourceRhPrivileges::getResourceId(RessourceRhPrivileges::AJOUTER));
$canEditerRessource     = $this->isAllowed(RessourceRhPrivileges::getResourceId(RessourceRhPrivileges::MODIFIER));
$canHistoriserRessource = $this->isAllowed(RessourceRhPrivileges::getResourceId(RessourceRhPrivileges::MODIFIER));
$canEffacerRessource    = $this->isAllowed(RessourceRhPrivileges::getResourceId(RessourceRhPrivileges::EFFACER));

?>

<h1 class="page-header">
    Index des missions spécifique
</h1>

<div class="main">
    <div class="row">
        <div class="col-md-8">
            <h2>
                Types de missions complémentaires
                <span class="badge">
                    <?php echo count($types); ?>
                </span>
            </h2>
        </div>
        <div class="col-md-4">
            <?php if ($canAjouterRessource) : ?>
                <br/>
                <?php /** @see RessourceRhController::ajouterMissionSpecifiqueTypeAction() */ ?>
                <a href="<?php echo $this->url('ressource-rh/mission-specifique-type/ajouter', [], [], true);?>"
                   class="btn btn-primary action ajax-modal"
                   data-event="modification"
                >
                    <span class="icon ajouter"></span>
                    Ajouter un type de mission
                </a>
            <?php endif;?>
        </div>
    </div>

    <table class="table table-condensed datatable">
        <thead>
            <tr>
                <th> Libelle </th>
                <th> #Mission </th>
                <th> Modificateur </th>
                <th> Action </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($types as $type) : ?>
                <tr>
                    <td> <?php echo $type->getLibelle(); ?> </td>
                    <td> <?php echo count($type->getMissions()); ?> </td>
                    <td>
                        <small>
                            <?php echo $type->getHistoModification()->format('d/m/Y à H:i:s'); ?>
                            <br/>
                            <?php echo $type->getHistoModificateur()->getDisplayName(); ?>
                        </small>
                    </td>
                    <td>
                        <?php if ($canVoirRessource) : ?>
                            <?php /** @see RessourceRhController::afficherMissionSpecifiqueTypeAction() */ ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique-type/afficher', ['mission-specifique-type' => $type->getId()], [], true); ?>"
                               class="ajax-modal"
                            >
                                <span class="icon voir" title="Afficher le type de mission"></span></a>
                        <?php else : ?>
                                <span class="icon voir" style="color:lightgray"></span>
                        <?php endif; ?>
                        <?php if ($canEditerRessource) : ?>
                            <?php /** @see RessourceRhController::modifierMissionSpecifiqueTypeAction() */ ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique-type/modifier', ['mission-specifique-type' => $type->getId()], [], true); ?>"
                               data-event="modification"
                               class="ajax-modal"
                            >
                                <span class="icon editer" title="Modifier le type de mission"></span></a>
                        <?php else : ?>
                            <span class="icon editer" style="color: lightgrey;"></span>
                        <?php endif; ?>
                        <?php if ($canHistoriserRessource) : ?>
                            <?php if ($type->getHistoDestruction() === null) : ?>
                                <?php /** @see RessourceRhController::historiserMissionSpecifiqueTypeAction() */ ?>
                                <a href="<?php echo $this->url('ressource-rh/mission-specifique-type/historiser', ['mission-specifique-type' => $type->getId()], [], true); ?>">
                                    <span class="icon historiser" title="Historiser le type de mission"></span></a>
                            <?php else : ?>
                                <?php /** @see RessourceRhController::restaurerMissionSpecifiqueTypeAction() */ ?>
                                <a href="<?php echo $this->url('ressource-rh/mission-specifique-type/restaurer', ['mission-specifique-type' => $type->getId()], [], true); ?>">
                                    <span class="icon restaurer" title="Restaurer le type de mission"></span></a>
                            <?php endif; ?>
                        <?php else : ?>
                            <?php if ($type->getHistoDestruction() === null) : ?>
                                <span class="icon historiser" style="color: lightgrey;"></span>
                            <?php else : ?>
                                <span class="icon restaurer" style="color: lightgrey;"></span>
                            <?php endif; ?>
                        <?php endif; ?>
                        <?php if ($canEffacerRessource) : ?>
                            <?php /** @see RessourceRhController::detruireMissionSpecifiqueTypeAction() */ ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique-type/detruire', ['mission-specifique-type' => $type->getId()], [], true); ?>" >
                                <span class="icon detruire" title="Effacer le type de mission"></span></a>
                        <?php else : ?>
                            <span class="icon detruire" style="color: lightgrey;"></span>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>

<div class="main">
    <div class="row">
        <div class="col-md-8">
            <h2>
                Thèmes de missions complémentaires
                <span class="badge">
                    <?php echo count($themes); ?>
                </span>
            </h2>
        </div>
        <div class="col-md-4">
            <?php if ($canAjouterRessource) : ?>
                <br/>
                <?php /** @see RessourceRhController::ajouterMissionSpecifiqueThemeAction() */ ?>
                <a href="<?php echo $this->url('ressource-rh/mission-specifique-theme/ajouter', [], [], true);?>"
                   class="btn btn-primary action ajax-modal"
                   data-event="modification"
                >
                    <span class="icon ajouter"></span>
                    Ajouter un thème de mission
                </a>
            <?php endif;?>
        </div>
    </div>

    <table class="table table-condensed datatable">
        <thead>
        <tr>
            <th> Libelle </th>
            <th> #Mission </th>
            <th> Modificateur </th>
            <th> Action </th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($themes as $theme) : ?>
            <tr>
                <td> <?php echo $theme->getLibelle(); ?> </td>
                <td> <?php echo count($theme->getMissions()); ?> </td>
                <td>
                    <small>
                        <?php echo $theme->getHistoModification()->format('d/m/Y à H:i:s'); ?>
                        <br/>
                        <?php echo $theme->getHistoModificateur()->getDisplayName(); ?>
                    </small>
                </td>
                <td>
                    <?php if ($canVoirRessource) : ?>
                        <?php /** @see RessourceRhController::afficherMissionSpecifiqueThemeAction() */ ?>
                        <a href="<?php echo $this->url('ressource-rh/mission-specifique-theme/afficher', ['mission-specifique-theme' => $theme->getId()], [], true); ?>"
                           class="ajax-modal"
                        >
                            <span class="icon voir" title="Afficher le thème de mission"></span></a>
                    <?php else : ?>
                        <span class="icon voir" style="color:lightgray"></span>
                    <?php endif; ?>
                    <?php if ($canEditerRessource) : ?>
                        <?php /** @see RessourceRhController::modifierMissionSpecifiqueThemeAction() */ ?>
                        <a href="<?php echo $this->url('ressource-rh/mission-specifique-theme/modifier', ['mission-specifique-theme' => $theme->getId()], [], true); ?>"
                           data-event="modification"
                           class="ajax-modal"
                        >
                            <span class="icon editer" title="Modifier le thème de mission"></span></a>
                    <?php else : ?>
                        <span class="icon editer" style="color: lightgrey;"></span>
                    <?php endif; ?>
                    <?php if ($canHistoriserRessource) : ?>
                        <?php if ($theme->getHistoDestruction() === null) : ?>
                            <?php /** @see RessourceRhController::historiserMissionSpecifiqueThemeAction() */ ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique-theme/historiser', ['mission-specifique-theme' => $theme->getId()], [], true); ?>">
                                <span class="icon historiser" title="Historiser le thème de mission"></span></a>
                        <?php else : ?>
                            <?php /** @see RessourceRhController::restaurerMissionSpecifiqueThemeAction() */ ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique-theme/restaurer', ['mission-specifique-theme' => $theme->getId()], [], true); ?>">
                                <span class="icon restaurer" title="Restaurer le thème de mission"></span></a>
                        <?php endif; ?>
                    <?php else : ?>
                        <?php if ($theme->getHistoDestruction() === null) : ?>
                            <span class="icon historiser" style="color: lightgrey;"></span>
                        <?php else : ?>
                            <span class="icon restaurer" style="color: lightgrey;"></span>
                        <?php endif; ?>
                    <?php endif; ?>
                    <?php if ($canEffacerRessource) : ?>
                        <?php /** @see RessourceRhController::detruireMissionSpecifiqueThemeAction() */ ?>
                        <a href="<?php echo $this->url('ressource-rh/mission-specifique-theme/detruire', ['mission-specifique-theme' => $theme->getId()], [], true); ?>" >
                            <span class="icon detruire" title="Effacer le thème de mission"></span></a>
                    <?php else : ?>
                        <span class="icon detruire" style="color: lightgrey;"></span>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
</div>

<div class="main">
    <div class="row">
        <div class="col-md-8">
            <h2>
                Missions complémentaires
                <span class="badge">
                    <?php echo count($missions); ?>
                </span>
            </h2>
        </div>
        <div class="col-md-4">
            <?php if ($canAjouterRessource) : ?>
                <br/>
                <a href="<?php echo $this->url('ressource-rh/mission-specifique/ajouter', [], [], true);?>"
                   class="btn btn-primary action ajax-modal"
                   data-event="modification"
                >
                    <span class="icon ajouter"></span>
                    Ajouter une mission
                </a>
            <?php endif;?>
        </div>
    </div>

    <?php if (count($missions) > 0) : ?>
        <table id="" class="table table-condensed datatable">
            <thead>
            <tr>
<!--                <th> Id </th>-->
                <th> Libelle </th>
                <th> Type </th>
                <th> Thème </th>
                <th> #Agent </th>
                <th> Modificateur </th>
                <th class="action"> Action </th>
            </tr>
            </thead>
            <tbody>
            <?php foreach ($missions as $mission) : ?>
                <tr>
                    <td> <?php echo $mission->getLibelle(); ?> </td>
                    <td> <?php echo ($mission->getType())?$mission->getType()->getLibelle():"Aucun"; ?> </td>
                    <td> <?php echo ($mission->getTheme())?$mission->getTheme()->getLibelle():"Aucun"; ?> </td>
                    <td> <?php echo count($mission->getAffectations()); ?> </td>
                    <td> <small>
                            <?php echo $mission->getHistoModificateur()->getDisplayName(); ?> <br/>
                            <?php echo $mission->getHistoModification()->format('d/m/Y à H:i'); ?>
                        </small>
                    </td>
                    <td>
                        <?php if ($canVoirRessource) : ?>
                            <?php /** @see RessourceRhController::afficherMissionSpecifiqueAction() */ ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique/afficher', ['mission' => $mission->getId()], [], true); ?>"
                               class="ajax-modal"
                            >
                                <span class="icon voir" title="Afficher la mission"></span></a>
                        <?php else : ?>
                            <span class="icon voir" style="color:lightgray"></span>
                        <?php endif; ?>
                        <?php if ($canEditerRessource) : ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique/modifier', ['mission' => $mission->getId()], [], true); ?>"
                               data-event="modification"
                               class="ajax-modal"
                            >
                                <span class="icon editer" title="Modifier le domaine"></span></a>
                        <?php else : ?>
                                <span class="icon editer" style="color: lightgrey;"></span>
                        <?php endif; ?>
                        <?php if ($canHistoriserRessource) : ?>
                            <?php if ($mission->getHistoDestruction() === null) : ?>
                                <a href="<?php echo $this->url('ressource-rh/mission-specifique/historiser', ['mission' => $mission->getId()], [], true); ?>">
                                    <span class="icon historiser" title="Historiser le domaine"></span></a>
                            <?php else : ?>
                                <a href="<?php echo $this->url('ressource-rh/mission-specifique/restaurer', ['mission' => $mission->getId()], [], true); ?>">
                                    <span class="icon restaurer" title="Restaurer le domaine"></span></a>
                            <?php endif; ?>
                        <?php else : ?>
                            <?php if ($mission->getHistoDestruction() === null) : ?>
                                <span class="icon historiser" style="color: lightgrey;"></span>
                            <?php else : ?>
                                <span class="icon restaurer" style="color: lightgrey;"></span>
                            <?php endif; ?>
                        <?php endif; ?>
                        <?php if ($canEffacerRessource) : ?>
                            <a href="<?php echo $this->url('ressource-rh/mission-specifique/supprimer', ['mission' => $mission->getId()], [], true); ?>" >
                                <span class="icon detruire" title="Effacer le domaine"></span></a>
                            <?php else : ?>
                                <span class="icon detruire" style="color: lightgrey;"></span>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>
</div>

<script>
    $(document).ready(function() {
        $('.datatable').DataTable( {
            language: {
                url: '/localisation/fr_FR.json'
            }
        });
    });

    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>
