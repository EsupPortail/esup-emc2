<?php

/**
 * @see \Application\Controller\ValidationController::indexAction()
 * @var \Doctrine\ORM\EntityManager $em
 * @var ValidationDemande[] $demandes
 */

use Application\Entity\Db\ValidationDemande;
use Application\Entity\Db\ValidationType;
use Application\Provider\Privilege\FicheMetierPrivileges;
use Application\Provider\Privilege\ValidationPrivileges;

$this->headTitle("Index des demandes");

$canVoirFicheMetier = $this->isAllowed(FicheMetierPrivileges::getResourceId(FicheMetierPrivileges::FICHEMETIER_AFFICHER));
$canVoirValidation  = $this->isAllowed(ValidationPrivileges::getResourceId(ValidationPrivileges::AFFICHER));
$canCreerDemande    = $this->isAllowed(ValidationPrivileges::getResourceId(ValidationPrivileges::CREER_DEMANDE));
$canModifierDemande = $this->isAllowed(ValidationPrivileges::getResourceId(ValidationPrivileges::MODIFIER_DEMANDE));
$canDetruireDemande = $this->isAllowed(ValidationPrivileges::getResourceId(ValidationPrivileges::DETRUIRE_DEMANDE));


$enAttentes = [];
$completees  = [];
foreach ($demandes as $demande) {
    if ($demande->getValidation() === null) {
        $enAttentes[] = $demande;
    } else {
        $completees[] = $demande;
    }
}
usort($enAttentes, function (ValidationDemande $a, ValidationDemande $b) { return $a->getHistoCreation() < $b->getHistoCreation(); });
usort($completees, function (ValidationDemande $a, ValidationDemande $b) { return $a->getValidation()->getHistoModification() < $b->getValidation()->getHistoModification(); });
?>

<h1 class="page-header">
    Index des demandes <br/>
    Fiche Metier / ...
</h1>

<?php echo $this->messenger()->addMessagesFromFlashMessenger(); ?>

<div class="main">
    <a id="fiche-metier"></a>
    <h2> Demandes de validations associées aux fiches métiers</h2>

    <div class="row">
        <?php if ($canCreerDemande) : ?>
            <?php /**  @see \Application\Controller\ValidationController::creerDemandesFicheMetierDomaineAction() */ ?>
            <a href="<?php echo $this->url('validation-fiche/creer-demandes-fiche-metier-domaine', [], []); ?>"
               class="btn btn-primary action ajax-modal"
               data-event="modification"
            >
                <span class="icon ajouter"></span>
                Créer des demandes pour des domaines
            </a>

            <?php /**  @see \Application\Controller\ValidationController::creerDemandeFicheMetierAction() */ ?>
            <a href="<?php echo $this->url('validation-fiche/creer-demande-fiche-metier', [], []); ?>"
               class="btn btn-primary action ajax-modal"
               data-event="modification"
            >
                <span class="icon ajouter"></span>
                Créer une demande pour des fiches
            </a>
        <?php endif; ?>
    </div>

    <h3>
        Demandes en attentes
        <span class="badge">
            <?php echo count($enAttentes); ?>
        </span>
    </h3>

    <table class="table table-condensed">
        <thead>
        <tr>
            <th style="width:3em;"> Id. </th>
            <th> Objet </th>
            <th style="width:14rem;" > Création </th>
            <th style="width:14rem;"> Validateur </th>
            <th style="width:5em;"> Action </th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($enAttentes as $demande) : ?>
            <tr>
                <td> <?php echo $demande->getId(); ?> </td>
                <td>
                    <span class="TODO"> Coorigé problème récupération nom de la fiche</span>
                    <?php //echo $demande->getObject($em)->getMetier()->getLibelle(); ?>
                </td>
                <td>
                    <small>
                        <?php echo $demande->getHistoCreation()->format("d/m/Y à H:i:s"); ?> <br/>
                    </small>
                </td>
                <td>
                    <small>
                        <?php echo $demande->getValidateur()->getDisplayName(); ?>
                    </small>
                </td>
                <td>
                    <?php
                    if ($demande->getType()->getCode() === ValidationType::FICHE_METIER_RELECTURE) : ?>
                        <a href="<?php echo $this->url('fiche-metier-type/afficher', ['id' => $demande->getObjectId()], [], true); ?>" class="ajax-modal">
                            <span class="icon voir" title="Visualiser l'élément à valider"></span></a>
                    <?php else : ?>
                        <span class="icon voir" style="color:lightgrey;"></span>
                    <?php endif; ?>

                    <?php if($canModifierDemande) : ?>
                        <?php /** @see \Application\Controller\ValidationController::modifierDemandeAction() */ ?>
                        <a href="<?php echo $this->url('validation-fiche/modifier-demande', ['demande' => $demande->getId()], [], true); ?>"
                           class="ajax-modal" data-event="modification">
                            <span class="icon editer" title="Modifier la demande de validation"></span></a>
                    <?php else : ?>
                        <span class="icon editer" style="color:lightgrey;"></span>
                    <?php endif; ?>

                    <?php if($canDetruireDemande) : ?>
                        <?php /** @see \Application\Controller\ValidationController::detruireDemandeAction() */ ?>
                        <a href="<?php echo $this->url('validation-fiche/detruire-demande', ['demande' => $demande->getId()], [], true); ?>">
                        <span class="icon detruire" title="Détruire la demande de validation"></span></a>
                    <?php else: ?>
                        <span class="icon detruire" style="color:lightgrey;"></span>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>

    <h3>
        Demandes complétées
        <span class="badge">
            <?php echo count($completees); ?>
        </span>
    </h3>

    <table class="table table-condensed">
        <thead>
        <tr>
            <th style="width:3em;"> Id. </th>
            <th> Objet </th>
            <th style="width:14rem;"> Date </th>
            <th style="width:14rem;"> Validateur </th>
            <th  style="width:5em;" > Validation </th>
            <th style="width:5em;"> Actions </th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($completees as $demande) : ?>
            <tr>
                <td> <?php echo $demande->getId(); ?> </td>
                <td> <?php echo $demande->getObject($em)->getMetier()->getLibelle(); ?> </td>
                <td>
                    <small>
                        <?php echo $demande->getValidation()->getHistoCreation()->format("d/m/Y à H:i:s"); ?> <br/>
                    </small>
                </td>
                <td>
                    <small>
                        <?php echo $demande->getValidateur()->getDisplayName(); ?>
                    </small>
                </td>
                <td>
                    <?php if ($demande->getValidation() !== null) : ?>
                        <?php echo $this->validationBadge($demande->getValidation()); ?>
                    <?php else : ?>
                        Aucune
                    <?php endif; ?>
                </td>
                <td>
                    <?php if ($canVoirFicheMetier) : ?>
                        <?php /** @see \Application\Controller\FicheMetierController::afficherAction() */ ?>
                        <a href="<?php echo $this->url('fiche-metier-type/afficher', ['id' => $demande->getObjectId()], [], true); ?>"
                           class="ajax-modal">
                            <span class="icon voir" title="Voir la fiche métier associée"></span></a>
                    <?php else : ?>
                        <span class="icon voir" style="color:lightgrey;"></span>
                    <?php endif; ?>

                    <?php if ($canVoirValidation) : ?>
                        <?php /** @see \Application\Controller\ValidationController::afficherAction() */ ?>
                        <a href="<?php echo $this->url('validation-fiche/afficher', ['validation' => $demande->getValidation()->getId()], [], true); ?>"
                           class="ajax-modal">
                            <span class="icon verification" title="Voir la validation"></span></a>
                    <?php else : ?>
                        <span class="icon verification" style="color:lightgrey;"></span>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>

</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>