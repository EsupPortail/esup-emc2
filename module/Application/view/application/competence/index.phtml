<?php

/**
 * @var CompetenceType[]    $types
 * @var CompetenceTheme[]   $themes
 * @var Competence[]        $competences
 * @var array              $competencesByType
 */

use Application\Controller\CompetenceController;use Application\Entity\Db\Competence;
use Application\Entity\Db\CompetenceTheme;
use Application\Entity\Db\CompetenceType;
use Application\Provider\Privilege\CompetencePrivileges;

$canVoir        = $this->isAllowed(CompetencePrivileges::getResourceId(CompetencePrivileges::AFFICHER));
$canAjouter     = $this->isAllowed(CompetencePrivileges::getResourceId(CompetencePrivileges::AJOUTER));
$canModifier    = $this->isAllowed(CompetencePrivileges::getResourceId(CompetencePrivileges::EDITER));
$canHistoriser  = $canModifier;
$canDetruire    = $this->isAllowed(CompetencePrivileges::getResourceId(CompetencePrivileges::EFFACER));
?>

<h1 class="page-header">
    Index des compétences
</h1>

<div class="main">
    <div class="row">
        <center>
        <?php /** @see CompetenceController::ajouterAction() */ ?>
        <a href="<?php echo $this->url('competence/ajouter', [], [], true); ?>"
           class="btn btn-primary action ajax-modal"
           data-event="modification"
        >
            <span class="icon ajouter"></span> Ajouter une compétence</a>

        <?php /** @see CompetenceController::ajouterCompetenceTypeAction() */ ?>
        <a href="<?php echo $this->url('competence-type/ajouter', [], [], true); ?>"
           class="btn btn-primary action ajax-modal"
           data-event="modification"
        >
            <span class="icon ajouter"></span> Ajouter un type de compétence</a>

        <?php /** @see CompetenceController::ajouterCompetenceThemeAction() */ ?>
        <a href="<?php echo $this->url('competence-theme/ajouter', [], [], true); ?>"
           class="btn btn-primary action ajax-modal"
           data-event="modification"
        >
            <span class="icon ajouter"></span> Ajouter un thème de compétence</a>
        </center>
    </div>
</div>

<?php foreach ($competencesByType as $competencesArray) : ?>
    <?php
        /** @var CompetenceType $type */
        $type = $competencesArray['type'];
        /** @var Competence[] $competences */
        $competences = $competencesArray['competences'];
    ?>
<div class="main">
    <h2>
        Compétence <?php echo $type->getLibelle(); ?>
        <span class="badge">
            <?php echo count($competences); ?>
        </span>
    </h2>

    <table class="datatable table table-condensed">
        <thead>
        <tr>
            <th> Libellé </th>
<!--            <th> Type </th>-->
            <th> Thème </th>
            <th class="modificateur-cell"> Modificateur </th>
            <th class="action-cell"> Action </th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($competences as $competence) : ?>
            <tr>
                <td> <?php echo $competence->getLibelle(); ?> </td>
<!--                <td> --><?php //echo ($competence->getType())?$competence->getType()->getLibelle():"Auncun"; ?><!-- </td>-->
                <td> <?php echo ($competence->getTheme())?$competence->getTheme()->getLibelle():"Auncun"; ?> </td>
                <td>
                    <small>
                        <?php echo $competence->getHistoModification()->format('d/m/Y à H:i:s'); ?> <br/>
                        <?php echo $competence->getHistoModificateur()->getDisplayName(); ?>
                    </small>
                </td>
                <td>
                    <?php if ($canVoir): ?>
                        <?php /** @see CompetenceController::afficherAction() */?>
                        <a href="<?php echo $this->url('competence/afficher', ['competence' => $competence->getId()], [], true); ?>"
                           class="ajax-modal">
                            <span class="icon voir" title="Afficher la compétence "></span></a>
                    <?php else: ?>
                        <span class="icon voir" style="color:lightgray;"></span>
                    <?php endif; ?>
                    <?php if ($canModifier): ?>
                        <?php /** @see CompetenceController::modifierAction() */?>
                        <a href="<?php echo $this->url('competence/modifier', ['competence' => $competence->getId()], [], true); ?>"
                           class="ajax-modal"
                           data-event="modification"
                        >
                            <span class="icon editer" title="Modifier la compétence"></span></a>
                    <?php else: ?>
                        <span class="icon editer" style="color:lightgray;"></span>
                    <?php endif; ?>
                    <?php if ($canModifier): ?>
                        <?php if($competence->estNonHistorise()) : ?>
                            <?php /** @see CompetenceController::historiserAction() */?>
                            <a href="<?php echo $this->url('competence/historiser', ['competence' => $competence->getId()], [], true); ?>">
                                <span class="icon historiser" title="Historiser la compétence"></span></a>
                        <?php else : ?>
                            <?php /** @see CompetenceController::restaurerAction() */?>
                            <a href="<?php echo $this->url('competence/restaurer', ['competence' => $competence->getId()], [], true); ?>">
                                <span class="icon restaurer" title="Restaurer la compétence"></span></a>
                        <?php endif; ?>
                    <?php else: ?>
                        <?php if($competence->estNonHistorise()) : ?>
                            <span class="icon historiser" style="color:lightgray;"></span>
                        <?php else : ?>
                            <span class="icon restaurer" style="color:lightgray;"></span>
                        <?php endif; ?>
                    <?php endif; ?>
                    <?php if ($canDetruire): ?>
                        <?php /** @see CompetenceController::detruireAction() */?>
                        <a href="<?php echo $this->url('competence/detruire', ['competence' => $competence->getId()], [], true); ?>">
                            <span class="icon detruire" title="Detruire la compétence"></span></a>
                    <?php else: ?>
                        <span class="icon detruire" style="color:lightgray;"></span>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
</div>
<?php endforeach; ?>



<style>
    th.action-cell {
        width:6rem;
    }
    th.modificateur-cell {
        width:12rem;
    }
</style>
<script>
    $(document).ready(function() {
        $('.datatable').DataTable( {
            language: {
                url: '/localisation/fr_FR.json'
            }
        });
    } );

    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>
