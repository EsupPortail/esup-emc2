<?php

use Application\Entity\Db\Agent;
use Application\Entity\Db\AgentAffectation;
use Application\Entity\Db\AgentGrade;
use Application\Entity\Db\AgentMissionSpecifique;
use Application\Entity\Db\AgentPPP;
use Application\Entity\Db\AgentQuotite;
use Application\Entity\Db\AgentStatut;
use Application\Entity\Db\FichePoste;
use Application\Provider\Privilege\AgentPrivileges;
use EntretienProfessionnel\Entity\Db\EntretienProfessionnel;
use UnicaenUtilisateur\Entity\Db\User;

/**
 * @see AgentController::afficherAction()
 * @var Agent   $agent
 * @var EntretienProfessionnel[] $entretiens
 * @var User[]  $responsables
 * @var array $parcoursArray
 * @var FichePoste[] $fichespostes
 * @var AgentMissionSpecifique[] $missions
 * @var AgentAffectation[] $affectations
 * @var AgentStatut[] $statuts
 * @var AgentGrade[] $grades
 * @var AgentQuotite|null $quotite
 *
 * @var AgentPPP[] $ppps
 */

$displayParcours = false;
$displayAcquis = false;

if ($agent !== null) {
    $canVoir = $this->isAllowed(AgentPrivileges::getResourceId(AgentPrivileges::AGENT_AFFICHER));
    $canAjouter = $this->isAllowed($agent, AgentPrivileges::AGENT_ELEMENT_AJOUTER);
    $canModifier = $this->isAllowed($agent, AgentPrivileges::AGENT_ELEMENT_MODIFIER);
    $canHistoriser = $this->isAllowed($agent, AgentPrivileges::AGENT_ELEMENT_HISTORISER);
    $canDetruire = $this->isAllowed($agent, AgentPrivileges::AGENT_ELEMENT_DETRUIRE);
    $canValider = $this->isAllowed($agent, AgentPrivileges::AGENT_ELEMENT_VALIDER);
    $canInfoSource = $this->isAllowed(AgentPrivileges::getResourceId(AgentPrivileges::AGENT_INFO_SOURCE));
    $canAfficherMission = $canVoir;

    $droits = [
        'afficher' => $canVoir,
        'voir' => $canVoir,
        'ajouter' => $canAjouter,
        'modifier' => $canModifier,
        'historiser' => $canHistoriser,
        'detruire' => $canDetruire,
        'valider' => $canValider,
        'voirHistorique' => $canDetruire,
        'afficherMission' => $canAfficherMission,
    ];

    $options = [];
    $options['texte'] = true;
    $options['droits'] = $droits;
    $options['retour'] = $this->url('agent/afficher', ['agent' => $agent->getId()], [], true);
    $options['actions'] = [
        'afficher' => true, 'ajouter' => $canAjouter, 'modifier' => $canModifier, 'supprimer' => $canDetruire, 'valider' => $canValider
    ];

    $this->headTitle("Affichage de l'agent : " . $agent->getDenomination());
}
?>

<?php if ($agent !== null) : ?>
    <h1 class="page-header">
        Affichage de l'agent <br/>
        <strong><?php echo $agent->getDenomination(); ?></strong>
    </h1>

    <div role="tabpanel">
        <ul class="nav nav-tabs" role="tablist">
            <li>
                <a href="#informations" aria-controls="informations" role="tab" data-toggle="tabz">
                   Informations <br/> générales
                </a>
            </li>
            <li>
                <a href="#fiches" aria-controls="fiches" role="tab" data-toggle="tabz">
                    Fiches de poste, <br/>
                    missions spécifiques
                </a>
            </li>
            <li>
                <a href="#entretiens" aria-controls="entretiens" role="tab" data-toggle="tabz">
                    Entretiens <br/>
                    professionnels
                </a>
            </li>
            <?php if ($displayParcours === true) : ?>
            <li>
                <a href="#parcours" aria-controls="parcours" role="tab" data-toggle="tabz">
                    Parcours de formation<br/> et logiciels metiers
                </a>
            </li>
            <?php endif; ?>
            <li>
                <a href="#acquis" aria-controls="acquis" role="tab" data-toggle="tabz">
                    Acquis de l'agent <br/> &nbsp;
                </a>
            </li>
            <li>
                <a href="#portfolio" aria-controls="portfolio" role="tab" data-toggle="tabz">
                    Portfolio <br/> &nbsp;
                </a>
            </li>
            <li>
                <a href="#ppp" aria-controls="ppp" role="tab" data-toggle="tabz">
                    Projet professionnel <br/> &nbsp;personnels
                </a>
            </li>
            <li>
                <a href="#tutorat" aria-controls="tutorat" role="tab" data-toggle="tabz">
                    Tutorats et <br/> encadrements
                </a>
            </li>
        </ul>
    </div>

    <div>
        <div class="tab-content">
            <div id="informations" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/informations-generales', ['agent' => $agent, 'affectations' => $affectations, 'statuts' => $statuts, 'grades' => $grades, 'responsables' => $responsables, 'quotite' => $quotite,  'canInfoSource' => $canInfoSource]); ?>
            </div>
            <div id="fiches" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/fiche-poste', ['fichespostes' => $fichespostes], []); ?>
                <?php echo $this->partial('partial/mission-specifique', ['missions' => $missions, 'agent' => $agent,  "droits" => $droits, "options" => $options['actions']], []); ?>
            </div>
            <div id="entretiens" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/entretien-professionnel', ['entretiens' => $entretiens, 'agent' => $agent, "droits" => $droits], []); ?>
            </div>

            <?php if ($displayParcours === true) : ?>
            <div id="parcours" class="tab-pane " role="tabpanel">
                <h2>
                    Parcours de formation
                </h2>

                <div class="alert alert-info">
                    <strong><span class="icon attention"></span> Affichage des parcours de formations attachés à votre catégorie, domaines professionnels et métier.</strong> <br/>
                    Il est possible qu'un domaine ou un métier ne possède pas de parcours.
                </div>

                <?php echo $this->partial('partial/parcours-de-formation.phtml', ['parcoursArray' => $parcoursArray, 'agent' => $agent], [], true); ?>
            </div>
            <?php endif; ?>
            <div id="acquis" class="tab-pane " role="tabpanel">
                <h2> Applications, compétences et formations</h2>

                <div class="alert alert-info">
                    <strong><span class="icon attention"> Affichage des applications, compétences et formations directement liées à l'agent.</strong> <br/>
                    Dans ces listes, les applications, compétences et formations associées aux fiches de postes d'un agent ne sont pas mentionnées.
                </div>

                <?php if ($displayAcquis === true) : ?>
                    <!-- APPLICATION ------------------------------------------------------------------------------------------------------>
                    <?php echo $this->applicationBloc($agent->getApplicationDictionnaireComplet(), $agent, $options); ?>

                    <!-- COMPETENCE ------------------------------------------------------------------------------------------------------->
                    <?php echo $this->competenceBloc($agent->getCompetenceDictionnaireComplet(), $agent, $options); ?>
                <?php endif; ?>

                <!-- FORMATION ------------------------------------------------------------------------------------------------------->
                <?php echo $this->formationBloc($agent->getFormationDictionnaire(), $agent, $options); ?>
            </div>
            <div id="portfolio" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/portfolio', ['fichiers' => $agent->getFichiers(), 'agent' => $agent, 'droits' => $droits], []); ?>
            </div>
            <div id="ppp" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/ppp', ['agent' => $agent, 'ppps' => $ppps, 'droits' => $droits], []); ?>
            </div>
            <div id="tutorat" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/tutorat', ['agent' => $agent, 'droits' => $droits], []); ?>
            </div>
        </div>
    </div>
<?php endif; ?>

<style>
    table.parcours-de-formation {
        width:95%;
    }

    table.parcours-de-formation th {
        padding: 0.5rem;
        color: white;
    }
    table.parcours-de-formation td.libelle {
        padding-left: 1rem;
        width:80%;
    }
    table.parcours-de-formation td.formation {
        text-align: center;
    }
</style>

<script>
    $(function() {
        let hash = $(location).attr('hash');
        let name = hash.substr(1);
        if (name === undefined || name === "") name = "informations";

        $('a[aria-controls=' + name + ']').tab('show');

        $('.nav-tabs a').click(function (e) {
            // No e.preventDefault() here
            $(this).tab('show');
        });
    });
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>