<?php

/**
 * @var Agent $agent
 * @var AgentStatut[] $statuts
 * @var AgentAffectation[] $affectations
 * @var AgentGrade[] $grades
 * @var AgentEchelon|null $echelon
 * @var Agent[] $responsables
 * @var Agent[] $autorites
 * @var AgentQuotite $quotite
 * @var bool $canInfoSource
 */

use Application\Entity\Db\Agent;
use Application\Entity\Db\AgentAffectation;
use Application\Entity\Db\AgentEchelon;
use Application\Entity\Db\AgentGrade;
use Application\Entity\Db\AgentQuotite;
use Application\Entity\Db\AgentStatut;
use UnicaenUtilisateur\Entity\Db\User;

?>
<h2> Informations générales sur l'agent </h2>

<div class="row">
    <div class="col-md-4">
        <dl>
            <dt> Prénom </dt>
            <dd>
                <?php echo $agent->getPrenom(); ?>
            </dd>
            <dt> Nom </dt>
            <dd>
                <?php echo $agent->getNomUsuel(); ?>
            </dd>
            <dt> Quotité travaillée </dt>
            <dd>
                <?php if($quotite) : ?>
                    <?php echo $quotite->getQuotite(); ?>%
                <?php else: ?>
                    100%
                <?php endif; ?>
            </dd>
        </dl>

        <?php if ($agent->isContratLong() !== true) : ?>
            <div class="alert alert-warning">
                <span class="icon attention"></span> En contrat de moins de 12 mois.
            </div>
        <?php endif; ?>
    </div>
    <div class="col-md-4">
        <?php
            $affectation = $agent->getAffectationPrincipale();
            $structure = ($affectation)?$affectation->getStructure():null;
            $niveau2   = ($structure)?$structure->getNiv2():null;
        ?>
        <?php if ($structure) : ?>
        <dl>
            <dt> Affectation principale </dt>
            <dd>
                <?php echo $structure->getLibelleLong(); ?> <br/>
                <?php if ($niveau2 !== $structure) : ?>
                    Rattaché&middot;e à <?php echo ($niveau2)?$niveau2->getLibelleLong():"aucune structure de renseignée"; ?>
                <?php endif; ?>
            </dd>
            <dt> Autorité hiérarchique </dt>
            <dd>
                <?php if ($niveau2) : ?>
                    <?php if ($autorites AND !empty($autorites)) : ?>
                        <ul>
                        <?php foreach ($autorites as $autorite) : ?>
                            <li> <?php echo $autorite->getDenomination(); ?> </li>
                        <?php endforeach; ?>
                        </ul>
                    <?php else : ?>
                        <span class="probleme">
                            <span class="icon attention"></span>
                            Aucune responsable pour la structure de niveau 2 <?php echo $affectation->getStructure()->getNiv2()->getLibelleLong(); ?>
                        </span>
                    <?php endif; ?>
                <?php else : ?>
                    <span class="probleme">
                        <span class="icon attention"></span>
                        Aucune structure de niveau 2 de trouvée pour <?php echo $affectation->getStructure()->getLibelleLong(); ?>
                    </span>
                <?php endif; ?>
            </dd>
            <dt> Supérieur&middot;e hiérarchique direct&middot;e</dt>
            <dd>
                <?php if ($responsables AND !empty($responsables)) : ?>
                    <ul>
                        <?php foreach ($responsables as $responsable) : ?>
                            <li> <?php echo $responsable->getDenomination(); ?> </li>
                        <?php endforeach; ?>
                    </ul>
                <?php else : ?>
                    <span class="probleme">
                        <span class="icon attention"></span>
                        Aucune responsable pour la structure <?php echo $affectation->getStructure()->getLibelleLong(); ?>
                    </span>
                <?php endif; ?>
            </dd>
        </dl>
        <?php else : ?>
            <div class="alert alert-danger"> Aucune affectation principale </div>
        <?php endif; ?>
    </div>

    <div class="col-md-4">
        <?php if ($canInfoSource) : ?>
            <dl>
                <dt> Identifiant sources </dt>
                <dd>
                    OCTOPUS - <?php echo $agent->getId(); ?> <br/>
                    HARPEGE - <?php echo $agent->getHarpId(); ?>
                <dt> Compte associé </dt>
                <dd>
                    Agent : <?php echo $agent->getLogin(); ?> <br/> &Rightarrow; <?php echo $agent->getEmail(); ?> <br/>
                    <?php if($agent->getUtilisateur()) : ?>
                        Utilisateur : <?php echo $agent->getUtilisateur()->getUsername(); ?> <br/> &Rightarrow;<?php echo $agent->getUtilisateur()->getEmail(); ?>
                    <?php else: ?>
                        <span class="probleme">
                                <span class="icon attention"></span>
                                Aucun compte lié à l'agent
                            </span>
                    <?php endif; ?>
                </dd>
            </dl>
        <?php endif; ?>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <h2>Affectation(s)</h2>
        <?php foreach ($affectations as $affectation) : ?>
            <?php echo $this->agentAffectation($affectation, ['structure' => true, 'periode' => true, 'temoin' => true]); ?>
        <?php endforeach; ?>
    </div>
    <div class="col-md-3">
        <h2>Statut(s)</h2>
        <?php foreach ($statuts as $statut) : ?>
            <?php echo $this->agentStatut($statut, ['structure' => true, 'periode' => true, 'temoin' => true]); ?>
        <?php endforeach; ?>
    </div>
    <div class="col-md-6">
        <h2>Grade(s)</h2>
        <?php foreach ($grades as $grade) : ?>
            <?php echo $this->agentGrade($grade, ['echelon' => $echelon, 'structure' => true, 'periode' => true, 'temoin' => true]); ?>
        <?php endforeach; ?>
    </div>
</div>
<a
    <?php /** @see \Application\Controller\AgentController::afficherStatutsGradesAction() */?>
    href="<?php echo $this->url('agent/afficher-statuts-grades', ['agent' => $agent->getId()], [], true); ?>"
    class="ajax-modal"
>
    <span class="icon voir"></span> Listing de toutes les affectations, statuts et grades
</a>