<?php

use Application\Controller\FicheMetierController;
use Application\Entity\Db\Application;
use Application\Entity\Db\Competence;
use Application\Entity\Db\FicheMetier;
use Application\Entity\Db\FicheMetierTypeActivite;

/**
 * @var FicheMetier $fiche
 * @var FicheMetierTypeActivite[] $activites
 */


$this->headTitle("Affichage de la fiche métier : ".$fiche->getId());

$canEditer = true;


$array = $fiche->getCompetences();
$competences = [];
/** @var Competence $competence */
foreach ($array as $competence)  {
    $type = $competence->getType();
    if (!isset($competences[$type->getLibelle()])) $competences[$type->getLibelle()] = [];
    $competences[$type->getLibelle()][] = $competence;
}
?>

<div class="row">
    <div class="col-md-8">
        <h1 class="page-header">
            Fiche métier #<?php echo $fiche->getId(); ?> <br/>
            <em><?php echo $fiche->getMetier()->getLibelle(); ?></em>
        </h1>
    </div>
    <div class="col-md-4">
        <?php if ($canEditer) : ?>
            <br/>
            <br/>
            <br/>
            <a  class="btn btn-primary action ajax-modal pull-right"
                data-event="modification"
                href="<?php echo $this->url('fiche-metier-type/editer-libelle', ['id' => $fiche->getId()], [] , true); ?>">
                <span class="icon editer"></span>
                Éditer libellé
            </a>
        <?php endif; ?>
    </div>
</div>

<div class="main">

    <!-- MISSIONS PRINCIPALE ------------------------------------------------------------------------------------------>
    <h2> Missions principales</h2>

    <?php echo $fiche->getMissionsPrincipales(); ?>

    <!-- ACTIVITES ASSOCIEES ------------------------------------------------------------------------------------------>

    <div class="row">
        <div class="col-md-5">
            <h2>
                Acitvités associées
                <span class="badge"> <?php echo count($activites); ?> </span>
            </h2>
        </div>
        <div class="pull-right">
            <br/>
            <?php if ($canEditer) : ?>
            <a  class="btn btn-primary action ajax-modal pull-right"
                href="<?php echo $this->url('fiche-metier-type/ajouter-nouvelle-activite', ['id' => $fiche->getId()], [] , true); ?>"
                data-event="modification"
            >
                <span class="icon ajouter"></span>
                Ajouter une nouvelle activité
            </a>
            <a  class="btn btn-primary action ajax-modal pull-right"
                data-event="modification"
                href="<?php echo $this->url('fiche-metier-type/ajouter-activite-existante', ['id' => $fiche->getId()], [] , true); ?>">
                <span class="icon selectionner"></span>
                Ajouter une activité existante
            </a>
            <?php endif; ?>
        </div>
    </div>

    <?php foreach ($activites as $ficheActivite): ?>
        <?php echo $this->activite($ficheActivite, ['edit-mode' => true]); ?>
    <?php endforeach;?>

    <!-- AUTRE INFO --------------------------------------------------------------------------------------------------->
    <h2>
        Parcours de formation de base pour la prise de poste
    </h2>

    <div class="row">
        <div class="col-md-1">
        </div>
        <div class="col-md-11">
            <a href="" class="btn btn-primary action">
                <span class="icon ajouter"></span>
                Ajouter une application
            </a>

            <?php /** @see FicheMetierController::gererCompetencesAction() */ ?>
            <a href="<?php echo $this->url('fiche-metier-type/gerer-competences', ['fiche' => $fiche->getId()], [], true); ?>"
               class="btn btn-primary action ajax-modal"
               data-event="modification"
            >
                <span class="icon ajouter"></span>
                Gérer les compétences
            </a>

            <a href="" class="btn btn-primary action">
                <span class="icon ajouter"></span>
                Ajouter une formation
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-1">
            <a class="btn btn-default mini ajax-modal"
               data-event="modification"
               href="<?php echo $this->url('fiche-metier-type/modifier-connaissances', ['id' => $fiche->getId()], [], true); ?>"
            >
                <span class="icon editer"></span>
            </a>
        </div>
        <div class="col-md-11">
            <h3> Connaissances </h3>
            <i>
            <?php echo $fiche->getConnaissances(); ?>
            </i>
            <br/>

            <?php $connaissances = $competences['Connaissance']; ?>
            <ul>
                <?php if ($connaissances !== null) : ?>
                    <?php foreach ($connaissances as $competence): ?>
                        <li>
                            <?php echo $competence->getLibelle(); ?>
                        </li>
                    <?php endforeach; ?>
                <?php endif; ?>
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-md-1">
            <a class="btn btn-default mini ajax-modal"
               data-event="modification"
               href="<?php echo $this->url('fiche-metier-type/modifier-operationnelle', ['id' => $fiche->getId()], [], true); ?>"
            >
                <span class="icon editer"></span>
            </a>
        </div>
        <div class="col-md-11">
            <h3> Compétences opérationnelles </h3>
            <i>
            <?php echo $fiche->getCompetencesOperationnelles(); ?>
            </i>

            <?php $connaissances = $competences['Opérationnelle']; ?>
            <ul>
                <?php if ($connaissances !== null) : ?>
                    <?php foreach ($connaissances as $competence): ?>
                        <li>
                            <?php echo $competence->getLibelle(); ?>
                        </li>
                    <?php endforeach; ?>
                <?php endif; ?>
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-md-1">
            <a class="btn btn-default mini ajax-modal"
               data-event="modification"
               href="<?php echo $this->url('fiche-metier-type/modifier-comportementale', ['id' => $fiche->getId()], [], true); ?>"
            >
                <span class="icon editer"></span>
            </a>
        </div>
        <div class="col-md-11">
            <h3> Compétences comportementales </h3>
            <i>
            <?php echo $fiche->getCompetencesComportementales(); ?>
            </i>

            <?php $connaissances = $competences['Comportementale']; ?>
            <ul>
                <?php if ($connaissances !== null) : ?>
                    <?php foreach ($connaissances as $competence): ?>
                        <li>
                            <?php echo $competence->getLibelle(); ?>
                        </li>
                    <?php endforeach; ?>
                <?php endif; ?>
            </ul>
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-md-1">
            <?php /** @see FicheMetierController::modifierApplicationAction() **/ ?>
            <a class="btn btn-default mini ajax-modal"
               data-event="modification"
               href="<?php echo $this->url('fiche-metier-type/modifier-application', ['id' => $fiche->getId()], [], true); ?>"
            >
                <span class="icon editer"></span>
            </a>
        </div>
        <div class="col-md-11">
            <h3> Applications métiers</h3>
                <ul>
                    <?php /** @var Application $application */ ?>
                    <?php foreach($fiche->getApplications() as $application) : ?>
                        <li> <?php echo $application->getLibelle(); ?> </li>
                    <?php endforeach; ?>
                </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-md-1">
            <?php /** @see FicheMetierController::modifierFormationAction() **/ ?>
            <a class="btn btn-default mini ajax-modal"
               data-event="modification"
               href="<?php echo $this->url('fiche-metier-type/modifier-formation', ['id' => $fiche->getId()], [], true); ?>"
            >
                <span class="icon editer"></span>
            </a>
        </div>
        <div class="col-md-11">
            <h3> Formations</h3>
            <ul>
                <?php /** @var Application $application */ ?>
                <?php foreach($fiche->getFormations() as $formation) : ?>
                    <li> <?php echo $formation->getLibelle(); ?> </li>
                <?php endforeach; ?>
            </ul>
        </div>
    </div>
</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });

</script>

<style>
    h2 {
        color: #3c6c8b;
        text-decoration: none;
    }
</style>