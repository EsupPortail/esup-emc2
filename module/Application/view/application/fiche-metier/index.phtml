<?php

use Application\Entity\Db\Domaine;
use Application\Entity\Db\FicheMetier;
use Application\Entity\Db\FicheMetierEtat;
use Application\Entity\Db\Metier;

/**
 * @see \Application\Controller\FicheMetierController::indexAction()
 * @var Domaine[] $domaines
 * @var Domaine $domaineSelect
 * @var FicheMetier[] $fiches
 * @var FicheMetierEtat[] $etats
 * @var Metier[] $metiers
 */

$this->headTitle('Index des fiches métiers');

?>

<h1 class="page-header">
    Fiches métiers
</h1>

<div role="tabpanel">
    <ul class="nav nav-tabs" role="tablist">

        <li role="fiche">
            <a href="#fiche" aria-controls="fiche" role="tab" data-toggle="tabz">
                Fiches métiers &nbsp;
                <span class="badge">
                    <?php echo count($fiches); ?>
                </span>
            </a>
        </li>

        <li role="metier">
            <a href="#metier" aria-controls="metier" role="tab" data-toggle="tabz">
                Fiches métiers &nbsp;
                <span class="badge">
                    <?php echo count($metiers); ?>
                </span>
            </a>
        </li>

        <li role="etat">
            <a href="#etat" aria-controls="etat" role="tab" data-toggle="tabz">
                États &nbsp;
                <span class="badge">
                    <?php echo count($etats); ?>
                </span>
            </a>
        </li>

    </ul>

    <div class="main-with-tab">

        <div class="tab-content">

             <!-- FAMILLE --------------------------------------------------------------------------------------------->
            <div id="fiche" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/fiche-metier.phtml', ['fiches' => $fiches, 'domaines' => $domaines, 'domaineSelect' => $domaineSelect]); ?>
            </div>

            <!-- FAMILLE ---------------------------------------------------------------------------------------------->
            <div id="metier" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/fiche-metier-bis.phtml', ['metiers' => $metiers, 'domaines' => $domaines, 'domaineSelect' => $domaineSelect]); ?>
            </div>

            <!-- DOMAINE ---------------------------------------------------------------------------------------------->
            <div id="etat" class="tab-pane " role="tabpanel">
                <?php echo $this->partial('partial/etat.phtml', ['etats' => $etats]); ?>
            </div>
        </div>
    </div>

</div>


<script>
    $(function() {
        let hash = $(location).attr('hash');
        console.log(hash);
        let name = hash.substr(1);
        console.log(name);
        if (name === undefined || name === "") name = "fiche";

        $('a[aria-controls=' + name + ']').tab('show');

        $('.nav-tabs a').click(function (e) {
            // No e.preventDefault() here
            $(this).tab('show');
        });

    });

    $(document).ready(function() {
        $('#datatable').DataTable( {
            language: {
                url: '/localisation/fr_FR.json'
            }
        } );
    } );

    $(function() {
        $("body").on("creation", function (event) {
            event.div.modal('hide');
            window.location.href = 'fiche-metier-type/editer';
        });
    });

    $(function() {
        $("body").on("destruction", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });

    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.href = 'fiche-metier-type/editer';
        });
    });

    $(function() {
        $("body").on("changer-etat", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });

    $(function() {
        $('select#domaine').on("change", function() {
            let domaine = $('select#domaine').find(":selected").val();
            if (domaine == 0) {
                window.location.href = 'fiche-metier-type';
            } else {
                window.location.href = 'fiche-metier-type?domaine=' + domaine;
            }
        });
    })
</script>