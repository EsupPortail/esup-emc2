<?php

/**
 * @see \Application\Controller\SynchroController::indexAction()
 * @var SynchroJob[] $jobs
 * @var SynchroJob $synchro
 */

use Application\Entity\Db\StructureType;
use Application\Entity\Db\SynchroJob;

$this->headTitle('Synchronisations');

?>

<h1 class="page-header">
    Synchronisation
</h1>

<?php echo $this->messenger()->addMessagesFromFlashMessenger(); ?>

<div class="main">

    <h2> Listes des synchros </h2>

    <?php foreach ($jobs as $job): ?>
        <div class="alert alert-default" style="border-color: gray; background-color: whitesmoke;">
            <h3><?php echo $job->getEntityClass(); ?> </h3>
            <div class="row">
                <div class="col-md-7">

                    <dl class="dl-horizontal">
                        <dt> Table/Clef </dt>
                        <dd> <?php echo $job->getTable(); ?>/<?php echo $job->getKey(); ?></dd>
                        <dt> Entité </dt>
                        <dd> <?php echo $job->getEntityClass(); ?> </dd>
                        <dt> Requête </dt>
                        <dd> <?php echo $job->getUrl(); ?></dd>
                    </dl>

                    <?php
                        $wsa = explode(",",$job->getWsAttributes());
                        $dba = explode(",",$job->getDbAttributes());
                        $ena = explode(",",$job->getEnAttributes());
                        $nbCopy = count($wsa);
                    ?>
                    <table class="synchro">
                        <thead>
                            <tr>
                                <th> WebService </th>
                                <th> Base de données </th>
                                <th> Entité </th>
                            </tr>
                        </thead>
                        <tbody>
                        <?php for ($position = 0 ; $position < $nbCopy; $position++) : ?>
                            <tr>
                                <td>
                                    <?php echo $wsa[$position]; ?>
                                </td>
                                <td>
                                    <?php echo $dba[$position]; ?>
                                </td>
                                <td>
                                    <?php echo $ena[$position]; ?>
                                </td>
                            </tr>
                        <?php endfor; ?>
                        </tbody>
                    </table>
                </div>

                <div class="col-md-5">
                    <a
                        <?php /** @see \Application\Controller\SynchroController::synchroniserAction() */?>
                        href="<?php echo $this->url('synchro/synchroniser', ['key' => $job->getKey()], [], true); ?>"
                        class="btn btn-primary action pull-right"
                    >
                        <span class="icon synchoniser"></span> Synchroniser </a>


                    <br/>
                    <br/>
                    <br/>

                    <?php $log = $job->getDernierLog(); ?>
                    <div class="alert alert-info">
                        <?php if ($log !== null) : ?>
                            <?php echo $log; ?>
                        <?php else : ?>
                            Aucune synchronisation de faite !
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    <?php endforeach; ?>


</div>

<style>
    table.synchro{
        border:black solid 1px;
        collapse: true;
    }

    table.synchro th{
        border:black solid 1px;
        background-color: lightgoldenrodyellow;
        width: 33%;
        text-align: center;
        margin: 1rem;
        padding: 1rem;

    }

    table.synchro td{
        border:black solid 1px;
        background-color: white;
        font-family: monospace;
        padding-left: 0.5rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }
</style>