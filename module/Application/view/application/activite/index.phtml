<?php

/**
 * @var Activite[] $activites
 */

use Application\Entity\Db\Activite;
use Application\Provider\Privilege\ActivitePrivileges;

$this->headTitle('Missions principales');

$canVisualiser  = $this->isAllowed(ActivitePrivileges::getResourceId(ActivitePrivileges::AFFICHER));
$canAjouter     = $this->isAllowed(ActivitePrivileges::getResourceId(ActivitePrivileges::AJOUTER));
$canEditer      = $this->isAllowed(ActivitePrivileges::getResourceId(ActivitePrivileges::EDITER));
$canHistoriser  = $this->isAllowed(ActivitePrivileges::getResourceId(ActivitePrivileges::EDITER));
$canEffacer     = $this->isAllowed(ActivitePrivileges::getResourceId(ActivitePrivileges::EFFACER));
?>

<h1 class="page-header">
    Missions principales
    <span class="badge"> <?php echo count($activites); ?> </span>
</h1>

<div class="main">

    <?php if ($canAjouter) : ?>
        <a href="<?php echo $this->url('activite/creer', [], [], true); ?>"
           class="btn btn-primary action ajax-modal"
           data-event="modification">
            <span class="icon ajouter"></span>
            Ajouter une mission principale
        </a>
        <br/><br/>
    <?php endif; ?>

    <table id="datatable" class="table table-condensed">
        <thead>
            <tr>
                <th> Mission </th>
                <th> Modification </th>
                <th style="width:10rem;"> Action </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach($activites as $activite) : ?>
                <tr>
                    <td>
                        <?php echo $activite->getLibelle(); ?> <br/>
                    </td>
<!--                    <td>-->
<!--                        <small>-->
<!--                            <ul>-->
<!--                            --><?php //foreach ($activite->getApplications() as $application) : ?>
<!--                                <li> --><?php //echo $application->getLibelle(); ?><!--</li>-->
<!--                            --><?php //endforeach; ?>
<!--                            </ul>-->
<!--                        </small>-->
<!--                    </td>-->
                    <td>
                        <small>
                            <?php echo $activite->getHistoModification()->format('d/m/Y'); ?> <br/>
                            <?php echo $activite->getHistoModificateur()->getDisplayName(); ?>
                        </small>
                    </td>
                    <td>
                        <?php if ($canVisualiser) : ?>
                            <a href="<?php echo $this->url('activite/afficher', ['activite' => $activite->getId()], [], true); ?>"
                               class="ajax-modal"
                            >
                                <span class="icon voir" title="Voir l'activité"></span></a>
                        <?php else : ?>
                                <span class="icon voir" style="color:lightgrey;"></span>
                        <?php endif; ?>
                        <?php if ($canEditer) : ?>
                            <a href="<?php echo $this->url('activite/editer', ['activite' => $activite->getId()], [], true); ?>"
                               class="ajax-modal"
                               data-event="modification"
                            >
                                <span class="icon editer" title="Modifier l'activité"></span></a>
                            <a href="<?php echo $this->url('activite/modifier', ['activite' => $activite->getId()], [], true); ?>"
                               class="ajax-modal"
                               data-event="modification"
                            >
                                <span class="icon ajouter" title="Modifier l'activite "></span></a>
                            <a href="<?php echo $this->url('activite/convert', ['activite' => $activite->getId()], [], true); ?>"
                               class="ajax-modal"
                               data-event="modification"
                            >
                                <span class="icon information" title="Convertir les sous-activités"></span></a>
                        <?php else : ?>
                            <span class="icon editer" style="color:lightgrey;"></span>
                        <?php endif; ?>
                        <?php if($canHistoriser) :?>
                            <?php if($activite->estNonHistorise()): ?>
                                <a href="<?php echo $this->url('activite/historiser', ['activite' => $activite->getId()], [], true); ?>"
                                >
                                    <span class="icon historiser" title="Historiser l'activité"></span></a>
                            <?php else : ?>
                                <a href="<?php echo $this->url('activite/restaurer', ['activite' => $activite->getId()], [], true); ?>"
                                >
                                    <span class="icon restaurer" title="Restaurer l'activité"></span></a>
                            <?php endif; ?>
                        <?php else : ?>
                            <?php if($activite->estNonHistorise()): ?>
                                    <span class="icon historiser" style="color:lightgrey;"></span>
                            <?php else : ?>
                                    <span class="icon restaurer" style="color:lightgrey;"></span>
                            <?php endif; ?>
                        <?php endif; ?>
                        <?php if ($canEffacer) : ?>
                            <a href="<?php echo $this->url('activite/detruire', ['activite' => $activite->getId()], [], true); ?>">
                                <span class="icon detruire"  title="Supprimer l'activité"></span></a>
                        <?php else : ?>
                            <span class="icon detruire" style="color:lightgrey;"></span>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function() {
        $('#datatable').DataTable( {
            language: {
                url: '/localisation/fr_FR.json'
            }
        });
    } );

    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>
