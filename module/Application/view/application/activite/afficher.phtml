<?php

use Application\Entity\Db\Activite;
use Application\Entity\Db\FicheMetierTypeActivite;
use Application\Provider\Privilege\ActivitePrivileges;

/**
 * @see \Application\Controller\ActiviteController::afficherAction()
 * @see \Application\Controller\ActiviteController::modifierAction()
 * @var Activite $activite
 * @var string $mode
 */

$canModifierEnveloppe = $this->isAllowed(ActivitePrivileges::getResourceId(ActivitePrivileges::ACTIVITE_MODIFIER));

$action = ($mode === 'modifier-activite')?"Modification":"Affichage";
$titre = $action . " de la mission ";
$this->headTitle($titre  . " : " .$activite->getCurrentActiviteLibelle()->getLibelle());
?>

<?php if ($mode === 'modifier-activite') : ?>
    <h1 class="page-header">
        <?php echo $titre; ?> <br/>
        <strong>  <?php echo $activite->getCurrentActiviteLibelle()->getLibelle(); ?> </strong>
    </h1>
<?php endif; ?>

<div class="main">

<?php echo $this->activite($activite, $mode); ?>

<?php
    /** @var FicheMetierTypeActivite[] $ficheMetiers */
    $ficheMetiers = $activite->getFichesMetiers()->toArray();
?>

<h2> Enveloppe de niveaux associé </h2>

<?php echo $this->niveauEnveloppe($activite->getNiveaux()); ?>
<?php if ($canModifierEnveloppe) : ?>
    <?php if ($activite->getNiveaux() === null) : ?>
        <?php /** @see \Application\Controller\ActiviteController::ajouterNiveauxAction() */ ?>
        <a href="<?php echo $this->url('activite/ajouter-niveaux', ['activite' => $activite->getId()], [], true); ?>"
           class="ajax-modal" data-event="modification">
        <span class="icon ajouter"></span></a>
    <?php else : ?>
        <?php /** @see \Application\Controller\ActiviteController::modifierNiveauxAction() */ ?>
        <a href="<?php echo $this->url('activite/modifier-niveaux', ['activite' => $activite->getId()], [], true); ?>"
           class="ajax-modal" data-event="modification">
            <span class="icon editer"></span></a>
        <?php /** @see \Application\Controller\ActiviteController::retirerNiveauxAction() */ ?>
        <a href="<?php echo $this->url('activite/retirer-niveaux', ['activite' => $activite->getId()], [], true); ?>"
           >
            <span class="icon detruire"></span></a>
    <?php endif; ?>
<?php endif; ?>

<h2>
    Fiches métiers associées
    <span class="badge">
        <?php echo  count($ficheMetiers); ?>
    </span>
</h2>

<ul>
    <?php foreach ($ficheMetiers as $ficheMetier) : ?>
        <li> <?php echo $ficheMetier->getFiche()->getMetier()->getLibelle(); ?> </li>
    <?php endforeach; ?>
</ul>
</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            tinyMCE.editors=[];
            window.location.reload();
        });
    });
</script>