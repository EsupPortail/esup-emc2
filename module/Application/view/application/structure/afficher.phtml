<?php

/**
 * @see StructureController::afficherAction()
 * @var Structure[] $selecteur
 * @var Structure $structure
 * @var Structure[] $filles
 * @var AgentMissionSpecifique[] $missions
 * @var FichePoste[] $fichesCompletes
 * @var FichePoste[] $fichesIncompletes
 * @var Poste[] $postes
 * @var Agent[] $agents
 */

use Application\Entity\Db\Agent;
use Application\Entity\Db\AgentMissionSpecifique;
use Application\Entity\Db\FichePoste;
use Application\Entity\Db\Poste;
use Application\Entity\Db\Structure;
use Application\Provider\Privilege\StructurePrivileges;

$this->headTitle($structure->getLibelleLong());

$canAfficherStructure   = $this->isAllowed($structure, StructurePrivileges::STRUCTURE_AFFICHER);

?>

<div class="row">
    <div class="col-md-8">
        <h1 class="page-header">
            <strong> <?php echo $structure->getLibelleLong(); ?> </strong> <br/>
            <?php echo $structure->getType(); ?>
        </h1>
    </div>
    <div class="col-md-4">
        <br/>
        <br/>
        <br/>
        <?php if (! empty($selecteur)) : ?>
            <label for="structure-selecteur">Structure à afficher : <br/></label>
            <select id="structure-selecteur" name="structure-selecteur" class="bootstrap-select">
                <option value="">Aucune sélection</option>
                <?php foreach ($selecteur as $s) : ?>
                    <option value="<?php echo $s->getId(); ?>" <?php if ($structure->getId() == $s->getId()) echo "selected"; ?>><?php echo $s->getLibelleCourt(); ?></option>
                <?php endforeach; ?>
            </select>

        <?php endif; ?>
    </div>
</div>

<?php if (! $canAfficherStructure) : ?>

    <div class="alert alert-danger col-md-8">
        <p class="lead">
            <span class="icon attention"></span>
            Vous n'êtes pas habilité&middot;e à visualiser cette structure.
        </p>
    </div>

<?php else : ?>

    <div class="main">

        <?php echo $this->partial('partial/resume', ['structure' => $structure, 'filles' => $filles]); ?>

        <?php echo $this->partial('partial/missions-specifiques', ['structure' => $structure, 'missions' => $missions]); ?>

        <?php echo $this->partial('partial/fiches-postes', ['fichesCompletes' => $fichesCompletes, 'fichesIncompletes' => $fichesIncompletes]); ?>

        <?php echo $this->partial('partial/agents', ['structure' => $structure, 'agents' => $agents]); ?>
        <?php //echo $this->partial('partial/postes', ['postes' => $postes]); ?>

    </div>
<?php endif; ?>

<script>
    $(function() {
        $('select#structure-selecteur').change(function() {
            let id = $('select#structure-selecteur option:selected').val();
            if (id !== "" && id !== "<?php echo $structure->getId(); ?>") {
                window.location.href = './' + id;
            }
        });
    });

    $("body").on("modification", function (event) {
        event.div.modal('hide');
        window.location.reload();
    });

    $(function() {
        $("body").on("duplication", function (event) {
            let content = event.div.html();
            let match_regex = content.match(/#[0-9]*/g)[0];
            let id = match_regex.split('#')[1];
            event.div.modal('hide');
            let win = window.open('../../fiche-poste/editer/' + id + '?structure=' + <?php echo ($structure)?$structure->getId():0; ?>, '_blank');
            if (win) {
                //Browser has allowed it to be opened
                win.focus();
            } else {
                //Browser has blocked it
                alert('Please allow popups for this website');
            }
            console.log("fiche-de-poste: " + id);
            window.location.reload();
        });
    });
    // $('select').selectpicker();
</script>
