<?php

/**
 * @see StructureController::afficherAction()
 * @var Structure[] $selecteur
 * @var Structure $structure
 * @var Structure[] $filles
 * @var AgentMissionSpecifique[] $missions
 * @var FichePoste[] $fichesCompletes
 * @var FichePoste[] $fichesIncompletes
 * @var Poste[] $postes
 * @var Agent[] $agents
 */

use Application\Entity\Db\Agent;
use Application\Entity\Db\AgentMissionSpecifique;
use Application\Entity\Db\FichePoste;
use Application\Entity\Db\Poste;
use Application\Entity\Db\Structure;
use Application\Provider\Privilege\AgentPrivileges;
use Application\Provider\Privilege\FichePostePrivileges;

$this->headTitle("Affichage de la structure : " . $structure->getLibelleLong());

$canAfficheAffectation = true;

$canVoirAgent = $this->isAllowed(AgentPrivileges::getResourceId(AgentPrivileges::AGENT_AFFICHER));
$canVoirFichePoste          = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::AFFICHER));
$canAjouterFichePoste       = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::AJOUTER));
$canModifierFichePoste      = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::EDITER));
$canHistoriserFichePoste    = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::HISTORISER));
$canDetruireFichePoste      = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::DETRUIRE));
?>

<div class="row">
    <div class="col-md-8">
        <h1 class="page-header">
            <strong> <?php echo $structure->getLibelleLong(); ?> </strong> <br/>
            <?php echo $structure->getType(); ?>
        </h1>
    </div>
    <div class="col-md-4">
        <br/>
        <br/>
        <br/>
        <?php if (! empty($selecteur)) : ?>
            <label for="structure-selecteur">Structure à afficher : <br/></label>
            <select id="structure-selecteur" name="structure-selecteur" class="bootstrap-select">
                <option value="">Aucune sélection</option>
                <?php foreach ($selecteur as $s) : ?>
                    <option value="<?php echo $s->getId(); ?>" <?php if ($structure->getId() == $s->getId()) echo "selected"; ?>><?php echo $s->getLibelleCourt(); ?></option>
                <?php endforeach; ?>
            </select>

        <?php endif; ?>
    </div>
</div>

<div class="main">

    <?php echo $this->partial('partial/resume', ['structure' => $structure, 'filles' => $filles]); ?>

    <?php echo $this->partial('partial/missions-specifiques', ['structure' => $structure, 'missions' => $missions]); ?>

    <?php echo $this->partial('partial/fiches-postes', ['fichesCompletes' => $fichesCompletes, 'fichesIncompletes' => $fichesIncompletes]); ?>



    <div class="row">
        <div class="col-md-6">
            <h2>
                Agents
                <span class="badge">
                    <?php echo count($agents); ?>
                </span>
            </h2>

            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th>Dénomination</th>
                        <th>Grade</th>
                        <th>Poste</th>
                        <th>Fiche</th>
                        <th class="cell-action"> Action </th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($agents as $agent) :?>
                        <tr>
                            <td>
                                <?php if ($canVoirAgent) : ?>
                                    <a
                                        <?php /** @see \Application\Controller\AgentController::afficherAction() */?>
                                        href="<?php echo $this->url('agent/afficher', ['id' => $agent->getId()], [], true); ?>"
                                        target="_blank"
                                    >
                                    <?php echo $agent->getDenomination(); ?></a>
                                <?php else : ?>
                                    <?php echo $agent->getDenomination(); ?>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php foreach ($agent->getGradesActifs() as $grade) : ?>
                                    <?php echo $grade->getStructure()->getLibelleCourt(); ?> <br/>
                                    <?php echo $grade->getGrade()->getLibelleCourt(); ?>
                                <?php endforeach; ?>
                            </td>
                            <td>
                                <?php $posteA = $agent->getPosteActif(); ?>
                                <?php if ($posteA != null ) : ?>
                                    <span
                                        class="icon ok" style="color:darkgreen;"
                                        data-toggle="tooltip" data-html="true"
                                        title="<?php echo $posteA->getNumeroPoste(); ?>"
                                    >

                                    </span>
                                <?php else : ?>
                                    <span class="icon ko" style="color:darkred;"></span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php $fiche = $agent->getFichePosteActif(); ?>
                                <?php if ($fiche !== null) : ?>
                                    <?php if ($fiche->isComplete()) : ?>
                                        <span
                                            class="icon ok" style="color:darkgreen;"
                                            data-toggle="tooltip" data-html="true"
                                            title="<?php echo $fiche->getLibelleMetierPrincipal(); ?>"
                                        >

                                        </span>
                                    <?php else: ?>
                                <span
                                    class="icon question" style="color:orangered;"
                                    data-toggle="tooltip" data-html="true"
                                    title="Fiche incomplète"
                                >
                                    <?php endif; ?>
                                <?php else : ?>
                                    <span class="icon ko" style="color:darkred;"></span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if($fiche === null) : ?>
                                    <?php if ($canAjouterFichePoste) : ?>
                                        <a
                                            <?php /** @see \Application\Controller\FichePosteController::afficherAction() */ ?>
                                            href="<?php echo $this->url('fiche-poste/ajouter', ['agent' => $agent->getId()], [], true); ?>"
                                            target="_blank"
                                        ><span class="icon ajouter"
                                               data-toggle="tooltip" data-html="true"
                                               title="Ajouter la fiche de poste"></span></a>
                                    <?php endif; ?>
                                    <?php if ($canAjouterFichePoste) : ?>
                                        <a
                                            <?php /** @see \Application\Controller\FichePosteController::dupliquerAction() */ ?>
                                            href="<?php echo $this->url('fiche-poste/dupliquer', ['structure' => $structure->getId(), 'agent' => $agent->getId()], [], true); ?>"
                                            class="ajax-modal" data-event="duplication"
                                        ><span class="icon cloner"
                                               data-toggle="tooltip" data-html="true"
                                               title="Dupliquer une fiche existante"></span></a>
                                    <?php endif; ?>
                                <?php else  :?>
                                    <?php if ($canVoirFichePoste) : ?>
                                        <a
                                            <?php /** @see \Application\Controller\FichePosteController::afficherAction() */ ?>
                                                href="<?php echo $this->url('fiche-poste/afficher', ['fiche-poste' => $fiche->getId()], [], true); ?>"
                                                target="_blank"
                                        ><span class="icon voir"
                                               data-toggle="tooltip" data-html="true"
                                               title="Afficher la fiche de poste"></span></a>
                                    <?php endif; ?>

                                    <?php if ($canModifierFichePoste) : ?>
                                        <a
                                            <?php /** @see \Application\Controller\FichePosteController::editerAction() */ ?>
                                                href="<?php echo $this->url('fiche-poste/editer', ['fiche-poste' => $fiche->getId()], [], true); ?>"
                                                target="_blank"
                                        ><span class="icon editer"
                                               data-toggle="tooltip" data-html="true"
                                               title="Modifier la fiche de poste"></span></a>
                                    <?php endif; ?>

                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>

            </table>
        </div>
        <div class="col-md-6">
            <h2>
                Postes
                <span class="badge">
                    <?php echo count($postes); ?>
                </span>
            </h2>
            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th>Numéro</th>
                        <th>Structure</th>
                        <th>Description</th>
                        <th>Agent</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($postes as $poste) : ?>
                        <tr>
                            <td> <?php echo $poste->getNumeroPoste(); ?> </td>
                            <td> <?php echo $poste->getStructure()->getLibelleCourt(); ?> </td>
                            <td>
                                    <?php echo $poste->getDomaine()->getLibelle(); ?> <br/>
                                    <?php echo $poste->getFonction(); ?>
                            </td>
                            <td>
                                <?php
                                    $fiche = $poste->getFichePoste();
                                    $agent = ($fiche)?$fiche->getAgent():null;
                                ?>
                                <?php if ($agent) : ?>
                                    <span
                                            class="icon ok" style="color: darkgreen;"
                                            data-toggle="tooltip" data-html="true"
                                            title="Occupé par <span class='user'><?php echo $agent->getDenomination(); ?></span>"
                                    ></span>
                                <?php else: ?>
                                    <span class="icon ko" style="color: darkred;"></span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

        </div>
    </div>

</div>

<script>
    $(function() {
        $('select#structure-selecteur').change(function() {
            let id = $('select#structure-selecteur option:selected').val();
            if (id !== "" && id !== "<?php echo $structure->getId(); ?>") {
                window.location.href = './' + id;
            }
        });
    });

    $("body").on("modification", function (event) {
        event.div.modal('hide');
        window.location.reload();
    });

    $(function() {
        $("body").on("duplication", function (event) {
            let content = event.div.html();
            let match_regex = content.match(/#[0-9]*/g)[0];
            let id = match_regex.split('#')[1];
            event.div.modal('hide');
            let win = window.open('../../fiche-poste/editer/' + id + '?structure=' + <?php echo ($structure)?$structure->getId():0; ?>, '_blank');
            if (win) {
                //Browser has allowed it to be opened
                win.focus();
            } else {
                //Browser has blocked it
                alert('Please allow popups for this website');
            }
            console.log("fiche-de-poste: " + id);
            window.location.reload();
        });
    });
    // $('select').selectpicker();
</script>
