<?php

use Application\Provider\Privilege\StructurePrivileges;
use UnicaenUtilisateur\Entity\Db\Role;
use UnicaenUtilisateur\Entity\Db\User;

$this->headTitle("Index des structures");

/**
 * @var Application\Entity\Db\Structure[] $structures
 * @var User $user
 * @var Role $role
 */

$canAfficher    = $this->isAllowed(StructurePrivileges::getResourceId(StructurePrivileges::STRUCTURE_AFFICHER));

?>

<div class="row">
    <div class="col-md-6">
        <h1 class="page-header">
            Structures
            <span class="badge">
                <?php echo count($structures); ?>
            </span>
            <?php echo $this->synchroniserIcon(); ?>
        </h1>
    </div>
</div>
<div class="main">
<!--    <div class="row">-->
<!--        <a  href="--><?php //echo $this->url('structure/graphe', [], [], true); ?><!--"-->
<!--            class="btn btn-warning"-->
<!--        >-->
<!--            Générer le graphe des structures</a>-->
<!--    </div>-->

    <table id="structures" class="datatable table table-condensed">
        <thead>
            <tr>
                <th> Libellé court </th>
                <th> Type </th>
                <th> Code </th>
                <th> Gestionnaire </th>
                <th> Action </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($structures as $structure) : ?>
                <tr>
                    <td>
                        <abbr title="<?php echo $structure->getLibelleLong(); ?>">
                            <?php echo $structure->getLibelleCourt(); ?>
                        </abbr>
                        <?php if ($structure->getFermeture() !== null) : ?>
                            <span class="ferme" title="<?php echo $structure->getFermeture()->format('d/m/Y'); ?>">
                                Fermée
                            </span>
                        <?php endif; ?>
                    </td>
                    <td> <?php echo $structure->getType(); ?> </td>
                    <td> <?php echo $structure->getCode(); ?> </td>
                    <td>
                        <?php if (count($structure->getGestionnaires())) : ?>
                            <?php
                            $text = "";
                            $gestionnaires = $structure->getGestionnaires();
                            usort($gestionnaires, function(User $a, User $b) {return $a->getDisplayName()>$b->getDisplayName();});
                            foreach ($structure->getGestionnaires() as $gestionnaire) $text .= $gestionnaire->getDisplayName()."\n";
                            ?>
                            <span title="<?php echo $text; ?>">
                                <?php echo count($structure->getGestionnaires()); ?>
                                <i class="fas fa-user"></i>
                            </span>
                        <?php else : ?>
                            <strong style="color:darkred;">Aucun</strong>
                        <?php endif; ?>
                    </td>
                    <td>
                        <?php if ($canAfficher) : ?>
                            <a
                                    href="<?php echo $this->url('structure/afficher', ['structure' => $structure->getId()], [], true); ?>"
                            >
                                <span class="icon voir"   title="Afficher la structure"></span></a>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>


<script>
    let loaded = false;

    $(document).ready(function() {
        var table = $('#structures').DataTable({
            "paging": false
        });
        let searchParams = new URLSearchParams(window.location.search);
        let param = searchParams.get('search')
        if (param !== null) {
            table.search(param);
            table.draw();
        }
        loaded = true;
    });

    $(document).on('search.dt', function () {
        if (loaded === true) {
            let valeur = $('input').val();
            console.log(valeur);
            history.replaceState({}, null, '?search=' + valeur);
        }
    });

    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });

</script>

