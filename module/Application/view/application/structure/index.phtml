<?php

use Application\Provider\Privilege\StructurePrivileges;
use UnicaenUtilisateur\Entity\Db\Role;
use UnicaenUtilisateur\Entity\Db\User;

$this->headTitle("Index des structures");

/**
 * @var Application\Entity\Db\Structure[] $structures
 * @var User $user
 * @var Role $role
 */

$canAfficher    = $this->isAllowed(StructurePrivileges::getResourceId(StructurePrivileges::AFFICHER));
$canGestionnaire    = $this->isAllowed(StructurePrivileges::getResourceId(StructurePrivileges::GESTIONNAIRE));
$canEditer    = $this->isAllowed(StructurePrivileges::getResourceId(StructurePrivileges::EDITER));
?>

<div class="row">
    <div class="col-md-6">
        <h1 class="page-header">
            Structures
            <span class="badge">
                <?php echo count($structures); ?>
            </span>
        </h1>
    </div>
    <br/>
    <div class="pull-right col-md-5 alert alert-info">
        <span class="icon synchoniser"></span>
        Les structures sont synchronisées depuis Octopus.
    </div>
</div>
<div class="main">
    <div class="row">
        <a  href="<?php echo $this->url('structure/graphe', [], [], true); ?>"
            class="btn btn-warning"
        >
            Générer le graphe des structures</a>
    </div>

    </a>

    <table id="structures" class="table table-condensed">
        <thead>
            <tr>
                <th> Libellé court </th>
                <th> Type </th>
                <th> Code </th>
                <th> Gestionnaire </th>
                <th> Action </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($structures as $structure) : ?>
                <tr>
                    <td>
                        <?php echo $structure->getLibelleCourt(); ?>
                        <?php if ($structure->getLibelleLong()): ?>
                            <sup><span class="icon information" title="<?php echo $structure->getLibelleLong(); ?>"></span></sup>
                        <?php endif; ?>
                    </td>
                    <td> <?php echo $structure->getType(); ?> </td>
                    <td> <?php echo $structure->getCode(); ?> </td>
                    <td>
                        <?php if (count($structure->getGestionnaires())) : ?>
                            <?php
                            $text = "";
                            $gestionnaires = $structure->getGestionnaires();
                            usort($gestionnaires, function(User $a, User $b) {return $a->getDisplayName()>$b->getDisplayName();});
                            foreach ($structure->getGestionnaires() as $gestionnaire) $text .= $gestionnaire->getDisplayName()."\n";
                            ?>
                            <span title="<?php echo $text; ?>">
                                <?php echo count($structure->getGestionnaires()); ?>
                                <i class="fas fa-user"></i>
                            </span>
                        <?php else : ?>
                            <strong style="color:darkred;">Aucun</strong>
                        <?php endif; ?>
                    </td>
                    <td>
                        <?php if ($canAfficher) : ?>
                            <a
                                    href="<?php echo $this->url('structure/afficher', ['structure' => $structure->getId()], [], true); ?>"
                            >
                                <span class="icon voir"   title="Afficher la structure"></span></a>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>


<script>
    $(document).ready(function() {
        $('#structures').DataTable( {
            language: {
                url: '/localisation/fr_FR.json'
            }
        } );
    } );

    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>

