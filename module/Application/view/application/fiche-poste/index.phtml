<?php

use Application\Entity\Db\FichePoste;
use Application\Provider\Privilege\FichePostePrivileges;

/**
 * @var FichePoste[] $fiches
 */

$this->headTitle('Index des fiches de postes');

$canAjouter     = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::AJOUTER));
$canVoir        = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::AFFICHER));
$canHistoriser  = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::HISTORISER));
$canEditer      = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::EDITER));
$canDetruire    = $this->isAllowed(FichePostePrivileges::getResourceId(FichePostePrivileges::EDITER));
?>

<h1 class="page-header">
    Fiches de poste
    <span class="badge">
        <?php echo count($fiches); ?>
    </span>
</h1>

<div class="main">

    <?php if ($canAjouter) : ?>
        <a href="<?php echo $this->url('fiche-poste/ajouter', [], [], true); ?>" class="btn btn-primary ajax-modal" data-event="modification">
            <span class="icon ajouter"></span>
            Ajouter une fiche de poste
        </a>
    <?php endif; ?>

    <table class="table table-condensed">
        <thead>
            <tr>
                <th> Libellé </th>
                <th> Métier principal </th>
                <th> Modification </th>
                <th> Modificateur </th>
                <th> Action </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($fiches as $fiche) : ?>
                <tr>
                    <td> <?php echo $fiche->getLibelle(); ?> </td>
                    <td>
                        <?php $principale = $fiche->getFicheTypeExternePrincipale();
                         if($principale === null) : ?>
                            Aucune fiche principale
                        <?php else : ?>
                            <?php echo $principale->getFicheType()->getMetier()->getLibelle(); ?>
                        <?php endif; ?>
                    </td>
                    <td> <?php echo $fiche->getHistoModification()->format('d/m/Y'); ?> </td>
                    <td> <?php echo $fiche->getHistoModificateur()->getDisplayName(); ?> </td>
                    <td>
                        <?php if ($canVoir) : ?>
                            <a href="<?php echo $this->url('fiche-poste/afficher', ['fiche-poste' => $fiche->getId()], [], true); ?>"
                              class="ajax-modal">
                                <span class="icon voir" title="Visualiser la fiche de poste"></span></a>
                        <?php endif; ?>
                        <?php if ($canVoir) : ?>
                            <a href="<?php echo $this->url('fiche-poste/export', ['fiche-poste' => $fiche->getId()], [], true); ?>"
                               title="Exporter en PDF la fiche de poste"
                            >
                                <span class="icon pdf"></span></a>
                        <?php endif; ?>
                        <?php if ($canEditer) : ?>
                            <a href="<?php echo $this->url('fiche-poste/editer', ['fiche-poste' => $fiche->getId()], [], true); ?>">
                                <span class="icon editer" title="Éditer la fiche de poste"></span></a>
                        <?php endif; ?>
                        <?php if ($canHistoriser) : ?>
                            <?php if ($fiche->estNonHistorise()) : ?>
                                <a href="<?php echo $this->url('fiche-poste/historiser', ['fiche-poste' => $fiche->getId()], [], true); ?>">
                                    <span class="icon historiser" title="Historiser la fiche de poste"></span></a>
                            <?php else: ?>
                                <a href="<?php echo $this->url('fiche-poste/restaurer', ['fiche-poste' => $fiche->getId()], [], true); ?>">
                                    <span class="icon restaurer" title="Restaurer la fiche de poste"></span></a>
                            <?php endif; ?>
                        <?php endif; ?>
                        <?php if ($canDetruire) : ?>
                            <a href="<?php echo $this->url('fiche-poste/detruire', ['fiche-poste' => $fiche->getId()], [], true); ?>">
                                <span class="icon detruire" title="Détruire la fiche de poste"></span></a>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>


<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.href = 'fiche-poste/editer';
        });
    });
</script>
