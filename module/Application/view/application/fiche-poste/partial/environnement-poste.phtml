<?php

use Agent\Entity\Db\AgentAffectation;
use Application\Entity\Db\Agent;
use Application\Entity\Db\FichePoste;
use Application\Provider\Privilege\FichePostePrivileges;
use FichePoste\Provider\Validation\FichePosteValidations;
use Structure\Entity\Db\Structure;

/**
 * @var FichePoste $fiche
 * @var Agent $agent
 * @var string $mode
 */

$canModifier = $this->isAllowed($fiche, FichePostePrivileges::FICHEPOSTE_MODIFIER);

//todo recup date de validation
$date = new DateTime();
$validation = $fiche->getValidationActiveByTypeCode(FichePosteValidations::VALIDATION_RESPONSABLE);
if ($validation !== null) $date = $validation->getHistoCreation();

$structures = [];
if ($agent !== null) {
    $affectations = $agent->getAffectationsActifs($date);
    $affectations = array_filter($affectations, function (AgentAffectation $a) {
        return $a->isPrincipale();
    });
    $structures = array_map(function (AgentAffectation $a) {
        return $a->getStructure();
    }, $affectations);
    $structures = array_filter($structures, function (Structure $s) use ($date) {
        return $s->isOuverte($date);
    });
}
?>

<div class="card panel-info">
    <div class="card-header">
        <div class="row">
            <div class="col-md-6">
                <h2> Environnement du poste de travail </h2>
            </div>
        </div>
    </div>
    <div class="card-body">
        <?php if (empty($structures)) : ?>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Aucune structure.
            </div>
        <?php else: ?>
            <?php foreach ($structures as $structure) : ?>
                <h4> <?php echo $structure->getLibelleLong(); ?> </h4>

                <?php if ($structure->getDescriptionComplete() !== null) : ?>
                    <?php echo $structure->getDescriptionComplete(); ?>
                <?php else: ?>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Aucune description de fournie pour l'affectation
                        <em><?php echo $structure->getLibelleCourt(); ?></em>.
                    </div>
                <?php endif; ?>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
</div>