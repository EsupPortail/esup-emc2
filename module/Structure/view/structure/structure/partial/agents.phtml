<?php

/**
 * @var Structure $structure
 * @var Agent[] $agents
 * @var array $options
 */

use Application\Entity\Db\Agent;
use Application\Entity\Db\Complement;
use Application\Entity\Db\FichePoste;
use Application\Provider\Privilege\AgentPrivileges;
use Structure\Entity\Db\Structure;
use Structure\Provider\Privilege\StructurePrivileges;

$canVoirAgent = $this->isAllowed(AgentPrivileges::getResourceId(AgentPrivileges::AGENT_AFFICHER));
$canAjouterAgentForce       = $this->isAllowed($structure, StructurePrivileges::STRUCTURE_AGENT_FORCE);
$canRetirerAgentForce       = $canAjouterAgentForce;

$canComplement              =
    $this->isAllowed(StructurePrivileges::getResourceId(StructurePrivileges::STRUCTURE_COMPLEMENT_AGENT))
    AND $this->isAllowed($structure,StructurePrivileges::STRUCTURE_COMPLEMENT_AGENT);

$isForce = (isset($options['force']) AND $options['force'] === true);

?>

<table class="datatable table table-condensed" style="font-size: 14px;">
    <thead>
        <tr>
            <th> Dénomination</th>
            <th> Structures fines</th>
            <th> Supérieur&middot;e hiérarchique direct&middot;e </th>
            <th> Autorité hiérarchique </th>
            <th style="width:5rem; min-width: 5rem;"> Action </th>
        </tr>
    </thead>
    <tbody>
    <?php foreach ($agents as $agent) :?>
        <?php
            $structureAgent =  ($agent->getAffectationPrincipale())?$agent->getAffectationPrincipale()->getStructure():null;
            $niveau2   =  ($structureAgent AND $structureAgent->getNiv2())?$structureAgent->getNiv2():null;
        ?>
        <tr>
            <td>
                <?php if ($canVoirAgent) : ?>
                    <a
                        <?php /** @see \Application\Controller\AgentController::afficherAction() */?>
                        href="<?php echo $this->url('agent/afficher', ['agent' => $agent->getId()], [], true); ?>"
                        target="_blank"
                        title="Voir les renseignements de <span class='highlight agent'><?php echo $agent->getDenomination(); ?></span>" data-toggle="tooltip" data-html="true"
                    >
                        <?php echo $agent->getDenomination(); ?></a>
                <?php else : ?>
                    <?php echo $agent->getDenomination(); ?>
                <?php endif; ?>
            </td>
            <td>
                <!-- STRUCTURE --------------------------------------------------------------------------------------->
                <?php if ($structureAgent) : ?>
                    <span class="icon application" title="Déterminé par EMC2"></span>
                    <?php echo $structureAgent->getLibelleCourt(); ?><br/>
                <?php else : ?>
                    Pas de structure fines<br/>
                <?php endif ?>
                <?php foreach ($agent->getComplementsByType(Complement::COMPLEMENT_TYPE_STRUCTURE) as $complement) : ?>
                    <span class="icon formation" title="Manuellement indiqué"></span>
                    <?php echo $this->complement($complement); ?>
                    <?php if ($canComplement) : ?>
                        <a href="<?php echo $this->url('complement/modifier', ['complement' => $complement->getId()], [], true); ?>" class="ajax-modal" data-event="modification"><span class="icon editer"></span></a>
                        <a href="<?php echo $this->url('complement/supprimer', ['complement' => $complement->getId()], [], true); ?>" class="ajax-modal" data-event="modification"><span class="icon detruire"></span></a>
                    <?php endif; ?>
                    <br/>
                <?php endforeach; ?>
                <?php if ($canComplement) : ?>
                    <a href="<?php echo $this->url('complement/ajouter', ['type' => Complement::COMPLEMENT_TYPE_STRUCTURE, 'attachmenttype' => Agent::class, 'attachmentid' => $agent->getId()], [], true); ?>" class="ajax-modal" data-event="modification">
                        <span class="icon ajouter"></span> Ajouter une structure
                    </a>
                <?php endif; ?>
            </td>
            <td> <!-- RESPONSABLE HIERARCHIQUE ------------------------------------------------------------------------>
                <?php if ($structureAgent) : ?>
                    <?php foreach ($structureAgent->getResponsables() as $responsable) : ?>
                        <span class="icon application" title="Déterminé par EMC2"></span>
                        <?php echo $responsable->getAgent()->getDenomination(); ?> <br/>
                    <?php endforeach; ?>
                <?php else : ?>
                    Pas de structure fines<br/>
                <?php endif ?>
                <?php foreach ($agent->getComplementsByType(Complement::COMPLEMENT_TYPE_RESPONSABLE) as $complement) : ?>
                    <span class="icon formation" title="Manuellement indiqué"></span>
                    <?php echo $this->complement($complement); ?>
                    <?php if ($canComplement) : ?>
                        <a href="<?php echo $this->url('complement/modifier', ['complement' => $complement->getId()], [], true); ?>" class="ajax-modal" data-event="modification"><span class="icon editer"></span></a>
                        <a href="<?php echo $this->url('complement/supprimer', ['complement' => $complement->getId()], [], true); ?>" class="ajax-modal" data-event="modification"><span class="icon detruire"></span></a>
                    <?php endif; ?>
                    <br/>
                <?php endforeach; ?>
                <?php if ($canComplement) : ?>
                    <?php /** @see \Application\Controller\ComplementController::ajouterAction() */ ?>
                    <a href="<?php echo $this->url('complement/ajouter', ['type' => Complement::COMPLEMENT_TYPE_RESPONSABLE, 'attachmenttype' => Agent::class, 'attachmentid' => $agent->getId()], [], true); ?>" class="ajax-modal" data-event="modification">
                        <span class="icon ajouter"></span> Ajouter un&middot;e supérieur&middot;e
                    </a>
                <?php endif; ?>
            </td>
            <td> <!-- AUTORITE HIERARCHIQUE --------------------------------------------------------------------------->
                <?php if ($niveau2) : ?>
                    <?php foreach ($niveau2->getResponsables() as $responsable) : ?>
                        <span class="icon application" title="Déterminé par EMC2"></span>
                        <?php echo $responsable->getAgent()->getDenomination(); ?> <br/>
                    <?php endforeach; ?>
                <?php else : ?>
                    Pas de structure de niv2<br/>
                <?php endif ?>
                <?php foreach ($agent->getComplementsByType(Complement::COMPLEMENT_TYPE_AUTORITE) as $complement) : ?>
                    <span class="icon formation" title="Manuellement indiqué"></span>
                    <?php echo $this->complement($complement); ?>
                    <?php if ($canComplement) : ?>
                        <a href="<?php echo $this->url('complement/modifier', ['complement' => $complement->getId()], [], true); ?>" class="ajax-modal" data-event="modification"><span class="icon editer"></span></a>
                        <a href="<?php echo $this->url('complement/supprimer', ['complement' => $complement->getId()], [], true); ?>" class="ajax-modal" data-event="modification"><span class="icon detruire"></span></a>
                    <?php endif; ?>
                    <br/>
                <?php endforeach; ?>
                <?php if ($canComplement) : ?>
                    <a href="<?php echo $this->url('complement/ajouter', ['type' => Complement::COMPLEMENT_TYPE_AUTORITE, 'attachmenttype' => Agent::class, 'attachmentid' => $agent->getId()], [], true); ?>" class="ajax-modal" data-event="modification">
                        <span class="icon ajouter"></span> Ajouter une autorité
                    </a>
                <?php endif; ?>
            </td>
            <td>
                <?php if ($canVoirAgent) : ?>
                    <a
                        <?php /** @see \Application\Controller\AgentController::afficherAction() */?>
                            href="<?php echo $this->url('agent/afficher', ['agent' => $agent->getId()], [], true); ?>"
                            target="_blank"
                    >
                        <span class="icon personnel" data-toggle="tooltip" data-html="true" title="Voir les renseignements de <span class='highlight agent'><?php echo $agent->getDenomination(); ?></span>"></span></a>
                <?php endif; ?>

                <?php if ($isForce AND $canRetirerAgentForce) : ?>
                    <?php /** @see \Application\Controller\StructureController::retirerManuellementAgentAction() */ ?>
                    <a  class="ajax-modal" data-event="modification"
                        href="<?php echo $this->url('structure/retirer-manuellement-agent', [ 'structure' => $structure->getId(), 'agent' => $agent->getId()], [], true); ?>"
                    >
                        <span class="icon retirer-user"></span>
                    </a>
                <?php endif; ?>
            </td>
        </tr>
    <?php endforeach; ?>
    </tbody>

</table>