<?php

use FicheMetier\Entity\Db\FicheMetierMission;
use FicheMetier\Entity\Db\Mission;
use FicheMetier\Entity\Db\MissionActivite;
use FichePoste\Entity\Db\MissionAdditionnelle;

/**
 * @see \FicheMetier\Controller\MissionPrincipaleController::afficherAction();
 * @var Mission $mission
 * @var FicheMetierMission[] $fichesmetiers
 * @var MissionAdditionnelle[] $fichespostes
 * @var bool $codeFonction
 * @var bool $modification
 * @var ?string $retour
 */


?>

<?php if ($mission->estHistorise()) : ?>
    <span class="badge" style="background:darkred; font-size: larger;">
        Historisée
    </span>
    <br>
    <br>
<?php endif; ?>

<div class="row">
    <div class="col-md-6">
        <dl class="row">
            <dt> Libellé de la mission</dt>
            <dd> <?php echo $mission->getLibelle(); ?> </dd>
            <dt> Activité·s associée·s
            <dd>
                <?php
                    $activites = $mission->getActivites();
                    usort($activites, function (MissionActivite $a, MissionActivite $b) {
                        return $a->getOrdre() <=> $b->getOrdre();
                    });
                ?>
                <?php if (empty($activites)): ?>
                    <span class="missing-data">Aucune activité</span>
                <?php else: ?>
                    <ul>
                        <?php foreach ($activites as $activite) : ?>
                            <li>
                                <?php echo $activite->getLibelle(); ?>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
            </dd>
    <dt class="col-md-4"> Famille·s Professionnelle·s </dt>
    <dd class="col-md-8">
        <?php $familles = $mission->getFamillesProfessionnelles(); ?>
        <?php if (empty($familles)): ?>
            <em style="color:gray;">Aucune famille professionnelle</em>
        <?php else : ?>
            <ul>
                <?php foreach ($mission->getFamillesProfessionnelles() as $famille) : ?>
                    <li> <?php echo $famille->getLibelle(); ?> </li>
                <?php endforeach; ?>
            </ul>
        <?php endif; ?>
    </dd>
    <dt class="col-md-4"> Niveau </dt>
    <dd class="col-md-8">
        <?php if ($mission->getNiveau() === null) : ?>
            <span class="missing-data">Aucun niveau </span>
        <?php else : ?>
            <?php echo $this->niveauEnveloppe($mission->getNiveau()); ?>
        <?php endif; ?>
    </dd>
    <dt class="col-md-4"> Référence </dt>
    <dd class="col-md-8">
        <?php if ($mission->getReferentiel() === null AND $mission->getReference() === null) : ?>
            <span class="missing-data">Aucune référence </span>
        <?php else : ?>
            <?php echo $mission->printReference(); ?>
        <?php endif; ?>
    </dd>
</dl>
    </div>
    <div class="col-md-6">
        <dl class="row">
            <?php if ($mission->getHistoCreation()) : ?>
                <dt class="col-md-4"> Création </dt>
                <dd class="col-md-8">
                    Créée le <?php echo $mission->getHistoCreation()->format("d/m/Y à H:i");?> <br>
                    par <?php echo $mission->getHistoCreateur()?->getDisplayName(); ?>
                </dd>
            <?php endif; ?>
            <?php if ($mission->getHistoModification()) : ?>
                <dt class="col-md-4"> Modification </dt>
                <dd class="col-md-8">
                    Créée le <?php echo $mission->getHistoModification()->format("d/m/Y à H:i");?> <br>
                    par <?php echo $mission->getHistoModificateur()?->getDisplayName(); ?>
                </dd>
            <?php endif; ?>
            <?php if ($mission->getHistoDestruction()) : ?>
                <dt class="col-md-4"> Historisation </dt>
                <dd class="col-md-8">
                    Créée le <?php echo $mission->getHistoDestruction()->format("d/m/Y à H:i");?> <br>
                    par <?php echo $mission->getHistoDestructeur()?->getDisplayName(); ?>
                </dd>
            <?php endif; ?>

        </dl>
    </div>
</div>

<dl>
    <dt> Fiche·s métier·s attachée·s à la mission principale </dt>
    <dd>
        <?php echo count($fichesmetiers); ?> fiche·s métier·s
        <ul>
            <?php foreach ($fichesmetiers as $fichemetier) : ?>
                <?php $libelle = $fichemetier->getFicheMetier()->getLibelle(); ?>
                <li>
                    <?php
                    $ficheId = $fichemetier->getFicheMetier()->getId();
                    ?>
                    <?php echo $fichemetier->getFicheMetier()->printReference(); ?>
                    <?php echo $this->etatinstance($fichemetier->getFicheMetier()->getEtatActif()); ?>
                    <?php if ($libelle !== null) : ?>
                        <?php echo $libelle; ?>
                        <?php if ($codeFonction === true): ?>
                            - <?php echo $fichemetier->getFicheMetier()->getCodeFonction()?$fichemetier->getFicheMetier()->getCodeFonction()->computeCode():"<em style='color:gray;'>Aucun code fonction</em>"; ?>
                        <?php endif; ?>
                    <?php else : ?>
                        <span class="text-danger"> Aucun libellé ou métier d'associé à la fiche métier #<?php echo $ficheId; ?></span>
                    <?php endif; ?>
                    <small>
                        <?php /** @see \FicheMetier\Controller\FicheMetierController::afficherAction() */ ?>
                        <a href="<?php echo $this->url('fiche-metier/afficher', ['fiche-metier' => $fichemetier->getFicheMetier()->getId()], ['force_canonical' => true], true); ?>"
                           class="action secondary" target="_blank"
                        >
                            <span class="icon icon-voir"></span>
                            Afficher
                        </a>
                    </small>
                </li>
            <?php endforeach; ?>
        </ul>
    </dd>
    <dt>Fiche·s de poste listant à la mission principale</dt>
    <dd>
        <?php echo count($fichespostes); ?> fiche·s de poste
        <ul>
            <?php foreach ($fichespostes as $ficheposte) : ?>
                <li>
                    <?php
                    $ficheId = ($ficheposte->getFicheposte()) ? $ficheposte->getFicheposte()->getId() : null;
                    $agent = ($ficheposte->getFicheposte() and $ficheposte->getFicheposte()->getAgent()) ? $ficheposte->getFicheposte()->getAgent() : null;
                    ?>
                    <?php echo $this->etatinstance($ficheposte->getFicheposte()->getEtatActif()); ?>
                    <?php echo $ficheposte->getFicheposte()->getLibelle()??"Fiche sans libellé"; ?>
                    <?php if ($agent) : ?>
                        <?php echo $agent->getDenomination(); ?>
                    <?php else : ?>
                        <span class="text-danger"> Aucun agent d'associé·e</span>
                    <?php endif; ?>
                    <?php if ($ficheId) : ?>
                        (Fiche de poste #<?php echo $ficheId; ?>)
                    <?php endif; ?>
                    <small>
                        <?php /** @see \Application\Controller\FichePosteController::afficherAction() */ ?>
                        <a href="<?php echo $this->url('fiche-poste/afficher', ['fiche-poste' => $ficheposte->getFicheposte()->getId()], ['force_canonical' => true], true); ?>"
                           class="action secondary" target="_blank"
                        >
                            <span class="icon icon-voir"></span>
                            Afficher
                        </a>
                    </small>
                </li>
            <?php endforeach; ?>
        </ul>
    </dd>


</dl>



<script>
    $(function () {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>