<?php

use Application\Provider\Privilege\FicheMetierPrivileges;
use FicheMetier\Entity\Db\FicheMetier;
use FicheMetier\Provider\Parametre\FicheMetierParametres;
use UnicaenParametre\Entity\Db\Parametre;

/**
 * @var FicheMetier $fichemetier
 * @var string $mode
 * @var Parametre[] $parametres
 */

$canEditer = $this->isAllowed(FicheMetierPrivileges::getResourceId(FicheMetierPrivileges::FICHEMETIER_MODIFIER));

$metier = $fichemetier->getMetier();

?>

<dl class="row">
    <?php if (!isset($parametres[FicheMetierParametres::CODE_FONCTION]) || $parametres[FicheMetierParametres::CODE_FONCTION]->getValeur() !== "false") : ?>
        <dt class="col-md-4"> Niveau  </dt>
        <dd class="col-md-8">
            <?php if ($fichemetier->getCodeFonction()): ?>
                <?php echo $fichemetier->getCodeFonction()->getNiveauFonction()?->getLibelle(); ?>
            <?php else : ?>
                Aucun niveau associé
            <?php endif; ?>
        </dd>
    <?php endif; ?>
    <?php $famille = $fichemetier->getFamilleProfessionnelle(); ?>
    <dt class="col-md-4"> Spécialité </dt>
    <dd class="col-md-8">
        <?php if ($famille === null) : ?>
            <em>Aucune spécialité</em> <span class="icon icon-info" title="L'absence de famille empêche de déterminer la spécialité"></span>
        <?php elseif ($famille->getCorrespondance() === null) : ?>
            <em>Aucune spécialité </em><span class="icon icon-info" title="Aucune spécialité liée à la famille professionnelle"></span>
        <?php else : ?>
            <?php echo $famille->getCorrespondance()->getLibelleLong(); ?>
        <?php endif; ?>
    </dd>
    <dt class="col-md-4"> Famille </dt>
    <dd class="col-md-8">
        <?php if ($famille === null) : ?>
            <em>Aucune famille professionnelle </em>
        <?php else : ?>
            <?php echo $famille->getLibelle(); ?>
        <?php endif; ?>
    </dd>
    <?php if (!isset($parametres[FicheMetierParametres::CODE_FONCTION]) || $parametres[FicheMetierParametres::CODE_FONCTION]->getValeur() !== "false") : ?>
        <dt class="col-md-4"> Code Fonction</dt>
        <dd class="col-md-8">
            <?php $code = $fichemetier->getCodeFonction(); ?>
            <?php if ($code !== null) : ?>
                <code> <?php echo $code->computeCode(); ?> </code>
            <?php else : ?>
                Non renseigné
            <?php endif; ?>
            <br> <!-- // todo : retirer ce br copium -->
            <?php if ($mode === 'edition-fiche-metier' AND $canEditer) : ?>
                <?php /** @see FicheMetierController::modifierCodeFonctionAction() */ ?>
                <a href="<?php echo $this->url('fiche-metier/modifier-code-fonction', ['fiche-metier' => $fichemetier->getId()], [], true); ?>"
                   class="ajax-modal action primary" data-event="modification"
                >
                    <small>
                        <span class="icon icon-editer"></span>
                        Modifier
                    </small>
                </a>
                <?php /** @see FicheMetierController::supprimerCodeFonctionAction() */ ?>
                <a href="<?php echo $this->url('fiche-metier/supprimer-code-fonction', ['fiche-metier' => $fichemetier->getId()], [], true); ?>"
                   class="action danger"
                >
                    <small>
                        <span class="icon icon-unchecked"></span>
                        Supprimer
                    </small>
                </a>
            <?php endif; ?>
        </dd>
    <?php endif; ?>
    <dt class="col-md-4"> Références</dt>
    <dd class="col-md-8">
        <?php if ($fichemetier->getReference()): ?>
            <?php echo $fichemetier->printReference(); ?>
        <?php endif; ?>
        <?php if ($metier): ?>
            <?php
            $references = $metier->getReferences();
            $first = true;
            ?>
            <?php if (!empty($references)) : ?>
                <?php foreach ($references as $reference) : ?>
                    <?php if ($first) : ?>
                        <?php $first = false; ?>
                    <?php else : ?>
                        <br/>
                    <?php endif; ?>
                    <a href="<?php echo $reference->getUrl(); ?>">
                        <?php echo $reference->getTitre(); ?>
                    </a>
                <?php endforeach; ?>
            <?php else : ?>
                Aucune référence
            <?php endif; ?>
        <?php endif; ?>
    </dd>
<!-- Partie expertise désactivée avant suppression -->
<!--    <dt class="col-md-4"> Expertise</dt>-->
<!--    <dd class="col-md-8">-->
<!--        --><?php //if ($fichemetier->hasExpertise()) : ?>
<!--            Sujet à expertise-->
<!--        --><?php //else : ?>
<!--            Non sujet à expertise-->
<!--        --><?php //endif; ?>
<!--        --><?php //if ($mode !== 'affichage') : ?>
<!--            <a-->
<!--                --><?php ///** @see FicheMetierController::modifierExpertiseAction() */ ?>
<!--                    href="--><?php //echo $this->url('fiche-metier/modifier-expertise', ['fiche-metier' => $fichemetier->getId()], [], true); ?><!--"-->
<!--            >-->
<!--                <span class="icon icon-refresh"></span>-->
<!--            </a>-->
<!--        --><?php //endif; ?>
<!--    </dd>-->
    <dt class="col-md-4"> Date de dépôt</dt>
    <dd class="col-md-8"> <?php echo $fichemetier->getEtatActif()?->getHistoCreation()->format("d/m/Y"); ?></dd>
    <dt class="col-md-4"> État</dt>
    <dd class="col-md-8">
        <?php echo $this->etatinstance($fichemetier->getEtatActif()); ?>
    </dd>
</dl>
