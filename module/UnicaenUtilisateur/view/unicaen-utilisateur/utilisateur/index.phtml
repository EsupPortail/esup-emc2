<?php

use UnicaenUtilisateur\Controller\UtilisateurController;
use UnicaenUtilisateur\Entity\Db\Role;
use UnicaenUtilisateur\Entity\Db\User;
use UnicaenUtilisateur\Provider\Privilege\Privileges;
use UnicaenUtilisateur\Provider\Privilege\UtilisateurPrivileges;
use UnicaenApp\Form\Element\SearchAndSelect;

/**
 * @see UtilisateurController::indexAction()
 * @var User $utilisateur
 * @var Role[] $roles
 * @var Role[] $rolesAffectes
 * @var Role[] $rolesDisponibles
 */

$canAfficher    = $this->isAllowed(UtilisateurPrivileges::getResourceId(UtilisateurPrivileges::UTILISATEUR_AFFICHER));
$canAjouter     = $this->isAllowed(UtilisateurPrivileges::getResourceId(UtilisateurPrivileges::UTILISATEUR_AJOUTER));
$canStatus      = $this->isAllowed(UtilisateurPrivileges::getResourceId(UtilisateurPrivileges::STATUT_CHANGER));
$canRole        = $this->isAllowed(UtilisateurPrivileges::getResourceId(UtilisateurPrivileges::MODIFIER_ROLE));

$canListing = $canAfficher;
$canCreerLocal = $canAjouter;

?>

<?php $this->headTitle($this->translate("Administration des utilisateurs")) ?>

<h1 class="page-header" > Administration des utilisateurs </h1>

<?php echo $this->messenger()->addMessagesFromFlashMessenger(); ?>

<div class="main">

    <div class="row">
    <?php if ($canListing) : ?>
    <a  <?php /** @see UtilisateurController::listingAction() */ ?>
        href="<?php echo $this->url('utilisateur-preecog/listing', [], [], true); ?>"
        class="btn btn-primary action"
    >
        <span class="icon listing"></span>
        Accéder au listing
    </a>
    <?php endif; ?>

    <?php if ($canCreerLocal) : ?>
        <a  <?php /** @see UtilisateurController::ajouterAction() */ ?>
                href="<?php echo $this->url('utilisateur-preecog/ajouter', [], [], true); ?>"
                class="btn btn-primary action"
        >
            <span class="icon ajouter"></span>
            Créer un compte local
        </a>
    <?php endif; ?>
    </div>

<a name="recherche"></a>

<h2> Recherche d'un utilisateur ou d'une personne à ajouter </h2>

    <form method='post' class="form-inline " style="margin-bottom:10px;">
        <?php
        /** @see UtilisateurController::rechercherAction() */
        $sas = new SearchAndSelect('utilisateur');
        $sas->setAttribute('placeholder','Recherchez une personne');
        $sas->setAttribute('class', 'individu-finder');
        $sas->setAutocompleteSource($this->url('utilisateur-preecog/rechercher', [], [], true));
        echo $this->formControlGroup($sas, 'formSearchAndSelect');
        ?>
        <input type="submit" class="btn btn-primary" value="Sélectionner la personne"/>
    </form>

<?php if($utilisateur !== null): ?>
    <div class="panel panel-info">
        <div class="panel-heading">
            <h2> Information sur l'utilisateur selectionné </h2>
        </div>
        <div class="panel-body">
            <div  class="pull-left">
                <dl>
                    <dt> Nom affiché dans l'application </dt>
                    <dd> <?php echo $utilisateur->getDisplayName();?> </dd>
                    <dt> Adresse électronique associé </dt>
                    <dd> <?php echo $utilisateur->getEmail();?> </dd>
                    <dt> Activité du compte </dt>
                    <dd>
                        <?php if ($utilisateur->getState() == 1): ?>
                            Actif
                        <?php else: ?>
                            Désactivé
                        <?php endif; ?>
                    </dd>
                </dl>
            </div>
            <div class="pull-right">
                <?php if ($canStatus) : ?>
                    <a  <?php /** @see UtilisateurController::changerStatusAction() */ ?>
                        href="<?php echo $this->url('utilisateur-preecog/changer-status', ['utilisateur' => $utilisateur->getId()], [], true); ?>"
                        class="btn btn-warning action">
                        <span class="glyphicon glyphicon-refresh"></span> Changer le status
                    </a>
                <?php endif; ?>

                <br/>

                <?php if ($canAjouter) : ?>
                <a <?php /** @see UtilisateurController::effacerAction() */ ?>
                   href="<?php echo $this->url('utilisateur-preecog/effacer', ['utilisateur' => $utilisateur->getId()], [], true); ?>"
                   class="btn btn-danger action ajax-modal" data-event="modification">
                   <span class="glyphicon glyphicon-remove"></span> Supprimer le compte
                </a>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <div class="panel panel-info">
        <div class="panel-heading">
            <h2> Information sur l'utilisateur selectionné </h2>
        </div>
        <div class="panel-body">

            <div class="col-md-6">
                <h3> Rôles affectés </h3>

                <?php foreach ($roles as $role) : ?>
                    <div class="cliquable remove-role" id="affecte_<?php echo $utilisateur->getId(); ?>_<?php echo $role->getId(); ?>"
                         style="<?php if (array_search($role,$rolesDisponibles)!== false) echo 'display:none;'; ?>"
                    >
                        <?php if ($canRole): ?>
                            <span id="<?php echo $utilisateur->getId().'_'.$role->getId(); ?>"
                                  style="color:red;"
                                  class=" glyphicon glyphicon-minus-sign pointer">
                            </span>
                        <?php endif; ?>
                        <?php echo $role->getRoleId(); ?>
                    </div>
                <?php endforeach; ?>

            </div>
            <div class="col-md-6">
                <h3> Rôles disponibles </h3>

                <?php foreach ($roles as $role) : ?>
                    <div class="cliquable add-role" id="disponible_<?php echo $utilisateur->getId(); ?>_<?php echo $role->getId(); ?>"
                         style="<?php if (array_search($role,$rolesAffectes) !== false) echo 'display:none;'; ?>"
                    >
                        <?php if ($canRole): ?>
                        <span id="<?php echo $utilisateur->getId().'_'.$role->getId(); ?>"
                              style="color:green;"
                              class="glyphicon glyphicon-plus-sign pointer">
                        </span>
                        <?php endif; ?>
                        <?php echo $role->getRoleId(); ?>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
    </div>
<?php endif; ?>

</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });

    $(document).ready(function () {
        $(".remove-role").click(function () {
            let id = $(this).attr("id");
            let splits = id.split("_");
            let role = splits[2];
            let individu = splits[1];

            let url = "utilisateur/remove-role/" + individu + "/" + role;
            $("#affecte_" + individu + "_" + role).hide();
            $("#disponible_" + individu + "_" + role).show();

            $.ajax({
                type: "POST",
                url: url
            });
        });
    });
    $(document).ready(function () {
        $(".add-role").click(function () {
            let id = $(this).attr("id");
            let splits = id.split("_");
            let role = splits[2];
            let individu = splits[1];

            let url = "utilisateur/add-role/" + individu + "/" + role;
            $("#affecte_" + individu + "_" + role).show();
            $("#disponible_" + individu + "_" + role).hide();

            $.ajax({
                type: "POST",
                url: url
            });
        });
    });
</script>

<style>
    .cliquable {
        border: 1px solid lightgray;
        border-radius : 5px;
        margin: 0.25rem;
        padding: 0.25rem;
    }

    .cliquable:hover {
        background-color: lightyellow;
        cursor : pointer ;
    }

    span.badge#app{
        background-color: darkcyan;
    }

    span.badge#ldap{
        background-color: darkorange;
    }

    span.badge#octopus{
        background-color: purple;
    }
</style>