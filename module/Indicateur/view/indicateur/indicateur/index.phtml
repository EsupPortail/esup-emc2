<?php

/**
 * @var Indicateur[] $indicateurs
 * @var Abonnement[] $abonnements
 */

use Indicateur\Entity\Db\Abonnement;
use Indicateur\Entity\Db\Indicateur;
use Indicateur\Provider\Privilege\IndicateurPrivileges;

$canVoir    = $this->isAllowed(IndicateurPrivileges::getResourceId(IndicateurPrivileges::AFFICHER));
$canEditer  = $this->isAllowed(IndicateurPrivileges::getResourceId(IndicateurPrivileges::EDITER));
$canDetruire = $this->isAllowed(IndicateurPrivileges::getResourceId(IndicateurPrivileges::DETRUIRE));
?>

<h1 class="page-header">
    Indicateurs
</h1>

<div class="main">

    <div class="row">
        <?php if ($canEditer) :?>
            <?php /** @see IndicateurController::creerAction() */?>
            <a href="<?php echo $this->url("indicateur/creer", [], [], true); ?>"
               class="btn btn-primary ajax-modal action" data-event="modification"
            >
                <span class="icon ajouter"></span>
                Créer un nouvel indicateur
            </a>

            <?php /** @see AbonnementController::notifierAction() */?>
            <a href="<?php echo $this->url("abonnement/notifier", [], [], true); ?>"
               class="btn btn-primary action"
            >
                <span class="icon ok"></span>
                Notifier
            </a>
        <?php endif; ?>
    </div>

    <table id="datatable" class="table table-condensed">
        <thead>
            <tr>
                <th> Titre </th>
                <th> Description </th>
                <th> Entity </th>
                <th> #Abonnement </th>
                <th> Action </th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($indicateurs as $indicateur) : ?>
                <tr>
                    <td> <?php echo $indicateur->getTitre(); ?> </td>
                    <td> <?php echo $indicateur->getDescription(); ?> </td>
                    <td> <?php echo $indicateur->getEntity(); ?> </td>
                    <td>
                        <?php echo count($indicateur->getAbonnements()); ?>
                        <?php if ($abonnements[$indicateur->getId()]) : ?>
                            <span class="icon ok" style="color:darkgreen;" title="Vous êtes abonné&middot;e à cet indicateur"></span>
                        <?php else : ?>
                            <span class="icon ko" style="color:darkred;" title="Vous n'êtes pas abonné&middot;e à cet indicateur"></span>
                        <?php endif;?>
                    </td>
                    <td>
                        <?php if ($canVoir): ?>
                            <?php /** @see IndicateurController::afficherAction() */?>
                            <a href="<?php echo $this->url("indicateur/afficher", ['indicateur' => $indicateur->getId()], [], true); ?>">
                                <span class="icon voir" title="Visualiser l'indicateur"></span></a>
                        <?php else : ?>
                            <span class="icon voir" style="color:lightgray"></span>
                        <?php endif; ?>

                        <?php if ($canEditer): ?>
                            <?php /** @see IndicateurController::modifierAction() */?>
                            <a href="<?php echo $this->url("indicateur/modifier", ['indicateur' => $indicateur->getId()], [], true); ?>"
                               class="ajax-modal" data-event="modification">
                                <span class="icon editer" title="Modifier l'indicateur"></span></a>
                        <?php else : ?>
                            <span class="icon editer" style="color:lightgray"></span>
                        <?php endif; ?>

                        <?php if ($canDetruire): ?>
                            <?php /** @see IndicateurController::detruireAction() */?>
                            <a href="<?php echo $this->url("indicateur/detruire", ['indicateur' => $indicateur->getId()], [], true); ?>">
                                <span class="icon detruire" title="Détruire l'indicateur"></span></a>
                        <?php else : ?>
                            <span class="icon detruire" style="color:lightgray"></span>
                        <?php endif; ?>


                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>

</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>