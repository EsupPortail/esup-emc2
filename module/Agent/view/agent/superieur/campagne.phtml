<?php

/**
 * @see \EntretienProfessionnel\Controller\CampagneController::autoriteAction()
 * @var ?string $erreur
 * @var Agent $agent
 * @var Agent[] $agents
 * @var Agent[] $obligatoires
 * @var Agent[] $facultatifs
 * @var string[] $raisons
 * @var Campagne $campagne
 * @var Campagne[] $campagnes
 * @var EntretienProfessionnel[] $entretiens
 * @var array $affectations
 */

use Application\Entity\Db\Agent;
use EntretienProfessionnel\Entity\Db\Campagne;
use EntretienProfessionnel\Entity\Db\EntretienProfessionnel;

$sansObligatoires = []; $sansFacultatifs = [];
foreach ($obligatoires as $obligatoire) {
    if (!isset($entretiens[$obligatoire->getId()])) $sansObligatoires[] = $obligatoire;
}
foreach ($facultatifs as $facultatif) {
    if (!isset($entretiens[$facultatif->getId()])) $sansFacultatifs[] = $facultatif;
}
?>

<h1 class="page-header">
    Tableau de bord
</h1>

<?php if (isset($erreur)) : ?>
    <div class="alert alert-danger">
        <div class="row">
            <div class="col-md-1">
                <span class="icon icon-warning"></span>
            </div>
            <div class="col-md-11">
                <span class="text-danger"><strong>Erreur : vous n'avez pas accés à cette page. </strong></span>
                <br>
                <?php echo $erreur; ?>
            </div>
        </div>
    </div>

<?php else : ?>

    <?php echo $this->partial('partial/entete', ['campagnes' => $campagnes, 'agent' => $agent]); ?>


    <h2>
        Campagne d'entretien professionnel <?php echo $campagne->getAnnee(); ?>
    </h2>

    <div class="row">
        <div class="col-md-6">
            <h3> Information sur la campagne</h3>
            <?php echo $this->campagneInformation($campagne); ?>
        </div>
        <div class="col-md-6">
            <h3> Complétion de la campagne</h3>
            <?php echo $this->campagneAvancement($entretiens, $obligatoires); ?>
        </div>
    </div>


    <?php if (!empty($finalises)) : ?>
        <h2>
            Entretiens professionnels finalisés
            <span class="badge"> <?php echo count($finalises); ?> </span>
        </h2>

        <?php echo $this->entretienProfessionnelArray($finalises, ['affichages' => ['annee' => false], 'droits' => ['acceder' => true, 'exporter' => true], 'id' => 'complet']); ?>
    <?php endif; ?>


    <?php if (!empty($encours)) : ?>
        <h2>
            Entretiens professionnels en cours d'évaluation
            <span class="badge"> <?php echo count($encours); ?> </span>
        </h2>

        <?php echo $this->entretienProfessionnelArray($encours, ['affichages' => ['annee' => false], 'id' => 'encours']); ?>
    <?php endif; ?>


    <?php if (!empty($sansObligatoires)) : ?>
        <h2>
            Agents en attente d'entretien professionnel
            <span class="badge"> <?php echo count($sansObligatoires); ?> </span>
        </h2>
        <?php echo $this->convocationArray($sansObligatoires, $campagne, ['id' => 'sansentretien', 'raison' => $raisons]); ?>
    <?php endif; ?>

    <?php if (!empty($sansFacultatifs)) : ?>
        <h2>
            Agents sans obligation d'entretien professionnel
            <span class="badge"> <?php echo count($sansFacultatifs); ?> </span>
        </h2>

        <div class="alert alert-info">
            <div class="row">
                <div class="col-md-1"><span class="icon icon-info"></span></div>
                <div class="col-md-10">
                    Les agents n'étant pas en poste à la date du <?php echo $campagne->getDateEnPoste()->format('d/m/Y'); ?> n'ont pas d'obligation d'entretien professionnel.
                    <br/>
                    Vous pouvez cependant planifier un entretien professionnel si vous le souhaitez.
                </div>
            </div>
        </div>
        <?php echo $this->convocationArray($sansFacultatifs, $campagne, ['id' => 'sansobligation', 'raison' => $raisons] ); ?>
    <?php endif; ?>
<?php endif; ?>

<script>
    $(document).ready(function () {
        $('table#agents').dataTable({
            paging: false,
            info: false,
            autoWidth: false,
            language: {
                "url": "/js/datatables_fr.json",
            },
            columnDefs: [
                {targets: [2], orderable: false}
            ]
        });
    });
</script>

