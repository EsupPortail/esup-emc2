<?php

/**
 * @var EntretienProfessionnel $entretien
 */

use EntretienProfessionnel\Entity\Db\EntretienProfessionnel;
use EntretienProfessionnel\Provider\Privilege\EntretienproPrivileges;

$canValiderAgent        = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_AGENT);
$canValiderResponsable  = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_RESPONSABLE);
$canValiderDrh          = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_DRH);

$now = new DateTime();
$dateOk = ($now > $entretien->getDateEntretien());
$hasValidationResponsable = $entretien->getValidationResponsable();
$hasValidationAgent = $entretien->getValidationAgent();
$hasValidationDRH = $entretien->getValidationDRH();
?>

<h2 class="page-header-tab"> Validations </h2>

<?php echo $this->portenote('EntretienProfessionnelController::renseignerAction()>validations', '', []); ?>

<div>
    <h3 class="categorie"> Validation du responsable de l'entretien professionnel </h3>

    <?php if (!$dateOk) : ?>
        <?php echo $this->portenote('EntretienProfessionnelController::renseignerAction()validations:date_non_atteinte', '', []); ?>
    <?php endif; ?>

    <?php if ($dateOk) : ?>
        <div class="row">
            <div class="col-md-8">
                <?php if ($hasValidationResponsable) : ?>
                    <div class="alert alert-success">
                        <div class="col-md-5">
                            <strong><u>Validation responsable effectuée.</u></strong>
                        </div>
                        <div class="col-md-7">
                            <dl class="dl-horizontal">
                                <dt> Validateur </dt>
                                <dd> <?php echo $hasValidationResponsable->getHistoModificateur()->getDisplayName(); ?> </dd>
                                <dt> Date </dt>
                                <dd> <?php echo $hasValidationResponsable->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                            </dl>
                        </div>
                        <br/>
                        <br/>
                    </div>
                <?php endif; ?>
            </div>
            <div class="pull-right">
                <?php if ($canValiderResponsable and !$hasValidationAgent) : ?>
                    <?php if ($hasValidationResponsable) : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $hasValidationResponsable->getId()], [], true); ?>"
                                class="btn btn-danger action"
                        >
                            <span class="icon validation-undo"></span>
                            Révoquer la validation
                        </a>
                    <?php else : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::validerElementAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/valider-element', ['entretien' => $entretien->getId(), 'type' => 'Responsable'], [], true); ?>"
                                class="btn btn-success action ajax-modal"
                                data-event="modification"
                        >
                            <span class="icon validation-do"></span>
                            Validation du responsable
                        </a>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
        </div>
    <?php endif; ?>
</div>

<div>
    <h3 class="categorie"> Validation de l'agent </h3>

    <?php if (!$hasValidationResponsable) : ?>
        <?php echo $this->portenote('EntretienProfessionnelController::renseignerAction()validations:pas_de_validation_responsable', '', []); ?>
    <?php endif; ?>

    <?php if (!$hasValidationAgent) : ?>
        <?php echo $this->portenote('EntretienProfessionnelController::renseignerAction()validations:reclamations', '', []); ?>
    <?php endif; ?>

    <?php if ($hasValidationResponsable) : ?>
        <div class="row">
            <div class="col-md-8">
                <?php if ($hasValidationAgent) : ?>
                    <div class="alert alert-success">
                        <div class="col-md-5">
                            <strong><u>Validation responsable effectuée.</u></strong>
                        </div>
                        <div class="col-md-7">
                            <dl class="dl-horizontal">
                                <dt> Validateur </dt>
                                <dd> <?php echo $hasValidationAgent->getHistoModificateur()->getDisplayName(); ?> </dd>
                                <dt> Date </dt>
                                <dd> <?php echo $hasValidationAgent->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                            </dl>
                        </div>
                        <br/>
                        <br/>
                    </div>
                <?php endif; ?>
            </div>
            <div class="pull-right">
                <?php if ($canValiderAgent and !$hasValidationDRH) : ?>
                    <?php if ($hasValidationAgent) : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $hasValidationAgent->getId()], [], true); ?>"
                                class="btn btn-danger action"
                        >
                            <span class="icon validation-undo"></span>
                            Révoquer la validation
                        </a>
                    <?php else : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::validerElementAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/valider-element', ['entretien' => $entretien->getId(), 'type' => 'Agent'], [], true); ?>"
                                class="btn btn-success action ajax-modal"
                                data-event="modification"
                        >
                            <span class="icon validation-do"></span>
                            Validation de l'agent
                        </a>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
        </div>
    <?php endif; ?>
</div>

<div>
    <h3 class="categorie"> Validation du responsable hiérarchique </h3>

    <?php if (!$hasValidationAgent) : ?>
        <?php echo $this->portenote('EntretienProfessionnelController::renseignerAction()validations:pas_de_validation_agent', '', []); ?>
    <?php endif; ?>

    <?php if ($hasValidationAgent) : ?>
        <div class="row">
            <div class="col-md-8">
                <?php if ($hasValidationDRH) : ?>
                    <div class="alert alert-success">
                        <div class="col-md-5">
                            <strong><u>Validation responsable hiérarchique.</u></strong>
                        </div>
                        <div class="col-md-7">
                            <dl class="dl-horizontal">
                                <dt> Validateur </dt>
                                <dd> <?php echo $hasValidationDRH->getHistoModificateur()->getDisplayName(); ?> </dd>
                                <dt> Date </dt>
                                <dd> <?php echo $hasValidationDRH->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                            </dl>
                        </div>
                        <br/>
                        <br/>
                    </div>
                <?php endif; ?>
            </div>
            <div class="pull-right">
                <?php if ($canValiderDrh) : ?>
                    <?php if ($hasValidationDRH) : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $hasValidationDRH->getId()], [], true); ?>"
                                class="btn btn-danger action"
                        >
                            <span class="icon validation-undo"></span>
                            Révoquer la validation
                        </a>
                    <?php else : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::validerElementAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/valider-element', ['entretien' => $entretien->getId(), 'type' => 'DRH'], [], true); ?>"
                                class="btn btn-success action ajax-modal"
                                data-event="modification"
                        >
                            <span class="icon validation-do"></span>
                            Validation du responsable hiérarchique
                        </a>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
        </div>
    <?php endif; ?>
</div>

<style>
    h3.categorie {
        border-bottom: 1px solid #31708f;
    }
</style>