<?php

/**
 * @var EntretienProfessionnel $entretien
 */

use EntretienProfessionnel\Entity\Db\EntretienProfessionnel;
use EntretienProfessionnel\Entity\Db\EntretienProfessionnelConstant;
use EntretienProfessionnel\Provider\Privilege\EntretienproPrivileges;

$canValiderAgent        = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_AGENT);
$canValiderObservation  = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_OBSERVATION);
$canValiderResponsable  = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_RESPONSABLE);
$canValiderDrh          = $this->isAllowed($entretien, EntretienproPrivileges::ENTRETIENPRO_VALIDER_DRH);

$now = new DateTime();
$dateOk = ($now > $entretien->getDateEntretien());
$validationResponsable   = $entretien->getValidationByType(EntretienProfessionnelConstant::VALIDATION_RESPONSABLE);
$validationObservation   = $entretien->getValidationByType(EntretienProfessionnelConstant::VALIDATION_OBSERVATION);
$validationHierarchie    = $entretien->getValidationByType(EntretienProfessionnelConstant::VALIDATION_DRH);
$validationAgent         = $entretien->getValidationByType(EntretienProfessionnelConstant::VALIDATION_AGENT);
?>

<h2 class="page-header-tab"> Validations </h2>

<?php if ($canValiderDrh === null) : ?>
    <div class="alert alert-warning">
        <span class="icon attention"> </span>
        La validation de l'entretien professionnel provoquent un blocage des saisies de celui-ci.
    </div>
<?php endif; ?>

<div>
    <h3 class="categorie"> Validation du responsable de l'entretien professionnel </h3>

    <?php if ($validationResponsable === null) : ?>
        <div class="alert alert-info">
           <span class="icon information"></span>
            Le reponsable de l'entretien est soit le&middot;a supérieur&middot;e hiérarchique direct&middot;e de l'agent soit une personne nommée en remplacement de le&middot;a supérieur&middot;e hiérarchique direct&middot;e.
        </div>
    <?php endif; ?>

    <?php if ($validationResponsable !== null) : ?>
        <div class="row">
            <div class="col-md-8">
                <div class="alert alert-success">
                    <div class="col-md-5">
                        <strong>Validation effectuée</strong>
                    </div>
                    <div class="col-md-7">
                        <dl class="dl-horizontal">
                            <dt> Validateur </dt>
                            <dd> <?php echo $validationResponsable->getHistoModificateur()->getDisplayName(); ?> </dd>
                            <dt> Date </dt>
                            <dd> <?php echo $validationResponsable->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                        </dl>
                    </div>
                    <br/>
                    <br/>
                </div>
            </div>
            <div class="pull-right">
                <?php if ($canValiderResponsable and $validationObservation === null and $validationHierarchie === null) : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $validationResponsable->getId()], [], true); ?>"
                                class="btn btn-danger action"
                        >
                            <span class="icon validation-undo"></span>
                            Révoquer la validation
                        </a>
                <?php endif; ?>
            </div>
        </div>
    <?php else : ?>
        <a
            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::validerElementAction() */ ?>
                href="<?php echo $this->url('entretien-professionnel/valider-element', ['entretien' => $entretien->getId(), 'type' => EntretienProfessionnelConstant::VALIDATION_RESPONSABLE], [], true); ?>"
                class="btn btn-success action ajax-modal"
                data-event="modification"
        >
            <span class="icon validation-do"></span>
            Validation du responsable
        </a>
    <?php endif; ?>
</div>

<?php
    // délai ////////////////////////////////////////////////////////////////////////////////////////////////////////
    $now = new DateTime();
    $date = $entretien->getMaxSaisiObservation();
    $depasse = ($date === null OR $date < $now);
?>

<div>
    <h3 class="categorie"> Expression des observations </h3>

    <?php if ($validationObservation === null) :?>
        <div class="alert alert-info">
            <span class="icon information"></span>
            L'expression d'observations et leur validation n'est possible que durant les 8 jours suivants la validation de l'entretien professionnel par son responsable.
        </div>
    <?php endif; ?>

    <?php if ($validationObservation !== null) : ?>
        <div class="row">
            <div class="col-md-8">
                <div class="alert alert-success">
                    <div class="col-md-5">
                        <strong>Observations faites</strong>
                    </div>
                    <div class="col-md-7">
                        <dl class="dl-horizontal">
                            <dt> Validateur </dt>
                            <dd> <?php echo $validationObservation->getHistoModificateur()->getDisplayName(); ?> </dd>
                            <dt> Date </dt>
                            <dd> <?php echo $validationObservation->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                        </dl>
                    </div>
                    <br/>
                    <br/>
                </div>
            </div>
            <div class="pull-right">
                <?php if ($canValiderAgent and $validationHierarchie === null) : ?>
                        <a
                            <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                                href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $validationObservation->getId()], [], true); ?>"
                                class="btn btn-danger action"
                        >
                            <span class="icon validation-undo"></span>
                            Révoquer la validation
                        </a>
                <?php endif; ?>
            </div>
        </div>
    <?php else :?>
            <p>
                Pour exprimer et valider vos observations (facultatives) rendez vous dans l'onglet
                <a href="<?php echo $this->url('entretien-professionnel/renseigner', ['entretien-professionnel' => $entretien->getId()], ['fragment' => 'avis'], true); ?>"><em>Observations</em></a>.
            </p>
    <?php endif; ?>
</div>


<div>
    <h3 class="categorie"> Validation de l'autorité hiérarchique </h3>

    <?php if ($validationHierarchie === null) : ?>
        <div class="alert alert-info">
            <span class="icon information"></span>
            La validation de l'entretien professionnel par l'autorité hérarchique n'est possible d'après la validation des observations (ou un délai de 8 jours depuis la validation de l'entretien professionnel par son responsable).
        </div>
    <?php endif; ?>

    <?php if ($validationHierarchie !== null) : ?>
        <div class="row">
            <div class="col-md-8">
                <div class="alert alert-success">
                    <div class="col-md-5">
                        <strong>Validation effectuée</strong>
                    </div>
                    <div class="col-md-7">
                        <dl class="dl-horizontal">
                            <dt> Validateur </dt>
                            <dd> <?php echo $validationHierarchie->getHistoModificateur()->getDisplayName(); ?> </dd>
                            <dt> Date </dt>
                            <dd> <?php echo $validationHierarchie->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                        </dl>
                    </div>
                    <br/>
                    <br/>
                </div>
            </div>
            <div class="pull-right">
                <?php if ($validationAgent === null) : ?>
                    <a
                        <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                            href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $validationHierarchie->getId()], [], true); ?>"
                            class="btn btn-danger action"
                    >
                        <span class="icon validation-undo"></span>
                        Révoquer la validation
                    </a>
                <?php endif; ?>
            </div>
        </div>
   <?php else : ?>
        <?php if ($validationResponsable AND ($validationObservation !== null OR $depasse)) : ?>
            <a
                <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::validerElementAction() */ ?>
                    href="<?php echo $this->url('entretien-professionnel/valider-element', ['entretien' => $entretien->getId(), 'type' => EntretienProfessionnelConstant::VALIDATION_DRH], [], true); ?>"
                    class="btn btn-success action ajax-modal"
                    data-event="modification"
            >
                <span class="icon validation-do"></span>
                Validation du responsable
            </a>
        <?php endif; ?>
    <?php endif; ?>
</div>

<div>
    <h3 class="categorie"> Validation de l'agent </h3>

    <?php if ($validationAgent === null) : ?>
        <div class="alert alert-info">
            <span class="icon information"></span>
            La validation de l'entretien professionnel par l'agent n'est possible qu'après la validation de l'autorité hiérarchique.
        </div>
    <?php endif; ?>

    <?php if ($validationAgent !== null) : ?>
        <div class="row">
            <div class="col-md-8">
                <div class="alert alert-success">
                    <div class="col-md-5">
                        <strong>Validation effectuée</strong>
                    </div>
                    <div class="col-md-7">
                        <dl class="dl-horizontal">
                            <dt> Validateur </dt>
                            <dd> <?php echo $validationAgent->getHistoModificateur()->getDisplayName(); ?> </dd>
                            <dt> Date </dt>
                            <dd> <?php echo $validationAgent->getHistoModification()->format('d/m/y à H:i:s'); ?> </dd>
                        </dl>
                    </div>
                    <br/>
                    <br/>
                </div>
            </div>
            <div class="pull-right">
                <?php if ($canValiderAgent AND $entretien->getCampagne()->estEnCours()) : ?>
                    <a
                        <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::revoquerValidationAction() */ ?>
                            href="<?php echo $this->url('entretien-professionnel/revoquer-validation', ['validation' => $validationAgent->getId()], [], true); ?>"
                            class="btn btn-danger action"
                    >
                        <span class="icon validation-undo"></span>
                        Révoquer la validation
                    </a>
                <?php endif; ?>
            </div>
        </div>
    <?php else : ?>
        <?php if ($validationHierarchie !== null) : ?>
            <a
                <?php /** @see \EntretienProfessionnel\Controller\EntretienProfessionnelController::validerElementAction() */ ?>
                    href="<?php echo $this->url('entretien-professionnel/valider-element', ['entretien' => $entretien->getId(), 'type' => EntretienProfessionnelConstant::VALIDATION_AGENT], [], true); ?>"
                    class="btn btn-success action ajax-modal"
                    data-event="modification"
            >
                <span class="icon validation-do"></span>
                Validation de l'agent
            </a>
        <?php endif; ?>
    <?php endif; ?>
</div>