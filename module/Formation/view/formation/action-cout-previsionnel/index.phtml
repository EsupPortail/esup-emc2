<?php

use Formation\Entity\Db\ActionCoutPrevisionnel;
use Formation\Entity\Db\Formation;
use Formation\Entity\Db\PlanDeFormation;

/**
 * @see \Formation\Controller\ActionCoutPrevisionnelController::indexAction();
 * @var ActionCoutPrevisionnel[] $actionsCoutsPrevisionnels
 * @var PlanDeFormation[] $plans
 * @var Formation[] $actions
 * @var array $params
 */

$this->headTitle("Coûts prévisionnels associés aux actions de formations");

//todo privileges
$canAjouter = true;
$canAfficherAction = true;
$canAfficherPlan = true;
$canModifier = true;
$canHistoriser = true;
$canSupprimer = true;

$coutTotal = 0;

?>

<h1 class="page-header">
    Coûts prévisionnels associés aux actions de formations
</h1>

<?php echo $this->partial('partial/filtre', ['plans' => $plans, 'actions' => $actions, 'params' => $params]); ?>

<?php if ($canAjouter) : ?>
    <?php /** @see \Formation\Controller\ActionCoutPrevisionnelController::ajouterAction() */ ?>
    <a href="<?php echo $this->url("formation/action-cout-previsionnel/ajouter", [],[],true); ?>"
        class="btn btn-primary ajax-modal" data-event="modification"
    >
        <span class="icon icon-ajouter"></span>
        Ajouter un coût prévisionnel
    </a>
<?php endif; ?>

<span class="todo">Ajout depuis fiche d'une action</span>
<span class="todo">Afficher sur les fiches actions</span>
<span class="todo">PRIVILEGES !!!</span>

<?php if (empty($actionsCoutsPrevisionnels)) : ?>
    <div class="alert alert-info">
        Aucun coût prévisionnel
    </div>
<?php else : ?>
    <table class="table table-condensed datatable">
        <thead>
        <tr>
            <th> Plan de formation </th>
            <th> Action </th>
            <th> Coût par session </th>
            <th> Nombre de session </th>
            <th> Coût prévisionnel </th>
            <th class="action" style="width:10rem;"> Action </th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($actionsCoutsPrevisionnels as $actionCoutPrevisionnel): ?>
            <tr class=" <?php if ($actionCoutPrevisionnel->estHistorise()) echo ' historise '; ?> ">
                <td>
                    <?php if ($actionCoutPrevisionnel->getPlan()) : ?>
                        <?php echo $actionCoutPrevisionnel->getPlan()->getAnnee(); ?>
                    <?php else : ?>
                        Aucun plan de formation
                    <?php endif; ?>
                </td>
                <td>
                    <?php if ($actionCoutPrevisionnel->getAction()) : ?>
                        <?php echo $actionCoutPrevisionnel->getAction()->getLibelle(); ?>
                    <?php else : ?>
                        Aucune action de formation
                    <?php endif; ?>
                </td>
                <td>
                    <?php
                        $cout =  $actionCoutPrevisionnel->getCoutParSession();
                        echo number_format($cout,2,',',' ');
                    ?> €
                </td>
                <td> <?php echo $actionCoutPrevisionnel->getNombreDeSession(); ?> </td>
                <td>
                    <?php
                        $cout = $actionCoutPrevisionnel->getCoutParSession() * $actionCoutPrevisionnel->getNombreDeSession();
                        $coutTotal += $cout;
                        echo number_format($cout,2,',',' ');
                    ?> €
                </td>
                <td class="action">
                    <?php if ($canAfficherAction) : ?>
                        <?php /** @see \Formation\Controller\FormationController::afficherAction() */ ?>
                        <a href="<?php echo $this->url('formation/afficher', ['formation' => $actionCoutPrevisionnel->getAction()->getId()], [], true); ?>">
                            <span class="icon icon-voir"></span>
                            Action de formation
                        </a>
                    <?php endif; ?>
                    <?php if ($actionCoutPrevisionnel->getPlan()) : ?>
                        <?php if ($canAfficherPlan) : ?>
                            <br>
                            <?php /** @see \Formation\Controller\PlanDeFormationController::afficherAction() */ ?>
                            <a href="<?php echo $this->url('plan-de-formation/afficher', ['plan-de-formation' => $actionCoutPrevisionnel->getPlan()->getId()], [], true); ?>">
                            <span class="icon icon-voir"></span>
                            Plan de formation
                        <?php endif; ?>
                    <?php endif; ?>
                    <?php if ($canModifier) : ?>
                    <br>
                        <?php /** @see \Formation\Controller\ActionCoutPrevisionnelController::modifierAction() */ ?>
                        <a href="<?php echo $this->url("formation/action-cout-previsionnel/modifier", ['action-cout-previsionnel' => $actionCoutPrevisionnel->getId()],[],true); ?>"
                           class="ajax-modal" data-event="modification"
                        >
                            <span class="icon icon-modifier"></span>
                            Modifier
                        </a>
                    <?php endif; ?>
                    <?php if ($canHistoriser) : ?>
                        <br>
                        <?php if ($actionCoutPrevisionnel->estNonHistorise()) : ?>
                            <?php /** @see \Formation\Controller\ActionCoutPrevisionnelController::historiserAction() */ ?>
                            <a href="<?php echo $this->url("formation/action-cout-previsionnel/historiser", ['action-cout-previsionnel' => $actionCoutPrevisionnel->getId()],[],true); ?>"
                            >
                                <span class="icon icon-historiser"></span>
                                Historiser
                            </a>
                        <?php else : ?>
                            <?php /** @see \Formation\Controller\ActionCoutPrevisionnelController::restaurerAction() */ ?>
                            <a href="<?php echo $this->url("formation/action-cout-previsionnel/restaurer", ['action-cout-previsionnel' => $actionCoutPrevisionnel->getId()],[],true); ?>"
                            >
                                <span class="icon icon-restaurer"></span>
                                Restaurer
                            </a>
                        <?php endif; ?>
                    <?php endif; ?>
                    <?php if ($canSupprimer) : ?>
                        <br>
                        <?php /** @see \Formation\Controller\ActionCoutPrevisionnelController::supprimer() */ ?>
                        <a href="<?php echo $this->url("formation/action-cout-previsionnel/supprimer", ['action-cout-previsionnel' => $actionCoutPrevisionnel->getId()],[],true); ?>"
                           class="ajax-modal" data-event="modification"
                        >
                            <span class="text-danger">
                                <span class="icon icon-unchecked"></span>
                                Supprimer
                            </span>
                        </a>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
<?php endif; ?>

<div class="cout">
<dl class="row">
    <dt class="col-md-3">
        Coût total :
    </dt>
    <dd class="col-md-3"><?php echo number_format($coutTotal,2,',',' '); ?> €</dd>
</dl>
</div>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>
