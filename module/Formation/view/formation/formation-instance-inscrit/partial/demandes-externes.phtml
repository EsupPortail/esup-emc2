<?php

/**
 * @var Agent $agent
 * @var DemandeExterne[] $demandes
 */

use Application\Entity\Db\Agent;
use Formation\Entity\Db\DemandeExterne;
use Formation\Provider\Etat\DemandeExterneEtats;
use Formation\Provider\Privilege\DemandeexternePrivileges;

$canAjouterDemande      = $this->isAllowed(DemandeexternePrivileges::getResourceId(DemandeexternePrivileges::DEMANDEEXTERNE_AJOUTER));

?>

<h2>
    S'inscire à un stage hors du plan de formation
</h2>

<div class="row">
<div class="col-md-7">
    Afin de réaliser une demande de formation hors plan de formation, vous devez trouver au <em>moins trois</em> organismes et déposer les devis.
</div>
<div class="col-md-5">
    <?php /** @see \Formation\Controller\DemandeExterneController::ajouterAction() */ ?>
    <a href="<?php echo $this->url('formation/demande-externe/ajouter', ['agent' => $agent->getId()], [], true); ?>"
       class="btn btn-primary ajax-modal <?php if (!$canAjouterDemande) echo " disabled "; ?> " data-event="modification"
    >
        <span class="icon icon-ajouter"></span>
        Je remplis le formulaire
    </a>
</div>
</div>

<br/>

<h2> Demandes que je n'ai pas encore validée </h2>

<?php foreach($demandes as $demande) : ?>
    <div class="row">
        <div class="col-md-7 description">
            <?php echo $this->etatbadge($demande->getEtat()); ?>
            <?php echo $demande->getLibelle(); ?> (<?php echo $demande->getOrganisme(); ?>)
            <br/>
            <?php echo $demande->getLieu(); ?> ( du <?php echo $demande->getDebut()->format('d/m/Y'); ?> au <?php echo $demande->getFin()->format('d/m/Y'); ?>)
            <br/>
            Créée le <?php echo $demande->getHistoCreation()->format('d/m/Y à H:i'); ?>
            <br/>
            <br/>
        </div>
        <div class="col-md-5">
            <?php
                $canModifierDemande = $this->isAllowed($demande, DemandeexternePrivileges::DEMANDEEXTERNE_MODIFIER);
                $canValiderAgentDemande = $this->isAllowed($demande, DemandeexternePrivileges::DEMANDEEXTERNE_VALIDER_AGENT);
                $canHistoriserDemande = $this->isAllowed($demande, DemandeexternePrivileges::DEMANDEEXTERNE_HISTORISER);
            ?>
            <?php /** @see \Formation\Controller\DemandeExterneController::validerAgentAction() */?>
            <a  href="<?php echo $this->url('formation/demande-externe/valider-agent', ['demande-externe' => $demande->getId()], [], true); ?>"
                class="btn btn-success ajax-modal <?php if (!$canValiderAgentDemande) echo " disabled "; ?> " data-event="modification">
                <span class="icon icon-valider"></span>
                Valider la demande (Agent)
            </a>
            <?php /** @see \Formation\Controller\DemandeExterneController::modifierAction() */?>
            <a  href="<?php echo $this->url('formation/demande-externe/modifier', ['demande-externe' => $demande->getId()], [], true); ?>"
                class="btn btn-primary ajax-modal <?php if (!$canModifierDemande) echo " disabled "; ?> " data-event="modification">
                <span class="icon icon-modifier"></span>
                Modifier la demande
            </a>
            <?php /** @see \Formation\Controller\DemandeExterneController::historiserAction() */?>
            <a  href="<?php echo $this->url('formation/demande-externe/historiser', ['demande-externe' => $demande->getId()], [], true); ?>"
                class="btn btn-danger <?php if (!$canHistoriserDemande) echo " disabled "; ?> ">
                <span class="icon icon-historiser"></span>
                Supprimer la demande
            </a>
            <br/>
            <br/>
        </div>
    </div>
<?php endforeach; ?>


