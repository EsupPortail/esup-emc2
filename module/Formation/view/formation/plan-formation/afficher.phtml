<?php

use Formation\Entity\Db\Formation;
use Formation\Entity\Db\FormationAbonnement;
use Formation\Entity\Db\FormationGroupe;
use Formation\Entity\Db\FormationInstance;
use Formation\Provider\Privilege\FormationabonnementPrivileges;

/**
 * @see \Formation\Controller\PlanFormationController::afficherAction()
 * @var FormationGroupe[] $groupes
 * @var Formation[] $formations
 * @var FormationInstance[] $sessions
 * @var FormationAbonnement[] $abonnements
 * @var string $annee
 */

$this->headTitle("Plan de formation pour l'année " . $annee);

$canListerParFormation = $this->isAllowed(FormationabonnementPrivileges::getResourceId(FormationabonnementPrivileges::FORMATIONABONNEMENT_LISTE_FORMATION));
$canGererAbonnement = $this->isAllowed(FormationabonnementPrivileges::getResourceId(FormationabonnementPrivileges::FORMATIONABONNEMENT_GERER));
$canAbonner = $this->isAllowed(FormationabonnementPrivileges::getResourceId(FormationabonnementPrivileges::FORMATIONABONNEMENT_ABONNER));
$canDesabonner = $this->isAllowed(FormationabonnementPrivileges::getResourceId(FormationabonnementPrivileges::FORMATIONABONNEMENT_DESABONNER));

?>

<h1 class="page-header">
    Plan de formation pour l'année <?php echo $annee; ?>
</h1>

<?php echo $this->messenger()->addMessagesFromFlashMessenger(); ?>

<?php if ($canGererAbonnement) : ?>
    <?php /** @see \Formation\Controller\AbonnementController::ajouterAction() */ ?>
    <a href="<?php echo $this->url('formation/abonnement/ajouter', [], [], true); ?>"
        class="btn btn-primary ajax-modal" data-event="modification"
    >
        <span class="icon icon-ajouter"></span>
        Abonner un agent
    </a>
<?php endif; ?>

<?php /** @see \Formation\Controller\AbonnementController::listerAbonnementsParAgentAction() */ ?>
<a href="<?php echo $this->url('formation/abonnement/lister-abonnements-par-agent', [], [], true); ?>"
   class="btn btn-primary ajax-modal" data-event="modification"
>
    <span class="icon icon-listing"></span>
    Lister mes abonnements
</a>

<?php foreach ($groupes as $groupe) : ?>
    <ul>
        <li>
            <span class="groupe"> <?php echo $groupe->getLibelle(); ?></span>
            (<?php echo count($formations[$groupe->getId()]); ?> formations)
            <ul>
                <?php foreach ($formations[$groupe->getId()] as $formation) : ?>
                    <li>
                        <span class="formation"> <?php echo $formation->getLibelle(); ?> </span>
                        (<?php echo count($sessions[$formation->getId()]); ?> sessions)

                        <?php
                            $abonnement = null;
                            foreach ($abonnements as $abonnement_) {
                                if ($abonnement_->getFormation() === $formation) {
                                    $abonnement = $abonnement_;
                                    break;
                                }
                            }
                        ?>

                        <?php if ($abonnement !== null) : ?>
                            <span class="icon icon-checked text-success" title="Vous êtes abonné·e aux notifications liées à cette formation"></span>
                        <?php endif; ?>

                        <?php if ($canListerParFormation) : ?>
                            <?php /** @see \Formation\Controller\AbonnementController::listerAbonnementsParFormationAction() */ ?>
                            <a href="<?php echo $this->url('formation/abonnement/lister-abonnements-par-formation', ['formation' => $formation->getId()], [], true); ?>"
                               class="ajax-modal"
                            >
                                <span class="icon icon-listing" title="lister les abonnements pour cette formation"></span></a>
                        <?php endif; ?>

                        <?php if ($canAbonner AND $abonnement === null) : ?>
                            <?php /** @see \Formation\Controller\AbonnementController::ajouterAction() */ ?>
                            <a href="<?php echo $this->url('formation/abonnement/ajouter', ['formation' => $formation->getId()], [], true); ?>"
                               class="btn btn-sm btn-primary"
                            >
                                <span class="icon icon-plus" title="S'abonner aux notifications liées à la formation"></span>
                                S'abonner aux notifications
                            </a>
                        <?php endif; ?>

                        <?php if ($canAbonner AND $abonnement !== null) : ?>
                            <?php /** @see \Formation\Controller\AbonnementController::retirerAction() */ ?>
                            <a href="<?php echo $this->url('formation/abonnement/retirer', ['abonnement' => $abonnement->getId()], [], true); ?>"
                               class="btn btn-sm btn-primary"
                            >
                                <span class="icon icon-minus" title="Se désabonner des notifications liées à la formation"></span>
                                Se désabonner des notifications
                            </a>
                        <?php endif; ?>

                    </li>
                <?php endforeach; ?>
            </ul>
        </li>
    </ul>
<?php endforeach; ?>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>
