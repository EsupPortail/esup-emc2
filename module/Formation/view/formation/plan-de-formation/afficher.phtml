<?php

/**
 * @see \Formation\Controller\PlanDeFormationController::afficherAction()
 * @var PlanDeFormation $plan
 * @var FormationGroupe[] $groupes
 * @var Formation[]  $formations
 * @var Formation[] $formationsArrayByGroupe @desc $groupeId => Formation[]
 * @var Formation[] $sessionsArrayByFormation @desc $formationId => FormationInstance[]
 */

use Formation\Entity\Db\Formation;
use Formation\Entity\Db\FormationGroupe;
use Formation\Entity\Db\PlanDeFormation;
use Formation\Provider\Privilege\PlanformationPrivileges;

$canIndex = $this->isAllowed(PlanformationPrivileges::getResourceId(PlanformationPrivileges::PLANFORMATION_INDEX));
$canAjouterFormation = $this->isAllowed(PlanformationPrivileges::getResourceId(PlanformationPrivileges::PLANFORMATION_MODIFIER));
$canReprendre = $this->isAllowed(PlanformationPrivileges::getResourceId(PlanformationPrivileges::PLANFORMATION_MODIFIER));

?>

<h1 class="page-header">
    Plan de formation
    <span class="highlight plan-de-formation">
        <?php echo $plan->getAnnee(); ?>
    </span>
</h1>

<?php if ($canReprendre): ?>
    <?php /** @see \Formation\Controller\PlanDeFormationController::reprendreAction() */ ?>
    <a href="<?php echo $this->url('plan-de-formation/reprendre', ['plan-de-formation' => $plan->getId()], ['force_canonical' => true], true); ?>"
       class="btn btn-primary ajax-modal" data-event="modification">
        Reprendre les formations d'un autre plan de formation
    </a>
<?php endif; ?>

<?php if ($canAjouterFormation): ?>
    <?php /** @see \Formation\Controller\PlanDeFormationController::gererFormationsAction() */ ?>
    <a href="<?php echo $this->url('plan-de-formation/gerer-formations', ['plan-de-formation' => $plan->getId()], ['force_canonical' => true], true); ?>"
       class="btn btn-primary ajax-modal" data-event="modification">
        Gérer les formations
    </a>
<?php endif; ?>

<?php if ($canIndex): ?>
    <?php /** @see \Formation\Controller\PlanDeFormationController::indexAction() */ ?>
    <a href="<?php echo $this->url('plan-de-formation', [], ['force_canonical' => true], true); ?>"
       class="btn btn-secondary">
        <span class="icon icon-retour"></span>
        Retour à la liste des plans de formation
    </a>
<?php endif; ?>

<h2> Formations dans le plan </h2>

<ul>
<?php foreach ($groupes as $groupe) : ?>
    <?php if( $groupe !== null) : ?>
        <li>
            <span class="groupe"> <?php echo $groupe->getLibelle(); ?></span>
            (<?php echo count($formationsArrayByGroupe[$groupe->getId()]); ?> formations)
            <ul>
                <?php foreach ($formationsArrayByGroupe[$groupe->getId()] as $formation) : ?>
                    <li>
                        <span class="formation"> <?php echo $formation->getLibelle(); ?> </span>
                        (<?php echo count($sessionsArrayByFormation[$formation->getId()]); ?> sessions)
                    </li>
                <?php endforeach; ?>
            </ul>
        </li>
    <?php endif; ?>
<?php endforeach; ?>
</ul>

<script>
    $(function() {
        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>