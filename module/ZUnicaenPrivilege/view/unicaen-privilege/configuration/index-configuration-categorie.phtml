<?php

/**
 * @see \UnicaenPrivilege\Controller\ConfigurationController::indexConfigurationCategorieAction()
 * @var CategoriePrivilege[] $categories
 */

use UnicaenPrivilege\Entity\Db\CategoriePrivilege;
use UnicaenPrivilege\Provider\Privilege\PrivilegePrivileges;

$this->headTitle("Configuration des catégories de privilèges");

$canGerer       = $this->isAllowed(PrivilegePrivileges::getResourceId(PrivilegePrivileges::PRIVILEGE_VOIR));
$canAjouter     = $this->isAllowed(PrivilegePrivileges::getResourceId(PrivilegePrivileges::PRIVILEGE_AJOUTER));
$canModifier    = $this->isAllowed(PrivilegePrivileges::getResourceId(PrivilegePrivileges::PRIVILEGE_MODIFIER));
$canDetruire    = $this->isAllowed(PrivilegePrivileges::getResourceId(PrivilegePrivileges::PRIVILEGE_SUPPRIMER));
$canProvider    = $this->isAllowed(PrivilegePrivileges::getResourceId(PrivilegePrivileges::PRIVILEGE_VOIR));
?>

<h1 class="page-header">
    Configuration des catégories de privilèges
</h1>

<div class="main">

    <?php if ($canAjouter): ?>
        <div class="row">
            <?php /** @see ConfigurationController::creerCategorieAction() */ ?>
            <a href="<?php echo $this->url('configuration-categorie/creer', [], [], true); ?>"
               class="btn btn-primary action ajax-modal"
               data-event="modification"
           >
                <span class="icon ajouter"></span>
                Ajouter une catégorie
            </a>
        </div>
    <?php endif; ?>

    <table class="table table-condensed">
        <thead>
            <tr>
                <th> Libellé </th>
                <th> Code </th>
                <th> Ordre </th>
                <th> Namespace </th>
                <th> #Privilège </th>
                <th> Action </th>
            </tr>
        </thead>
        <tbody>
        <?php foreach ($categories as $categorie) : ?>
            <tr>
                <td> <?php echo $categorie->getLibelle(); ?> </td>
                <td> <?php echo $categorie->getCode(); ?> </td>
                <td> <?php echo $categorie->getOrdre(); ?> </td>
                <td> <?php echo $categorie->getNamespace(); ?> </td>
                <td> <?php echo count($categorie->getPrivilege()); ?> </td>
                <td>
                    <?php if ($canGerer) : ?>
                        <?php /** @see ConfigurationController::modifierCategorieAction() */ ?>
                        <a href="<?php echo $this->url('configuration-categorie/gerer', ['categorie' => $categorie->getId()], [], true); ?>">
                        <span class="icon gerer" title="Gérer la catégorie [<?php echo htmlentities($categorie->getLibelle()); ?>]" ></span></a>
                    <?php else : ?>
                        <span class="icon gerer" style="color:lightgrey;"></span>
                    <?php endif; ?>
                    <?php if ($canProvider) : ?>
                        <?php /** @see ConfigurationController::providerAction() */ ?>
                        <a href="<?php echo $this->url('configuration-categorie/provider', ['categorie' => $categorie->getId()], [], true); ?>" class="ajax-modal">
                            <span class="icon code" title="Afficher le fichier provider de  [<?php echo htmlentities($categorie->getLibelle()); ?>]" ></span></a>
                    <?php else : ?>
                        <span class="icon code" style="color:lightgrey;"></span>
                    <?php endif; ?>
                    <?php if ($canModifier) : ?>
                        <?php /** @see ConfigurationController::modifierCategorieAction() */ ?>
                        <a href="<?php echo $this->url('configuration-categorie/modifier', ['categorie' => $categorie->getId()], [], true); ?>"
                           class="ajax-modal" data-event="modification" style="/**display:none;**/">
                        <span class="icon editer" title="Éditer la catégorie [<?php echo htmlentities($categorie->getLibelle()); ?>]"></span></a>
                    <?php else : ?>
                        <span class="icon editer" style="color:lightgrey;"></span>
                    <?php endif; ?>
                    <?php if ($canDetruire /** AND empty($categorie->getPrivilege()) */) : ?>
                        <?php /** @see ConfigurationController::detruireCategorieAction() */ ?>
                        <a href="<?php echo $this->url('configuration-categorie/detruire', ['categorie' => $categorie->getId()], [], true); ?>"
                           class="ajax-modal" data-event="modification">
                        <span class="icon detruire" title="Détruire la catégorie [<?php echo htmlentities($categorie->getLibelle()); ?>]"></span></a>
                    <?php else : ?>
                        <span class="icon detruire" style="color:lightgrey;"></span>
                    <?php endif; ?>
                </td>
            </tr>

        <?php endforeach; ?>
        </tbody>
    </table>
</div>

<script>
    $(function() {
        // $('a.ajax-modal').css('display', 'inline');

        $("body").on("modification", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>