# Version 5.2.0 (18/02/2026) 

## Changements 

[NOUVEAUTE]
* Nouvelle macro pour une mention du caractère facultatif d'un entretien professionnel

[EVOLUTION]
* L'identifiant (clef primaire) des structures est maintenant une chaîne de caractères.

[CORRECTION]
* Clarification de l'historique des chaînes hiérarchiques présentées sur la page de l'agent. 

## Modification de la configuration

Aucun

## Modification structurelle en BD

### Sans BddAdmin

Passage à `unicaen/fichier` pour permettre le stockage via S3 des futures instances déployées en SaaS.
```postgresql

-- ---------------------------------------------------------------------------------------------------------------------
-- Bascule vers unicaen/fichier
-- ---------------------------------------------------------------------------------------------------------------------

alter table fichier_nature rename to unicaen_fichier_nature;
alter sequence fichier_nature_id_seq rename to unicaen_fichier_nature_id_seq;
alter table unicaen_fichier_nature add column ordre int default 9999;
alter table fichier_fichier rename to unicaen_fichier_fichier;

-- ---------------------------------------------------------------------------------------------------------------------
-- Modification de la clef primaire de la table `structure`.
-- ---------------------------------------------------------------------------------------------------------------------
    
-- Remarques : si vous avez des indicateurs portant ou référant des structures, il faut dropper les vues matérialisées associées (elles seront recréées lors de leur rafraîchissement).

-- Retrait des contraintes de clefs étrangères
ALTER TABLE structure_observateur  DROP CONSTRAINT structure_observateur_structure_id_fk;
ALTER TABLE structure_contact  DROP CONSTRAINT structure_contact_structure_id_fk;
ALTER TABLE entretienprofessionnel_delegue  DROP CONSTRAINT entretienprofessionnel_delegue_structure_id_fk;
ALTER TABLE poste  DROP CONSTRAINT poste_structure_source_id_fk;
    
-- Changement de type
ALTER TABLE structure ALTER COLUMN id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN parent_id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN niv2_id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN niv2_id_ow TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE agent_carriere_affectation ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_carriere_grade ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_carriere_statut ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_missionspecifique ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE entretienprofessionnel_delegue ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE poste ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_agent_force ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_contact ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_ficheposte ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_gestionnaire ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_observateur ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_responsable ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
    
-- Remise des contraintes de clefs étrangères
ALTER TABLE structure ADD CONSTRAINT structure_parent_id_fk FOREIGN KEY (parent_id) REFERENCES structure(id);
ALTER TABLE structure ADD CONSTRAINT structure_niv2_id_fk FOREIGN KEY (niv2_id) REFERENCES structure(id);
ALTER TABLE structure ADD CONSTRAINT structure_niv2_id_ow_fk FOREIGN KEY (niv2_id_ow) REFERENCES structure(id);
ALTER TABLE agent_carriere_affectation ADD CONSTRAINT agent_carriere_affectation_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_carriere_grade ADD CONSTRAINT agent_carriere_grade_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_carriere_statut ADD CONSTRAINT agent_carriere_statut_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_missionspecifique ADD CONSTRAINT agent_missionspecifique_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE entretienprofessionnel_delegue ADD CONSTRAINT entretienprofessionnel_delegue_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE poste ADD CONSTRAINT  poste_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_agent_force ADD CONSTRAINT  structure_agent_force_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_contact ADD CONSTRAINT  structure_contact_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_ficheposte ADD CONSTRAINT  structure_ficheposte_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_gestionnaire ADD CONSTRAINT  structure_gestionnaire_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_observateur ADD CONSTRAINT  structure_observateur_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_responsable ADD CONSTRAINT  structure_responsable_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);

-- ---------------------------------------------------------------------------------------------------------------------
-- Niveau de fonction et code fonction 
-- ---------------------------------------------------------------------------------------------------------------------

create table carriere_niveau_fonction
(
    id                    serial
        constraint carriere_niveau_fonction_pk primary key,
    code                  varchar(64)             not null,
    libelle               varchar(1024)           not null,
    description           text,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint carriere_niveau_fonction_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint carriere_niveau_fonction_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint carriere_niveau_fonction_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);
create unique index carriere_niveau_fonction_code_unique on carriere_niveau_fonction (code) where (histo_destruction IS NULL);
alter table carriere_niveau add column categorie_id int constraint carriere_niveau_carriere_categorie_id_fk references carriere_categorie on delete set null;

create table emploirepere_codefonction
(
    id                         serial                  not null
        constraint emploirepere_codefonction_pk primary key,
    niveau_fonction_id         integer                 not null
        constraint emploirepere_codefonction_carriere_niveau_fonction_id_fk references carriere_niveau_fonction,
    famille_professionnelle_id integer                 not null
        constraint emploirepere_codefonction_metier_familleprofessionnelle_id_fk references metier_familleprofessionnelle,
    description                text,
    histo_creation             timestamp default now() not null,
    histo_createur_id          integer   default 0     not null
        constraint emploirepere_codefonction_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification         timestamp,
    histo_modificateur_id      integer
        constraint emploirepere_codefonction_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction          timestamp,
    histo_destructeur_id       integer
        constraint emploirepere_codefonction_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Nouvelle table pour la gestion des référentiels "centralisées"
-- ---------------------------------------------------------------------------------------------------------------------

create table referentiel_referentiel
(
    id                    serial                  
        constraint referentiel_referentiel_pk primary key,
    libelle_court         varchar(256)            not null 
        constraint referentiel_referentiel_pk_2 unique,
    libelle_long          varchar(1024)           not null,
    couleur               varchar(256)            not null,
    description           text,
    histo_creation        timestamp                 default now() not null,
    histo_createur_id     integer                   default 0     not null
        constraint referentiel_referentiel_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint referentiel_referentiel_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint referentiel_referentiel_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- changement des liens avec les tables liées à des référentiels spécifiques
insert into referentiel_referentiel (libelle_court, libelle_long, couleur, description, histo_creation, histo_createur_id)
select libelle_court|| '_competence', libelle_long, couleur, 'Reprise du référentiel de compétence ['|| libelle_court ||'] à fusionner', coalesce(histo_modification, histo_creation), coalesce(histo_modificateur_id, histo_createur_id) from element_competence_referentiel;
alter table element_competence drop column source;
alter table element_competence rename column id_source to reference;
ALTER TABLE element_competence DROP CONSTRAINT IF EXISTS element_competence_element_competence_referentiel_id_fk;
alter table element_competence rename column referentiel_id to referentiel_id_old;
alter table element_competence add column referentiel_id int constraint element_competence_referentiel_referentiel_id_fk references referentiel_referentiel;
UPDATE element_competence ec SET referentiel_id = rr.id
FROM element_competence_referentiel ecr join referentiel_referentiel rr on rr.libelle_court = ecr.libelle_court || '_competence';
UPDATE element_competence ec SET referentiel_id = rr.id FROM element_competence_referentiel ecr JOIN referentiel_referentiel rr ON rr.libelle_court = ecr.libelle_court || '_competence' WHERE ec.histo_destruction IS NULL;
-- select referentiel_id, rr.libelle_court, referentiel_id_old, ecr.libelle_court from element_competence ec left join referentiel_referentiel rr on ec.referentiel_id = rr.id join element_competence_referentiel ecr on referentiel_id_old = ecr.id
alter table element_competence drop column referentiel_id_old;
drop table element_competence_referentiel cascade;

insert into referentiel_referentiel (libelle_court, libelle_long, couleur, description, histo_creation, histo_createur_id)
select libelle_court || '_metier', libelle_long, 'gray', 'Reprise du référentiel de métier ['|| libelle_court ||'] à fusionner', coalesce(histo_modification, histo_creation), coalesce(histo_modificateur_id, histo_createur_id) from metier_referentiel;
alter table fichemetier add column reference varchar(256);
alter table fichemetier add column referentiel_id int constraint fichemetier_referentiel_referentiel_id_fk references referentiel_referentiel;
update fichemetier fm set reference = mr.code from metier_reference mr WHERE fm.metier_id = mr.metier_id AND fm.metier_id IS NOT NULL;
UPDATE fichemetier fm SET referentiel_id = rr.id FROM metier_reference mr JOIN metier_referentiel mm ON mr.referentiel_id = mm.id JOIN referentiel_referentiel rr ON rr.libelle_court = mm.libelle_court || '_metier' WHERE fm.metier_id = mr.metier_id AND mr.histo_destruction IS NULL;
-- select fm.id, rr.libelle_court, mf.libelle_court from fichemetier fm join metier_metier mm on fm.metier_id = mm.id join referentiel_referentiel rr on fm.referentiel_id = rr.id join metier_reference mr on mm.id = mr.metier_id join metier_referentiel mf on mf.id = mr.referentiel_id and mr.histo_destruction IS NULL;
drop table metier_reference cascade;
drop table metier_referentiel cascade;

alter table missionprincipale add column referentiel_id int constraint missionprincipale_referentiel_referentiel_id_fk references referentiel_referentiel;
alter table missionprincipale add column reference varchar(256);
alter table activite add column referentiel_id int constraint activite_referentiel_referentiel_id_fk references referentiel_referentiel;
alter table activite add column reference varchar(256);

-- ---------------------------------------------------------------------------------------------------------------------
-- drop des tables devenues inutiles (abondon de la notion de fiche référentielle )
-- ---------------------------------------------------------------------------------------------------------------------
drop table fichereferentiel_competence;
drop table fichereferentiel_fiche;

-- ---------------------------------------------------------------------------------------------------------------------
-- Modification de la partie application
-- ---------------------------------------------------------------------------------------------------------------------

alter table  element_application rename column groupe_id to theme_id;    

-- ---------------------------------------------------------------------------------------------------------------------
-- Introduction de la notion de discipline pour les compétences
-- ---------------------------------------------------------------------------------------------------------------------

create table element_competence_discipline
(
    id  serial not null
        constraint competence_discipline_pk primary key,
    libelle               varchar(256)                                                         not null,
    description           text                                                      not null,
    histo_creation        timestamp                                                            not null,
    histo_createur_id     integer                                                              not null
        constraint competence_discipline_createur_fk references unicaen_utilisateur_user,
    histo_modification    timestamp                                                            not null,
    histo_modificateur_id integer
        constraint competence_discipline_modificateur_fk references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint competence_discipline_user_id_fk references unicaen_utilisateur_user
);
create unique index competence_discipline_id_uindex on element_competence_discipline (id);

alter table element_competence add discipline_id integer 
    constraint element_competence_element_competence_discipline_id_fk references element_competence_discipline on delete set null;

-- ---------------------------------------------------------------------------------------------------------------------
-- Table de gestions des synonymes 
-- ---------------------------------------------------------------------------------------------------------------------

create table element_competence_synonyme
(
    id            serial
        constraint element_competence_synonyme_pk
            primary key,
    competence_id integer not null
        constraint element_competence_synonyme_element_competence_id_fk
            references element_competence
            on delete cascade,
    libelle       integer
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Nouvelles colonnes pour l'import des compétences + alteration des types
-- ---------------------------------------------------------------------------------------------------------------------

alter table element_competence add raw text;
alter table element_competence add synonymes text;
alter table element_competence_type add code varchar(64) not null default 'TYPE';

update element_competence_type set code='CONN' where libelle='Connaissances';
update element_competence_type set code='COMP' where libelle='Savoir être';
update element_competence_type set code='OPER' where libelle='Savoir faire';
INSERT INTO element_competence_type (code, libelle, ordre) VALUES ('SPEC', 'Compétences spécifiques', 1000);

alter table element_competence add codes_emploi_type text;
alter table element_competence add codes_fonction text;

------------------------------------------------------------------------------------------------------------------------
-- MODIFICATION ET REPRISE DES MISSIONS PRINCIPALES
------------------------------------------------------------------------------------------------------------------------

-- sauvegarde des données précédentes
alter table missionprincipale rename to missionprincipale_old;
alter table missionprincipale_old rename constraint missionprincipale_pk to missionprincipale_old_pk;
alter table fichemetier_mission rename to fichemetier_mission_old;
-- au besoin
-- alter table fichemetier_mission_old rename constraint fichemetier_mission_pk to fichemetier_mission_old_pk;

-- elagage de tables abandonnées
drop table missionprincipale_application;
drop table missionprincipale_competence;
drop table missionprincipale_domaine;

-- création des nouvelles tables

create table missionprincipale
(
    id  serial not null
        constraint missionprincipale_pk primary key,
    libelle               varchar(1024),
    niveau_id             integer
        constraint missionprincipale_carriere_niveau_enveloppe_id_fk references carriere_niveau_enveloppe on delete cascade,
    referentiel_id        integer
        constraint missionprincipale_referentiel_referentiel_id_fk references referentiel_referentiel,
    reference             varchar(256),
    codes_fonction        text,
    codes_fiche_metier    text,
    description           text,
    histo_creation        timestamp default now()                                         not null,
    histo_createur_id     integer   default 0                                             not null
        constraint missionprincipale_unicaen_utilisateur_user_id_fk3 references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint missionprincipale_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint missionprincipale_unicaen_utilisateur_user_id_fk2 references unicaen_utilisateur_user,
    source_string         text
);

create table missionprincipale_familleprofessionnelle
(
    mission_id integer not null
        constraint mpfp_missionprincipale_id_fk references missionprincipale on delete cascade,
    famille_id integer not null
        constraint mpfp_metier_familleprofessionnelle_id_fk references metier_familleprofessionnelle on delete cascade,
    constraint missionprincipale_familleprofessionnelle_pk primary key (mission_id, famille_id)
);

create table missionprincipale_element
(
    id                    serial
        constraint missionprincipale_element_pk primary key,
    mission_id            integer                 not null
        constraint missionprincipale_element_missionprincipale_id_fk references missionprincipale on delete cascade,
    description           text,
    position              integer   default 9999  not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint missionprincipale_element_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint missionprincipale_element_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint missionprincipale_element_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

create table fichemetier_mission
(
    fichemetier_id     integer not null
        constraint fichemetier_mission_fichemetier_id_fk references fichemetier on delete cascade,
    mission_element_id integer not null
        constraint fichemetier_mission_mission_element_id_fk references missionprincipale_element on delete cascade,
    constraint fichemetier_mission_pk
        primary key (fichemetier_id, mission_element_id)
);

-- ajout de colonne de travail
alter table missionprincipale add old_id integer;
comment on column missionprincipale.old_id is 'sert pour la reprise de données (peut être supprimée par la suite)';
alter table missionprincipale_element add fichemetier_id integer;
comment on column missionprincipale_element.fichemetier_id is 'sert pour la reprise de données (peut être supprimée par la suite)';

-- recopie des données
insert into missionprincipale (libelle, niveau_id, referentiel_id, reference ,histo_creation, histo_createur_id, histo_modification, histo_modificateur_id, histo_destruction, histo_destructeur_id, old_id)
select libelle, niveau_id, referentiel_id, reference ,histo_creation, histo_createur_id, histo_modification, histo_modificateur_id, histo_destruction, histo_destructeur_id, id from missionprincipale_old;
insert into missionprincipale_element (mission_id, position, fichemetier_id, description)
select m.id, fmo.ordre, fmo.fichemetier_id, '5.1.0 fichemetier_mission id:' || fmo.id from fichemetier_mission_old fmo
join missionprincipale m on m.old_id = fmo.mission_id;
insert into fichemetier_mission (fichemetier_id, mission_element_id)
select fichemetier_id, id from missionprincipale_element;

------------------------------------------------------------------------------------------------------------------------
-- MODIFICATION ET REPRISE DES ACTIVITES
------------------------------------------------------------------------------------------------------------------------

-- deux types d'activite : missionprincipale_activite et activite
alter table activite rename to activite_old;
alter table fichemetier_activite rename to fichemetier_activite_old;

-- elagage de tables abandonnées
drop table activite_application;
drop table activite_competence;
drop table activite_domaine;    

-- creation des nouvelles tables
create table activite
(
    id                    serial
        constraint activite_pk primary key,
    libelle               varchar(4096)           not null,
    description           text,
    referentiel_id        integer
        constraint activite_metier_referentiel_id_fk references referentiel_referentiel,
    reference             varchar(128),
    codes_fiche_metier    text,
    codes_fonction        text,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint activite_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint activite_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint activite_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user,
    raw                   text
);


create table activite_element
(
    id                    serial
        constraint activite_element_pk primary key,
    activite_id           integer                 not null
        constraint activite_element_activite_id_fk references activite on delete cascade,
    description           text,
    position              integer   default 9999  not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint activite_element_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint activite_element_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint activite_element_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

create table fichemetier_activite
(
    fichemetier_id      integer not null
        constraint fichemetier_activite_fichemetier_id_fk references fichemetier on delete cascade,
    activite_element_id integer not null
        constraint fichemetier_activite_activite_element_id_fk  references activite_element on delete cascade,
    constraint fichemetier_activite_pk primary key (fichemetier_id, activite_element_id)
);

-- ajout de colonne de travail
alter table activite add old_id integer;
comment on column activite.old_id is 'sert pour la reprise de données (peut être supprimée par la suite)';
alter table activite_element add fichemetier_id integer;
comment on column activite_element.fichemetier_id is 'sert pour la reprise de données (peut être supprimée par la suite)';

-- recopie des données
insert into activite (libelle, referentiel_id, reference ,histo_creation, histo_createur_id, histo_modification, histo_modificateur_id, histo_destruction, histo_destructeur_id, old_id)
select mpa.libelle, mp.referentiel_id, mp.reference ,mpa.histo_creation, mpa.histo_createur_id, mpa.histo_modification, mpa.histo_modificateur_id, mpa.histo_destruction, mpa.histo_destructeur_id, mpa.id
from missionprincipale_activite mpa
join missionprincipale_old mp on mpa.mission_id = mp.id;
insert into activite_element (activite_id, position, fichemetier_id,description)
select a.id, coalesce(mpa.ordre,9999), fmo.fichemetier_id, '5.1.0 id mpa:' || mpa.id from missionprincipale_activite mpa
join activite a on a.old_id = mpa.id
join missionprincipale_old mp on mpa.mission_id = mp.id
join fichemetier_mission_old fmo on fmo.mission_id = mp.id;
insert into fichemetier_activite (fichemetier_id, activite_element_id)
select fichemetier_id, id from activite_element;

-- -------------------------------------------
-- MODIFICATION FICHEMETIER
-- -------------------------------------------

alter table fichemetier add libelle varchar(2048);
UPDATE fichemetier fm SET libelle = m.libelle_default 
FROM metier_metier m 
WHERE fm.metier_id = m.id;

alter table fichemetier add niveau_carriere_id int references carriere_niveau on delete set null;
UPDATE fichemetier fm SET niveau_carriere_id = e.borne_inferieure_id
FROM metier_metier m join carriere_niveau_enveloppe e on m.niveaux_id = e.id
WHERE fm.metier_id = m.id;

alter table fichemetier add column famille_id int references metier_familleprofessionnelle on delete set null;
update fichemetier set famille_id = mmf.famille_id FROM metier_metier_famille mmf join fichemetier fm on fm.metier_id = mmf.metier_id;

-- remplacement de la chaine de caractère par l'entite codefonction dans les fiches métiers
alter table fichemetier drop column  code_fonction;
alter table fichemetier add code_fonction_id integer constraint fichemetier_emploirepere_codefonction_id_fk references emploirepere_codefonction on delete set null;
alter table fichemetier add codes_emploi_type text;
alter table fichemetier add lien_web varchar(2048);
alter table fichemetier add lien_pdf varchar(2048);
alter table fichemetier add niveau_carriere_id int references carriere_niveau on delete set null;

drop table metier_metier_domaine cascade;
drop table metier_domaine_famille cascade;
drop table metier_domaine cascade;
drop table metier_metier_correspondance cascade;
drop table metier_metier_famille;
alter table fichemetier drop constraint fichetype_metier__fk;
alter table fichemetier drop column metier_id;
drop table metier_metier;

-- ---------------------------------------------------------------------------------------------------------------------
-- Preparation du travail sur les fiches de poste
-- ---------------------------------------------------------------------------------------------------------------------

drop table ficheposte_fichemetier_domaine;

-- ---------------------------------------------------------------------------------------------------------------------
-- code fonction 
-- ---------------------------------------------------------------------------------------------------------------------

alter table metier_familleprofessionnelle add correspondance_id integer;
comment on column metier_familleprofessionnelle.correspondance_id is 'idéalement devrait être non nulle (mais il y a l''existant)';
alter table metier_familleprofessionnelle add position int;

create table fichemetier_code_emploitype
(
    id                    serial                  not null
        constraint fichemetier_code_emploitype_pk primary key,
    fichemetier_id        integer                 not null
        constraint fichemetier_code_emploitype_fichemetier_id_fk references fichemetier on delete cascade,
    fonction_code         integer                 not null
        constraint fichemetier_code_emploitype_carriere_fonction_type_id_fk references carriere_niveau_fonction on delete cascade,
    complement            varchar(64)             not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint fichemetier_code_emploitype_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    Histo_modification    timestamp,
    histo_modificateur_id integer
        constraint fichemetier_code_emploitype_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint fichemetier_code_emploitype_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- ---------------------------------------------------------------------------------------------------------------------
-- RECUPERATION DES FONCTIONNALITES DES FICHES METIERS LIEES AUX ACTIVITES ET AUX MISSIONS
-- ---------------------------------------------------------------------------------------------------------------------

alter table ficheposte_fichemetier add column missions varchar(1024);
UPDATE ficheposte_fichemetier t
SET missions = sub.nouveaux_ids
FROM (
         SELECT t2.id,
                string_agg(m.id::text, ';' ORDER BY m.id) AS nouveaux_ids
         FROM ficheposte_fichemetier t2
                  CROSS JOIN LATERAL unnest(string_to_array(t2.activites, ';')) AS old_id_to_map
                  JOIN missionprincipale m ON m.old_id = old_id_to_map::int
         GROUP BY t2.id
     ) sub
WHERE t.id = sub.id;

alter table ficheposte_fichemetier drop column activites;
alter table ficheposte_fichemetier add column activites varchar(1024);


alter table ficheposte_missionsadditionnelles rename column mission_id to old_mission_id;
alter table ficheposte_missionsadditionnelles add mission_id integer constraint ficheposte_missionsadditionnelles_missionprincipale_id_fk_2 references missionprincipale on delete cascade;
UPDATE ficheposte_missionsadditionnelles fpma SET mission_id = m.id FROM missionprincipale m WHERE m.old_id = fpma.old_mission_id;
alter table ficheposte_missionsadditionnelles alter column old_mission_id drop not null;
alter table ficheposte_missionsadditionnelles drop constraint ficheposte_missionsadditionnelles_missionprincipale_id_fk;

------------------------------------------------------------------------------------------------------------------------
-- NETTOYAGE --
------------------------------------------------------------------------------------------------------------------------

-- NETTOYAGE (MISSION PRINCIPALE)
drop table missionprincipale_old;
drop table fichemetier_mission_old;
alter table missionprincipale drop column old_id;
alter table missionprincipale_element drop column fichemetier_id;
update missionprincipale_element set description = null where description ilike '5.1.0 %';

-- NETTOYAGE (ACTIVITE)
drop table missionprincipale_activite;
drop table fichemetier_activite_old;
alter table activite drop column old_id;
alter table activite_element drop column fichemetier_id;
```

### Avec BddAdmin


Remarques :
- Le changement de type des identifiants de colonne peut être bloqué par des indicateurs portant ou référant des structures, il faut dropper les vues matérialisées associées (elles seront recréées lors de leur rafraîchissement).

### Données modifiées

Privilèges 

```postgresql
-- ---------------------------------------------------------------------------------------------------------------------
-- Nouveaux privileges associés à `unicaen/fichier`
-- ---------------------------------------------------------------------------------------------------------------------

INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES ('fichier', 'Gestion des fichiers', 'UnicaenFichier\Provider\Privilege', 9999);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
 SELECT 'fichier_afficher', 'Afficher', 10 UNION
 SELECT 'fichier_modifier', 'Modifier', 20 UNION
 SELECT 'fichier_televerser', 'Téléverser', 30 UNION
 SELECT 'fichier_telecharger', 'Télécharger', 40 UNION
 SELECT 'fichier_archiver', 'Historiser', 50 UNION
 SELECT 'fichier_restaurer', 'Restaurer', 60 UNION
 SELECT 'fichier_supprimer', 'Supprimer', 70 UNION

 SELECT 'nature_afficher', 'Afficher (Nature)', 110 UNION
 SELECT 'nature_ajouter', 'Ajouter (Nature)', 120 UNION
 SELECT 'nature_modifier', 'Modifier (Nature)', 130 UNION
 SELECT 'nature_supprimer', 'Supprimer (Nature)', 140
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'fichier';

-- ---------------------------------------------------------------------------------------------------------------------
-- Nouveaux privilèges associés aux niveaux de fonctions et codes fonctions
-- ---------------------------------------------------------------------------------------------------------------------

INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
('niveaufonction', 'Gestion des niveaux de fonction', 'Carriere\Provider\Privilege', 100);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'niveaufonction_index', 'Accéder à l''index', 10 UNION
    SELECT 'niveaufonction_afficher', 'Afficher', 20 UNION
    SELECT 'niveaufonction_ajouter', 'Ajouter', 30 UNION
    SELECT 'niveaufonction_modifier', 'Modifier', 40 UNION
    SELECT 'niveaufonction_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'niveaufonction_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'niveaufonction';

INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
('codefonction', 'Gestion des codes fonctions', 'FicheMetier\Provider\Privilege', 3000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'codefonction_index', 'Accéder à l''index', 10 UNION
    SELECT 'codefonction_afficher', 'Afficher', 20 UNION
    SELECT 'codefonction_ajouter', 'Ajouter', 30 UNION
    SELECT 'codefonction_modifier', 'Modifier', 40 UNION
    SELECT 'codefonction_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'codefonction_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'codefonction';

-- ---------------------------------------------------------------------------------------------------------------------
-- Privilèges liés aux compétences 
-- ---------------------------------------------------------------------------------------------------------------------

INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'competence_importer', 'Importer des compétences', 100
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'competence';

INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) 
VALUES ('competencediscipline', 'Gestion des disciplines', 'Element\Provider\Privilege', 4000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'competencediscipline_index', 'Accéder à l''index', 10 UNION
    SELECT 'competencediscipline_afficher', 'Afficher', 20 UNION
    SELECT 'competencediscipline_ajouter', 'Ajouter', 30 UNION
    SELECT 'competencediscipline_modifier', 'Modifier', 40 UNION
    SELECT 'competencediscipline_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'competencediscipline_supprimer', 'Supprimer', 60

)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
 JOIN unicaen_privilege_categorie cp ON cp.CODE = 'competencediscipline';

-- ---------------------------------------------------------------------------------------------------------------------
-- Privilèges liés aux référentiels communs 
-- ---------------------------------------------------------------------------------------------------------------------

-- Privilèges liés aux référentiels centralisées 
INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
    ('referentiel', 'Gestion des référentiels', 'Referentiel\Provider\Privilege', 2000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'referentiel_index', 'Accéder à l''index', 10 UNION
    SELECT 'referentiel_afficher', 'Afficher', 20 UNION
    SELECT 'referentiel_ajouter', 'Ajouter', 30 UNION
    SELECT 'referentiel_modifier', 'Modifier', 40 UNION
    SELECT 'referentiel_historiser', 'Historiser', 50 UNION
    SELECT 'referentiel_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'referentiel';

-- ---------------------------------------------------------------------------------------------------------------------
-- Ajout pour les activités et missions principales
-- ---------------------------------------------------------------------------------------------------------------------

INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'activite_supprimer', 'Supprimer', 60 UNION
    SELECT 'activite_rechercher', 'Rechercher', 100 UNION
    SELECT 'activite_importer', 'Importer', 200 
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'activite';

INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'observationinstance_afficher_historiser', 'Afficher les observations historisées', 100 
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'observationinstance';
```

Parametres

```postgresql

-- Parametre pour masquer les parties Missions spécifiques des affichages "Agent"
INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'ONGLET_MISSIONS', 'Affichage de la partie "Missions spécifiques"', null, 'Boolean', 25
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'AGENT';

update unicaen_parametre_parametre set valeur='false' where code='ONGLET_MISSIONS';

INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'DISPLAY_ACTIVITE', 'Affichage de la partie "Activités"', null, 'Boolean', 45
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'FICHE_METIER';
```

Nouvelles macros et templates

```postgresql

INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('ENTRETIEN#Facultatif', '<p>Permet d''ajouter la mention "L''agent·e n''avait pas d''obligation à passer l''entretien pour cette campagne." si l''entretien est facultatif.</p>', 'entretien', 'mentionFacultatif')
;

-- Mise a jour du template FICHE METIER

delete from unicaen_renderer_template where code='FICHE_METIER';
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace, engine) VALUES ('FICHE_METIER', '<p>Exportation pdf d''une fiche métier</p>', 'pdf', 'Fiche_Métier_VAR[FICHE_METIER#INTITULE].pdf', e'<h1>Fiche Métier de l\'Université de démonstration</h1>
<h1>{{ fichemetier.getIntitule }} ({{ fichemetier.getReferentiel.getLibelleCourt }} {{ fichemetier.getReference }})</h1>
<p> </p>
<p>{%if (DISPLAY_RESUME and DISPLAY_CODEFONCTION) %}</p>
<table id="resume" style="border-collapse: collapse; width: 100%;" border="1"><colgroup><col style="width: 20.311%;"><col style="width: 79.689%;"></colgroup>
<tbody>
<tr>
<th>Niveau de fonction</th>
<td>{{ fichemetier.toStringNiveauFonction }}</td>
</tr>
<tr>
<th>Spécialité</th>
<td>{{ fichemetier.toStringSpecialite }}</td>
</tr>
<tr>
<th>Famille professionnelle</th>
<td>{{ fichemetier.toStringFamille }}</td>
</tr>
<tr>
<th>Code Fonction</th>
<td>{{ fichemetier.toStringCodeFonction }}</td>
</tr>
<tr>
<th>Codes Emploi Type</th>
<td>{{ fichemetier.toStringCodesEmploiType }}</td>
</tr>
<tr>
<th>Niveau de carrière</th>
<td>{{ fichemetier.toStringNiveauCarriere }}</td>
</tr>
<tr>
<th>Date de dépôt</th>
<td>{{ fichemetier.toStringEtatActifDate }}</td>
</tr>
<tr>
<th>État</th>
<td>{{ fichemetier.toStringEtatActif }}</td>
</tr>
</tbody>
</table>
<p>{% endif %}</p>
<p>{%if (DISPLAY_RESUME and not DISPLAY_CODEFONCTION) %}</p>
<table id="resume" style="border-collapse: collapse; width: 100%;" border="1"><colgroup><col style="width: 20.311%;"><col style="width: 79.689%;"></colgroup>
<tbody>
<tr>
<th>Spécialité</th>
<td>{{ fichemetier.toStringSpecialite }}</td>
</tr>
<tr>
<th>Famille professionnelle</th>
<td>{{ fichemetier.toStringFamille }}</td>
</tr>
<tr>
<th>Codes Emploi Type</th>
<td>{{ fichemetier.toStringCodesEmploiType }}</td>
</tr>
<tr>
<th>Niveau de carrière</th>
<td>{{ fichemetier.toStringNiveauCarriere }}</td>
</tr>
<tr>
<th>Date de dépôt</th>
<td>{{ fichemetier.toStringEtatActifDate }}</td>
</tr>
<tr>
<th>État</th>
<td>{{ fichemetier.toStringEtatActif }}</td>
</tr>
</tbody>
</table>
<p>{% endif %}</p>
<p>{%if (DISPLAY_RAISON) %}</p>
<h2>Raison d\'être de la fiche métier dans l\'établissement</h2>
<p>{{ fichemetier.toStringRaison|raw }}<br>{% endif %}</p>
<p>{%if (DISPLAY_MISSION) %}</p>
<h2>Missions principales</h2>
<p>{{ fichemetier.getMissionsAsList|raw }}</p>
<p>{% endif %}</p>
<p>{%if (DISPLAY_ACTIVITE) %}</p>
<h2>Activités</h2>
<p>{{ fichemetier.getActivitesAsList|raw }}</p>
<p>{% endif %}</p>
<p>{% if (DISPLAY_COMPETENCE and fichemetier.getCompetencesStandard is not empty) %}</p>
<h2>Compétences</h2>
<p>{{ fichemetier.toArrayCompetences|raw }}{%endif %}</p>
<p>{% if (DISPLAY_COMPETENCE_SPECIFIQUE and fichemetier.getCompetencesSpecifiques is not empty) %}</p>
<h2>Compétences spécifiques</h2>
<p>{{ fichemetier.toArrayCompetencesSpecifiques|raw }}{%endif %}</p>
<p>{% if DISPLAY_APPLICATION and fichemetier.getApplicationListe is not empty %}</p>
<h2>Applications</h2>
<p>{{ fichemetier.toArrayApplications|raw }}{%endif %}</p>
<p>{% if (DISPLAY_CONTEXTE) %}</p>
<h2>Contexte et environnement de travail </h2>
<p>{{ fichemetier.toStringThematiques(true)|raw }}</p>
<p>{%endif %}</p>
<p>{% if (DISPLAY_TENDANCE) %}</p>
<h2>Tendances d\'évolution</h2>
<p>{{ fichemetier.toStringTendances(true)|raw }}</p>
<p>{%endif %}</p>', e'body {font-size: 9pt;}h1 {font-size: 14pt; color:#123456;}h2 {font-size: 12pt; color:#123456; border-bottom: 1px solid #123456;}h3 {font-size: 10pt; color:#123456;}li.formation-groupe {font-weight:bold;} .mission-principale { padding-bottom:0; margin-bottom:0;} .tendance-libelle {font-weight: bold;}  .thematique-libelle {font-weight: bold;} th { border-bottom:1px solid black; text-align: left;} 
/** TABLEAU RESUME **/
table#resume th { width: 30%; padding-left: 1rem; }
table#resume td { padding-left: 1rem; }
/** TABLEAU DES COMPETENCES **/
table#competences th#competence {width: 50%;}
table#competences th#theme {width: 20%;}
table#competences th#niveau {width: 20%;}
table#competences th#cle {width: 10%;}
/** TABLEAU DES APPLICATIONS **/
table#applications th#application {width: 50%;}
table#applications th#theme {width: 20%;}
table#applications th#niveau {width: 20%;}
table#applications th#cle {width: 10%;}
/** TABLEAU ENVIRONNEMENT **/
table#environnement th#libelle {width: 50%;}
table#environnement th#niveau {width: 50%;}', 'FicheMetier\Provider\Template', 'twiglight');

```
Uniformisation et ajout de données

```postgresql
-- Renommage de la catégorie de niveau de maîtrise 
update element_niveau set  type='Contexte et environnement de travail' where type='Thematique';
update unicaen_privilege_categorie set libelle='Gestion des notions de "Contexte et environnement de travail"' where code='thematiquetype';
update unicaen_privilege_categorie set libelle='Gestion des notions de "Tendance d''evolution"' where code='tendancetype';

INSERT INTO unicaen_fichier_nature (code, libelle) VALUES ('DIVERS', 'Fichiers divers');

-- Niveau de fonction de marseilles
INSERT INTO carriere_niveau_fonction (code, libelle, description) VALUES 
    ('CHAR', 'Chargé·e de mission', null),
    ('OPER', 'Opérateur', null),
    ('COOR', 'Coordinateur', null),
    ('RESP', 'Responsable', null),
    ('DIRE', 'Directeur', null);

-- Spécialité
INSERT INTO carriere_correspondance_type (id, code, libelle_court, libelle_long, description, d_ouverture, d_fermeture, created_on, source_id, id_orig) 
VALUES (100, 'DF', 'DF', 'Domaine de famille professionnelle', 'Spécialités associées aux RMFP', '2025-01-01 00:00:00.000000', null, '2025-12-04 10:03:55.000000', 'EMC2', null);


-- Ici les valeurs qui sont utilisées peuvent provoquer des échecs, il est probable qu'il faille adapter les requêtes suivantes 
INSERT INTO element_competence_type (libelle, code, ordre) VALUES ('Compétences spécifiques', 'SPEC', 100);
UPDATE element_competence_type set code = 'CONN' where libelle='Connaissances';
UPDATE element_competence_type set ordre = 10 where libelle='Connaissances';
UPDATE element_competence_type set code = 'OPER' where libelle='Compétences opérationnelles';
UPDATE element_competence_type set ordre = 20 where libelle='Compétences opérationnelles';
UPDATE element_competence_type set code = 'COMP' where libelle='Compétences comportementales';
UPDATE element_competence_type set ordre = 30 where libelle='Compétences comportementales';
```

## Changement de la gestion des compétences spécifiques 

```postgresql
-- Décalage de compétence spécifique ...
insert into fichemetier_competence (fichemetier_id, competence_element_id)
SELECT fichemetier_id, competence_element_id from fichemetier_competence_specifique;
drop table fichemetier_competence_specifique;


INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'DISPLAY_ACTIVITE', 'Affichage de la partie "Activités"', null, 'Boolean', 45
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'FICHE_METIER';
```

Déduction des référentiels pour les activités et les missions
```postgresql
UPDATE activite a
SET referentiel_id = fm.referentiel_id
FROM activite_element ae
JOIN fichemetier fm ON ae.fichemetier_id = fm.id
WHERE a.id = ae.activite_id;

UPDATE missionprincipale m
SET referentiel_id = fm.referentiel_id
FROM missionprincipale_element me
JOIN fichemetier fm ON me.fichemetier_id = fm.id
WHERE m.id = me.mission_id;
```

Modification des paramètres décrivant la version
```postgresql
update unicaen_parametre_parametre set valeur='5.2.0' where code='VERSION';
update unicaen_parametre_parametre set valeur='18/02/2026' where code='RELEASE_DATE';
```

```postgresql

-- nettoyage !!!
delete from unicaen_privilege_privilege where code = 'activite_detruire';

delete from unicaen_privilege_privilege where categorie_id in (select id from unicaen_privilege_categorie where code in ('fonctiontype'));
delete from unicaen_privilege_categorie where code in ('fonctiontype');

delete from unicaen_privilege_privilege where categorie_id in (select id from unicaen_privilege_categorie where code in ('referentielMetier', 'referenceMetier', 'competencereferentiel'));
delete from unicaen_privilege_categorie where code in ('referentielMetier', 'referenceMetier', 'competencereferentiel');
delete from unicaen_privilege_privilege where categorie_id in (select id from unicaen_privilege_categorie where code in ('metier'));

drop table activite_description;
drop table activite_libelle;
drop table agent_element_formation;
drop table entretienprofessionnel_observation_old;
drop table ficheposte_expertise;
drop table import_log;
drop table lagaf_stagiaire;
drop table source;
drop table table_name;

```

## Évolution des librairies

Ajout d'unicaen/contact 
Montée en version d'unicaen/aide (0.4.0) correction du bug hors connexion
Montée en version `unicaen/indicateur` (6.4.0) permettant la gestion des périmétres `_ALL`
Passage à `unicaen/fichier` et à `unicaen/storage`

```bash
composer update
cp config/autoload/unicaen-fichier.local.php.dist config/autoload/unicaen-fichier.local.php
cp config/autoload/unicaen-storage.local.php.dist config/autoload/unicaen-storage.local.php
```

## Évolution des macros et templates

Nouvelles macros :
- `ENTRETIEN#Facultatif` est une macro qui ajoute la mention "L'entretien professionnel pour cet·te agent n'est pas obligatoire pour cette campagne"
**Attention** cette macro requiert un calcul fait qui fait seulement pour les CREP et les CREP.

## Évolution des paramètres

## Évolution de la liste des privileges

