# Version 5.2.0 RC (XX/10/2025) 

## Changements 

[NOUVEAUTE]
* Nouvelle macro pour une mention du caractère facultatif d'un entretien professionnel

[EVOLUTION]
* L'identifiant (clef primaire) des structures est maintenant une chaîne de caractères.

[CORRECTION]
* Clarification de l'historique des chaînes hiérarchiques présentées sur la page de l'agent. 

## Modification de la configuration

Aucun

## Modification structurelle en BD

### Sans BddAdmin

Modifciation de la clef primaire de la table `structure`.

Remarques :  
- si vous avez des indicateurs portant ou référant des structures, il faut dropper les vues matérialisées associées (elles seront recréées lors de leur rafraîchissement).

 
```postgresql
-- Retrait des contraintes de clefs étrangères
ALTER TABLE structure_observateur  DROP CONSTRAINT structure_observateur_structure_id_fk;
ALTER TABLE structure_contact  DROP CONSTRAINT structure_contact_structure_id_fk;
ALTER TABLE entretienprofessionnel_delegue  DROP CONSTRAINT entretienprofessionnel_delegue_structure_id_fk;
ALTER TABLE poste  DROP CONSTRAINT poste_structure_source_id_fk;
    
-- Changement de type
ALTER TABLE structure ALTER COLUMN id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN parent_id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN niv2_id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN niv2_id_ow TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE agent_carriere_affectation ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_carriere_grade ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_carriere_statut ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_missionspecifique ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE entretienprofessionnel_delegue ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE poste ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_agent_force ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_contact ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_ficheposte ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_gestionnaire ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_observateur ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_responsable ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
    
-- Remise des contraintes de clefs étrangères
ALTER TABLE structure ADD CONSTRAINT structure_parent_id_fk FOREIGN KEY (parent_id) REFERENCES structure(id);
ALTER TABLE structure ADD CONSTRAINT structure_niv2_id_fk FOREIGN KEY (niv2_id) REFERENCES structure(id);
ALTER TABLE structure ADD CONSTRAINT structure_niv2_id_ow_fk FOREIGN KEY (niv2_id_ow) REFERENCES structure(id);
ALTER TABLE agent_carriere_affectation ADD CONSTRAINT agent_carriere_affectation_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_carriere_grade ADD CONSTRAINT agent_carriere_grade_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_carriere_statut ADD CONSTRAINT agent_carriere_statut_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_missionspecifique ADD CONSTRAINT agent_missionspecifique_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE entretienprofessionnel_delegue ADD CONSTRAINT entretienprofessionnel_delegue_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE poste ADD CONSTRAINT  poste_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_agent_force ADD CONSTRAINT  structure_agent_force_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_contact ADD CONSTRAINT  structure_contact_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_ficheposte ADD CONSTRAINT  structure_ficheposte_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_gestionnaire ADD CONSTRAINT  structure_gestionnaire_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_observateur ADD CONSTRAINT  structure_observateur_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_responsable ADD CONSTRAINT  structure_responsable_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
```

### Avec BddAdmin

Remarques :
- Le changement de type des identifiants de colonne peut-être bloqué par des indicateurs portant ou référant des structures, il faut dropper les vues matérialisées associées (elles seront recréées lors de leur rafraîchissement).

### Données modifiées

Uniformisation des notions "thématiques" vers "contexte et environnement de travail".
```postgresql
-- Renommage de la catégorie de niveau de maîtrise 
update element_niveau set  type='Contexte et environnement de travail' where type='Thematique';
update unicaen_privilege_categorie set libelle='Gestion des notions de "Contexte et environnement de travail"' where code='thematiquetype';
update unicaen_privilege_categorie set libelle='Gestion des notions de "Tendance d''evolution"' where code='tendancetype';
```

Parametre pour masquer les parties Missions spécifiques des affichages "Agent"
```postgresql
INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'ONGLET_MISSIONS', 'Affichage de la partie "Missions spécifiques"', null, 'Boolean', 25
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'AGENT';

update unicaen_parametre_parametre set valeur='false' where code='ONGLET_MISSIONS';

INSERT INTO fichier_nature (code, libelle) VALUES ('DIVERS', 'Fichiers divers');
```
## Modification des données en BD

Nouvelles macros
```postgresql
INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('ENTRETIEN#Facultatif', '<p>Permet d''ajouter la mention "L''agent·e n''avait pas d''obligation à passer l''entretien pour cette campagne." si l''entretien est facultatif.</p>', 'entretien', 'mentionFacultatif')
;
```

## Changement de la gestion des compétences spécifiques 

```postgresql
-- Décalage de compétence spécifique ...
insert into fichemetier_competence (fichemetier_id, competence_element_id)
SELECT fichemetier_id, competence_element_id from fichemetier_competence_specifique;
drop table fichemetier_competence_specifique;
```

Modification des paramètres décrivant la version
```postgresql
update unicaen_parametre_parametre set valeur='5.2.0 RC' where code='VERSION';
update unicaen_parametre_parametre set valeur='XX/10/2025' where code='RELEASE_DATE';
```

## Évolution des librairies

Ajout d'unicaen/contact 
Montée en version d'unicaen/aide (0.4.0) correction du bug hors connexion
Montée en version `unicaen/indicateur` (6.4.0) permettant la gestion des périmétres `_ALL`

## Évolution des macros et templates

Nouvelles macros :
- `ENTRETIEN#Facultatif` est une macro qui ajoute la mention "L'entretien professionnel pour cet·te agent n'est pas obligatoire pour cette campagne"
**Attention** cette macro requiert un calcul fait qui fait seulement pour les CREP et les CREP.

## Évolution des paramètres

## Évolution de la liste des privileges

