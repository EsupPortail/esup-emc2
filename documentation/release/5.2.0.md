# Version 5.2.0 RC (XX/10/2025) 

## Changements 

[NOUVEAUTE]
* Nouvelle macro pour une mention du caractère facultatif d'un entretien professionnel

[EVOLUTION]
* L'identifiant (clef primaire) des structures est maintenant une chaîne de caractères.

[CORRECTION]
* Clarification de l'historique des chaînes hiérarchiques présentées sur la page de l'agent. 

## Modification de la configuration

Aucun

## Modification structurelle en BD

### Sans BddAdmin

Passage à `unicaen/fichier` pour permettre le stockage via S3 des futures instances déployées en SaaS.
```postgresql

-- ---------------------------------------------------------------------------------------------------------------------
-- Bascule vers unicaen/fichier
-- ---------------------------------------------------------------------------------------------------------------------

alter table fichier_nature rename to unicaen_fichier_nature;
alter sequence fichier_nature_id_seq rename to unicaen_fichier_nature_id_seq;
alter table unicaen_fichier_nature add column ordre int default 9999;
alter table fichier_fichier rename to unicaen_fichier_fichier;

-- ---------------------------------------------------------------------------------------------------------------------
-- Modification de la clef primaire de la table `structure`.
-- ---------------------------------------------------------------------------------------------------------------------
    
-- Remarques : si vous avez des indicateurs portant ou référant des structures, il faut dropper les vues matérialisées associées (elles seront recréées lors de leur rafraîchissement).

-- Retrait des contraintes de clefs étrangères
ALTER TABLE structure_observateur  DROP CONSTRAINT structure_observateur_structure_id_fk;
ALTER TABLE structure_contact  DROP CONSTRAINT structure_contact_structure_id_fk;
ALTER TABLE entretienprofessionnel_delegue  DROP CONSTRAINT entretienprofessionnel_delegue_structure_id_fk;
ALTER TABLE poste  DROP CONSTRAINT poste_structure_source_id_fk;
    
-- Changement de type
ALTER TABLE structure ALTER COLUMN id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN parent_id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN niv2_id TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE structure ALTER COLUMN niv2_id_ow TYPE VARCHAR(1024) USING id::varchar;
ALTER TABLE agent_carriere_affectation ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_carriere_grade ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_carriere_statut ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE agent_missionspecifique ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE entretienprofessionnel_delegue ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE poste ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_agent_force ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_contact ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_ficheposte ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_gestionnaire ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_observateur ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
ALTER TABLE structure_responsable ALTER COLUMN structure_id TYPE VARCHAR(1024) USING structure_id::varchar;
    
-- Remise des contraintes de clefs étrangères
ALTER TABLE structure ADD CONSTRAINT structure_parent_id_fk FOREIGN KEY (parent_id) REFERENCES structure(id);
ALTER TABLE structure ADD CONSTRAINT structure_niv2_id_fk FOREIGN KEY (niv2_id) REFERENCES structure(id);
ALTER TABLE structure ADD CONSTRAINT structure_niv2_id_ow_fk FOREIGN KEY (niv2_id_ow) REFERENCES structure(id);
ALTER TABLE agent_carriere_affectation ADD CONSTRAINT agent_carriere_affectation_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_carriere_grade ADD CONSTRAINT agent_carriere_grade_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_carriere_statut ADD CONSTRAINT agent_carriere_statut_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE agent_missionspecifique ADD CONSTRAINT agent_missionspecifique_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE entretienprofessionnel_delegue ADD CONSTRAINT entretienprofessionnel_delegue_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE poste ADD CONSTRAINT  poste_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_agent_force ADD CONSTRAINT  structure_agent_force_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_contact ADD CONSTRAINT  structure_contact_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_ficheposte ADD CONSTRAINT  structure_ficheposte_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_gestionnaire ADD CONSTRAINT  structure_gestionnaire_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_observateur ADD CONSTRAINT  structure_observateur_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);
ALTER TABLE structure_responsable ADD CONSTRAINT  structure_responsable_structure_id_fk FOREIGN KEY (structure_id) REFERENCES structure(id);

-- ---------------------------------------------------------------------------------------------------------------------
-- Nouvelle table pour la gestion des référentiels "centralisées"
-- ---------------------------------------------------------------------------------------------------------------------

create table referentiel_referentiel
(
    id                    serial                  
        constraint referentiel_referentiel_pk primary key,
    libelle_court         varchar(256)            not null 
        constraint referentiel_referentiel_pk_2 unique,
    libelle_long          varchar(1024)           not null,
    couleur               varchar(256)            not null,
    description           text,
    histo_creation        timestamp                 default now() not null,
    histo_createur_id     integer                   default 0     not null
        constraint referentiel_referentiel_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint referentiel_referentiel_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint referentiel_referentiel_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- changement des liens avec les tables liées à des référentiels spécifiques
alter table element_competence drop column source;
alter table element_competence add column referentiel_id int constraint element_competence_referentiel_referentiel_id_fk references referentiel_referentiel;
alter table element_competence rename column id_source to reference;

alter table missionprincipale add column referentiel_id int constraint missionprincipale_referentiel_referentiel_id_fk references referentiel_referentiel;
alter table missionprincipale add column reference varchar(256);

alter table fichemetier add column referentiel_id int constraint fichemetier_referentiel_referentiel_id_fk references referentiel_referentiel;
alter table fichemetier add column reference varchar(256);

alter table activite add column referentiel_id int constraint activite_referentiel_referentiel_id_fk references referentiel_referentiel;
alter table activite add column reference varchar(256);

alter table metier_metier add column referentiel_id integer;
alter table metier_metier add column reference varchar(256);

-- drop des tables des référentiels spécifiques
drop table element_competence_referentiel;
drop table metier_referentiel cascade;

-- ---------------------------------------------------------------------------------------------------------------------
-- drop des tables devenues inutiles (abondon de la notion de fiche référentielle )
-- ---------------------------------------------------------------------------------------------------------------------
drop table fichereferentiel_competence;
drop table fichereferentiel_fiche;

-- ---------------------------------------------------------------------------------------------------------------------
-- Introduction de la notion de discipline pour les compétences
-- ---------------------------------------------------------------------------------------------------------------------

create table element_competence_discipline
(
    id  serial not null
        constraint competence_discipline_pk primary key,
    libelle               varchar(256)                                                         not null,
    description           text                                                      not null,
    histo_creation        timestamp                                                            not null,
    histo_createur_id     integer                                                              not null
        constraint competence_discipline_createur_fk references unicaen_utilisateur_user,
    histo_modification    timestamp                                                            not null,
    histo_modificateur_id integer
        constraint competence_discipline_modificateur_fk references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint competence_discipline_user_id_fk references unicaen_utilisateur_user
);
create unique index competence_discipline_id_uindex on element_competence_discipline (id);

alter table element_competence add discipline_id integer
    constraint element_competence_element_competence_discipline_id_fk references element_competence_discipline on delete set null;

-- ---------------------------------------------------------------------------------------------------------------------
-- Table de gestions des synonymes 
-- ---------------------------------------------------------------------------------------------------------------------

create table element_competence_synonyme
(
    id            serial
        constraint element_competence_synonyme_pk
            primary key,
    competence_id integer not null
        constraint element_competence_synonyme_element_competence_id_fk
            references element_competence
            on delete cascade,
    libelle       integer
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Nouvelles colonnes pour l'import des compétences + alteration des types
-- ---------------------------------------------------------------------------------------------------------------------

alter table element_competence add raw text;
alter table element_competence add emplois_types text;
alter table element_competence add synonymes text;
alter table element_competence_type add code varchar(64) not null default 'TYPE';

-- ---------------------------------------------------------------------------------------------------------------------
-- Niveau de fonction et code fonction 
-- ---------------------------------------------------------------------------------------------------------------------

create table carriere_niveau_fonction
(
    id                    serial
        constraint carriere_niveau_fonction_pk primary key,
    code                  varchar(64)             not null,
    libelle               varchar(1024)           not null,
    description           text,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint carriere_niveau_fonction_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint carriere_niveau_fonction_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint carriere_niveau_fonction_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);
create unique index carriere_niveau_fonction_code_unique on carriere_niveau_fonction (code) where (histo_destruction IS NULL);

create table emploirepere_codefonction
(
    id                         serial                  not null
        constraint emploirepere_codefonction_pk primary key,
    niveau_fonction_id         integer                 not null
        constraint emploirepere_codefonction_carriere_niveau_fonction_id_fk references carriere_niveau_fonction,
    famille_professionnelle_id integer                 not null
        constraint emploirepere_codefonction_metier_familleprofessionnelle_id_fk references metier_familleprofessionnelle,
    description                text,
    histo_creation             timestamp default now() not null,
    histo_createur_id          integer   default 0     not null
        constraint emploirepere_codefonction_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification         timestamp,
    histo_modificateur_id      integer
        constraint emploirepere_codefonction_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction          timestamp,
    histo_destructeur_id       integer
        constraint emploirepere_codefonction_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- remplacement de la chaine de caractère par l'entite codefonction dans les fiches métiers
alter table fichemetier drop column code_fonction;
alter table fichemetier add code_fonction_id integer;

alter table missionprincipale add codes_fonction text;
alter table missionprincipale add codes_fiche_metier text;


-- ---------------------------------------------------------------------------------------------------------------------
-- Changement des tables décrivant les missions principales 
-- ---------------------------------------------------------------------------------------------------------------------

drop table missionprincipale_application;
drop table missionprincipale_competence;
drop table missionprincipale_domaine;

create table missionprincipale_familleprofessionnelle
(
    mission_id integer not null
        constraint mpfp_missionprincipale_id_fk references missionprincipale on delete cascade,
    famille_id integer not null
        constraint mpfp_metier_familleprofessionnelle_id_fk references metier_familleprofessionnelle on delete cascade,
    constraint missionprincipale_familleprofessionnelle_pk primary key (mission_id, famille_id)
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Changement des tables décrivant les métiers (en abandon)
-- ---------------------------------------------------------------------------------------------------------------------

drop table metier_metier_domaine;
drop table metier_domaine_famille;
drop table metier_domaine;

-- ---------------------------------------------------------------------------------------------------------------------
-- Changement des tables décrivant les activités 
-- ---------------------------------------------------------------------------------------------------------------------

drop table activite_application;
drop table activite_competence;
drop table activite_domaine;

-- ---------------------------------------------------------------------------------------------------------------------
-- Modification des familles professionnelles 
-- ---------------------------------------------------------------------------------------------------------------------

alter table metier_familleprofessionnelle add correspondance_id integer;
comment on column metier_familleprofessionnelle.correspondance_id is 'idéalement devrait être non nulle (mais il y a l''existant)';
alter table metier_familleprofessionnelle add position int;

-- ---------------------------------------------------------------------------------------------------------------------
-- Preparation du travail dsur les fiches de poste
-- ---------------------------------------------------------------------------------------------------------------------

alter table fichemetier add libelle varchar(1024);
drop table ficheposte_fichemetier_domaine;
alter table poste drop constraint poste_domaine_id_fk;

-- ---------------------------------------------------------------------------------------------------------------------
-- code fonction 
-- ---------------------------------------------------------------------------------------------------------------------

create table fichemetier_code_emploitype
(
    id                    serial                  not null
        constraint fichemetier_code_emploitype_pk primary key,
    fichemetier_id        integer                 not null
        constraint fichemetier_code_emploitype_fichemetier_id_fk references fichemetier on delete cascade,
    fonction_code         integer                 not null
        constraint fichemetier_code_emploitype_carriere_fonction_type_id_fk references carriere_niveau_fonction on delete cascade,
    complement            varchar(64)             not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint fichemetier_code_emploitype_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    Histo_modification    timestamp,
    histo_modificateur_id integer
        constraint fichemetier_code_emploitype_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint fichemetier_code_emploitype_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Suppression des métiers
-- ---------------------------------------------------------------------------------------------------------------------

alter table fichemetier drop column metier_id;

-- ---------------------------------------------------------------------------------------------------------------------
-- MODIFICATION DES ACTIVITES ------------------------------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

alter table activite add column codes_fiche_metier text;
alter table activite add column codes_fonction text;
alter table activite rename column  id_orig to reference;

create table activite_element
(
    id                    serial                  not null
        constraint activite_element_pk
            primary key,
    activite_id           integer                 not null
        constraint activite_element_activite_id_fk
            references activite
            on delete cascade,
    description           text,
    position              integer   default 9999  not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint activite_element_unicaen_utilisateur_user_id_fk
            references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint activite_element_unicaen_utilisateur_user_id_fk_2
            references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint activite_element_unicaen_utilisateur_user_id_fk_3
            references unicaen_utilisateur_user
);

create table fichemetier_activite
(
    fichemetier_id      integer not null
        constraint fichemetier_activite_fichemetier_id_fk
            references fichemetier
            on delete cascade,
    activite_element_id integer not null
        constraint fichemetier_activite_mission_element_id_fk
        references activite_element
            on delete cascade,
    constraint fichemetier_activite_pk
        primary key (fichemetier_id, activite_element_id)
);

create table missionprincipale_element
(
    id                    serial                  not null
        constraint missionprincipale_element_pk
            primary key,
    mission_id            integer                 not null
        constraint missionprincipale_element_missionprincipale_id_fk
            references missionprincipale
            on delete cascade,
    descrition            text,
    position              integer   default 9999  not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint missionprincipale_element_unicaen_utilisateur_user_id_fk
            references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint missionprincipale_element_unicaen_utilisateur_user_id_fk_2
            references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint missionprincipale_element_unicaen_utilisateur_user_id_fk_3
            references unicaen_utilisateur_user
);

alter table fichemetier_mission rename to fichemetier_mission_old;
drop sequence fichemetier_mission_id_seq;
create table fichemetier_mission
(
    fichemetier_id      integer not null
        constraint fichemetier_mission_fichemetier_id_fk
            references fichemetier
            on delete cascade,
    mission_element_id integer not null
        constraint fichemetier_mission_mission_element_id_fk
        references missionprincipale_element
            on delete cascade,
    constraint fichemetier_mission_pk
        primary key (fichemetier_id, mission_element_id)
);
```

### Avec BddAdmin


Remarques :
- Le changement de type des identifiants de colonne peut être bloqué par des indicateurs portant ou référant des structures, il faut dropper les vues matérialisées associées (elles seront recréées lors de leur rafraîchissement).

### Données modifiées

Nouveaux privileges associés à `unicaen/fichier`
```postgresql
INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES ('fichier', 'Gestion des fichiers', 'UnicaenFichier\Provider\Privilege', 9999);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
 SELECT 'fichier_afficher', 'Afficher', 10 UNION
 SELECT 'fichier_modifier', 'Modifier', 20 UNION
 SELECT 'fichier_televerser', 'Téléverser', 30 UNION
 SELECT 'fichier_telecharger', 'Télécharger', 40 UNION
 SELECT 'fichier_archiver', 'Historiser', 50 UNION
 SELECT 'fichier_restaurer', 'Restaurer', 60 UNION
 SELECT 'fichier_supprimer', 'Supprimer', 70 UNION

 SELECT 'nature_afficher', 'Afficher (Nature)', 110 UNION
 SELECT 'nature_ajouter', 'Ajouter (Nature)', 120 UNION
 SELECT 'nature_modifier', 'Modifier (Nature)', 130 UNION
 SELECT 'nature_supprimer', 'Supprimer (Nature)', 140
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'fichier';
-- penser à donner les privileges liés au fichier à tous les rôles (une assertion contrôlera plus finement par la suite).
```

Nouveaux privilèges associés aux niveaux de fonctions et codes fonctions
```postgresql
INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
('niveaufonction', 'Gestion des niveaux de fonction', 'Carriere\Provider\Privilege', 100);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'niveaufonction_index', 'Accéder à l''index', 10 UNION
    SELECT 'niveaufonction_afficher', 'Afficher', 20 UNION
    SELECT 'niveaufonction_ajouter', 'Ajouter', 30 UNION
    SELECT 'niveaufonction_modifier', 'Modifier', 40 UNION
    SELECT 'niveaufonction_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'niveaufonction_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'niveaufonction';

INSERT INTO public.unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
('codefonction', 'Gestion des codes fonctions', 'FicheMetier\Provider\Privilege', 3000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'codefonction_index', 'Accéder à l''index', 10 UNION
    SELECT 'codefonction_afficher', 'Afficher', 20 UNION
    SELECT 'codefonction_ajouter', 'Ajouter', 30 UNION
    SELECT 'codefonction_modifier', 'Modifier', 40 UNION
    SELECT 'codefonction_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'codefonction_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'codefonction';
-- penser à donner les privilèges

INSERT INTO public.unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
    ('codefonction', 'Gestion des codes fonctions', 'FicheMetier\Provider\Privilege', 3000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'codefonction_index', 'Accéder à l''index', 10 UNION
    SELECT 'codefonction_afficher', 'Afficher', 20 UNION
    SELECT 'codefonction_ajouter', 'Ajouter', 30 UNION
    SELECT 'codefonction_modifier', 'Modifier', 40 UNION
    SELECT 'codefonction_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'codefonction_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'codefonction';

INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'competence_importer', 'Importer des compétences', 100
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'competence';

INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) 
VALUES ('competencediscipline', 'Gestion des disciplines', 'Element\Provider\Privilege', 4000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'competencediscipline_index', 'Accéder à l''index', 10 UNION
    SELECT 'competencediscipline_afficher', 'Afficher', 20 UNION
    SELECT 'competencediscipline_ajouter', 'Ajouter', 30 UNION
    SELECT 'competencediscipline_modifier', 'Modifier', 40 UNION
    SELECT 'competencediscipline_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'competencediscipline_supprimer', 'Supprimer', 60

)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
 JOIN unicaen_privilege_categorie cp ON cp.CODE = 'competencediscipline';
```

Nouveau type de compétences et ajout du code pour les autres types
```postgresql
INSERT INTO element_competence_type (libelle, code, ordre) VALUES ('Compétences spécifiques', 'SPEC', 100);

-- Ici les valeurs qui sont utilisées peuvent provoquer des échecs, il est probable qu'il faille adapter les requêtes suivantes 
UPDATE element_competence_type set code = 'CONN' where libelle='Connaissances';
UPDATE element_competence_type set ordre = 10 where libelle='Connaissances';
UPDATE element_competence_type set code = 'OPER' where libelle='Compétences opérationnelles';
UPDATE element_competence_type set ordre = 20 where libelle='Compétences opérationnelles';
UPDATE element_competence_type set code = 'COMP' where libelle='Compétences comportementales';
UPDATE element_competence_type set ordre = 30 where libelle='Compétences comportementales';

-- Privilèges liés aux référentiels centralisées 
INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
    ('referentiel', 'Gestion des référentiels', 'Referentiel\Provider\Privilege', 2000);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'referentiel_index', 'Accéder à l''index', 10 UNION
    SELECT 'referentiel_afficher', 'Afficher', 20 UNION
    SELECT 'referentiel_ajouter', 'Ajouter', 30 UNION
    SELECT 'referentiel_modifier', 'Modifier', 40 UNION
    SELECT 'referentiel_historiser', 'Historiser', 50 UNION
    SELECT 'referentiel_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'referentiel';

-- nettoyage des privilèges abandonnés
delete from unicaen_privilege_privilege where categorie_id in (select id from unicaen_privilege_categorie where code in ('referentielMetier', 'referenceMetier', 'competencereferentiel'));
delete from unicaen_privilege_categorie where code in ('referentielMetier', 'referenceMetier', 'competencereferentiel');
delete from unicaen_privilege_privilege where categorie_id in (select id from unicaen_privilege_categorie where code in ('metier'));
```


Uniformisation des notions "thématiques" vers "contexte et environnement de travail".
```postgresql
-- Renommage de la catégorie de niveau de maîtrise 
update element_niveau set  type='Contexte et environnement de travail' where type='Thematique';
update unicaen_privilege_categorie set libelle='Gestion des notions de "Contexte et environnement de travail"' where code='thematiquetype';
update unicaen_privilege_categorie set libelle='Gestion des notions de "Tendance d''evolution"' where code='tendancetype';
```

Parametre pour masquer les parties Missions spécifiques des affichages "Agent"
```postgresql
INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'ONGLET_MISSIONS', 'Affichage de la partie "Missions spécifiques"', null, 'Boolean', 25
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'AGENT';

update unicaen_parametre_parametre set valeur='false' where code='ONGLET_MISSIONS';

INSERT INTO unicaen_fichier_nature (code, libelle) VALUES ('DIVERS', 'Fichiers divers');
```

Niveau de fonction de marseilles
```postgresql
INSERT INTO carriere_niveau_fonction (code, libelle, description) VALUES 
    ('CHAR', 'Chargé·e de mission', null),
    ('OPER', 'Opérateur', null),
    ('COOR', 'Coordinateur', null),
    ('RESP', 'Responsable', null),
    ('DIRE', 'Directeur', null);
```

Type de spécialité associé au RMFP
```postgresql
INSERT INTO carriere_correspondance_type (id, code, libelle_court, libelle_long, description, d_ouverture, d_fermeture, created_on, source_id, id_orig) 
VALUES (100, 'DF', 'DF', 'Domaine de famille professionnelle', 'Spécialités associées aux RMFP', '2025-01-01 00:00:00.000000', null, '2025-12-04 10:03:55.000000', 'EMC2', null);
```

Nouvelles macros
```postgresql
INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('ENTRETIEN#Facultatif', '<p>Permet d''ajouter la mention "L''agent·e n''avait pas d''obligation à passer l''entretien pour cette campagne." si l''entretien est facultatif.</p>', 'entretien', 'mentionFacultatif')
;
```

## Changement de la gestion des compétences spécifiques 

```postgresql
-- Décalage de compétence spécifique ...
insert into fichemetier_competence (fichemetier_id, competence_element_id)
SELECT fichemetier_id, competence_element_id from fichemetier_competence_specifique;
drop table fichemetier_competence_specifique;


INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'DISPLAy_ACTIVITE', 'Affichage de la partie "Activités"', null, 'Boolean', 45
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'FICHE_METIER';
```

Modification des paramètres décrivant la version
```postgresql
update unicaen_parametre_parametre set valeur='5.2.0 RC' where code='VERSION';
update unicaen_parametre_parametre set valeur='XX/10/2025' where code='RELEASE_DATE';
```

## Évolution des librairies

Ajout d'unicaen/contact 
Montée en version d'unicaen/aide (0.4.0) correction du bug hors connexion
Montée en version `unicaen/indicateur` (6.4.0) permettant la gestion des périmétres `_ALL`
Passage à unicaen/fichier 


## Évolution des macros et templates

Nouvelles macros :
- `ENTRETIEN#Facultatif` est une macro qui ajoute la mention "L'entretien professionnel pour cet·te agent n'est pas obligatoire pour cette campagne"
**Attention** cette macro requiert un calcul fait qui fait seulement pour les CREP et les CREP.

## Évolution des paramètres

## Évolution de la liste des privileges

