# Version 5.3.0 RC (XX/01/2025)

## Changements 

[NOUVEAUTÉ]
* La catégorie statutaire a été ajoutée aux fiches métiers

[CORRECTION]
* Les compétences historisées ne sont plus proposées dans les formulaires de gestion des compétences dans les fiches métiers.

### Sans BddAdmin

```postgresql

-- ---------------------------------------------------------------------------------------------------------------------
-- Ajout de la catégorie statutaire dans les fiches métiers
-- ---------------------------------------------------------------------------------------------------------------------

alter table fichemetier add categorie_id integer
    constraint fichemetier_carriere_categorie_id_fk references carriere_categorie;

-- ---------------------------------------------------------------------------------------------------------------------
-- Emploi Repère
-- ---------------------------------------------------------------------------------------------------------------------

-- La table portante 
create table emploirepere_emploirepere
(
    id                    serial                  not null
        constraint emploirepere_emploirepere_pk primary key,
    code                  varchar(256)            not null,
    libelle               varchar(1024)           not null,
    description           text                    not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint emploirepere_emploirepere_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint emploirepere_emploirepere_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint emploirepere_emploirepere_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- La table pour l'association emploi repere / code fonction / fiche metier
create table emploirepere_emploirepere_codefonction_fichemetier
(
    id              serial  not null
        constraint emploirepere_codefonction_fichemetier_pk primary key,
    emploirepere_id int     not null
        constraint ercffm_emploirepere_emploirepere_id_fk references emploirepere_emploirepere on delete cascade,
    codefonction_id integer not null
        constraint ercffm_emploirepere_codefonction_id_fk references emploirepere_codefonction on delete cascade,
    fichemetier_id  integer not null
        constraint ercffm_fichemetier_id_fk references fichemetier on delete cascade,
    constraint emploirepere_codefonction_fichemetier_pk_2 unique (emploirepere_id, codefonction_id, fichemetier_id)
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Ajout de données associé aux campagnes (Avec ou sans BDDADMIN)
-- ---------------------------------------------------------------------------------------------------------------------

alter table entretienprofessionnel_campagne add formulaire_crep_id integer
        constraint epc_unicaen_autoform_formulaire_id_fk references unicaen_autoform_formulaire;
alter table entretienprofessionnel_campagne add formulaire_cref_id integer
        constraint epc_unicaen_autoform_formulaire_id_fk2 references unicaen_autoform_formulaire;

update entretienprofessionnel_campagne set formulaire_crep_id = (select id from unicaen_autoform_formulaire where code='CREP') where formulaire_crep_id IS NULL ;
update entretienprofessionnel_campagne set formulaire_cref_id = (select id from unicaen_autoform_formulaire where code='CREF') where formulaire_cref_id IS NULL;

alter table entretienprofessionnel_campagne alter column formulaire_crep_id set not null;
alter table entretienprofessionnel_campagne alter column formulaire_cref_id set not null;

-- ---------------------------------------
-- INDICATEUR DE CAMPAGNE
-- ---------------------------------------
create table entretienprofessionnel_campagne_indicateur
(
    campagne_id   integer not null
        constraint epci_entretienprofessionnel_campagne_id_fk references entretienprofessionnel_campagne on delete cascade,
    indicateur_id integer not null
        constraint epci_unicaen_indicateur_indicateur_id_fk references unicaen_indicateur_indicateur on delete cascade,
    constraint entretienprofessionnel_campagne_indicateur_pk primary key (indicateur_id, campagne_id)
);


```

## Modification des données

```postgresql
INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
('emploirepere', 'Gestion des Emploi-Repères', 'EmploiRepere\Provider\Privilege', 100);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'emploirepere_index', 'Accéder à l''index', 10 UNION
    SELECT 'emploirepere_afficher', 'Afficher', 20 UNION
    SELECT 'emploirepere_ajouter', 'Ajouter', 30 UNION
    SELECT 'emploirepere_modifier', 'Modifier', 40 UNION
    SELECT 'emploirepere_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'emploirepere_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'emploirepere';
```