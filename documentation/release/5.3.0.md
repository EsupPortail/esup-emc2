# Version 5.3.0 RC (XX/01/2025)

## Changements 

[NOUVEAUTÉ]
* La catégorie statutaire a été ajoutée aux fiches métiers

[CORRECTION]
* Les compétences historisées ne sont plus proposées dans les formulaires de gestion des compétences dans les fiches métiers.

### Sans BddAdmin

```postgresql

-- ---------------------------------------------------------------------------------------------------------------------
-- Ajout de la catégorie statutaire dans les fiches métiers
-- ---------------------------------------------------------------------------------------------------------------------

alter table fichemetier add categorie_id integer
    constraint fichemetier_carriere_categorie_id_fk references carriere_categorie;

-- ---------------------------------------------------------------------------------------------------------------------
-- Emploi Repère
-- ---------------------------------------------------------------------------------------------------------------------

-- La table portante 
create table emploirepere_emploirepere
(
    id                    serial                  not null
        constraint emploirepere_emploirepere_pk primary key,
    code                  varchar(256)            not null,
    libelle               varchar(1024)           not null,
    description           text                    not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint emploirepere_emploirepere_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint emploirepere_emploirepere_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint emploirepere_emploirepere_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- La table pour l'association emploi repere / code fonction / fiche metier
create table emploirepere_emploirepere_codefonction_fichemetier
(
    id              serial  not null
        constraint emploirepere_codefonction_fichemetier_pk primary key,
    emploirepere_id int     not null
        constraint ercffm_emploirepere_emploirepere_id_fk references emploirepere_emploirepere on delete cascade,
    codefonction_id integer not null
        constraint ercffm_emploirepere_codefonction_id_fk references emploirepere_codefonction on delete cascade,
    fichemetier_id  integer not null
        constraint ercffm_fichemetier_id_fk references fichemetier on delete cascade,
    constraint emploirepere_codefonction_fichemetier_pk_2 unique (emploirepere_id, codefonction_id, fichemetier_id)
);

-- ---------------------------------------------------------------------------------------------------------------------
-- Ajout de données associé aux campagnes (Avec ou sans BDDADMIN)
-- ---------------------------------------------------------------------------------------------------------------------

alter table entretienprofessionnel_campagne add formulaire_crep_id integer
        constraint epc_unicaen_autoform_formulaire_id_fk references unicaen_autoform_formulaire;
alter table entretienprofessionnel_campagne add formulaire_cref_id integer
        constraint epc_unicaen_autoform_formulaire_id_fk2 references unicaen_autoform_formulaire;

update entretienprofessionnel_campagne set formulaire_crep_id = (select id from unicaen_autoform_formulaire where code='CREP') where formulaire_crep_id IS NULL ;
update entretienprofessionnel_campagne set formulaire_cref_id = (select id from unicaen_autoform_formulaire where code='CREF') where formulaire_cref_id IS NULL;

alter table entretienprofessionnel_campagne alter column formulaire_crep_id set not null;
alter table entretienprofessionnel_campagne alter column formulaire_cref_id set not null;

-- ---------------------------------------
-- INDICATEUR DE CAMPAGNE
-- ---------------------------------------
create table entretienprofessionnel_campagne_indicateur
(
    campagne_id   integer not null
        constraint epci_entretienprofessionnel_campagne_id_fk references entretienprofessionnel_campagne on delete cascade,
    indicateur_id integer not null
        constraint epci_unicaen_indicateur_indicateur_id_fk references unicaen_indicateur_indicateur on delete cascade,
    constraint entretienprofessionnel_campagne_indicateur_pk primary key (indicateur_id, campagne_id)
);

create table entretienprofessionnel_campagne_configuration_indicateur
(
    id                    serial                  not null
        constraint entretienprofessionnel_campagne_configuration_indicateur_pk primary key,
    code                  varchar(256)            not null,
    libelle               varchar(1024)           not null,
    requete               text                    not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint epcci_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint epcci_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  int
        constraint epcci_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

-- ---------------------------------------------------------------------------------------------------------------------
-- RECOPIE
-- ---------------------------------------------------------------------------------------------------------------------
create table entretienprofessionnel_campagne_configuration_recopie
(
    id                    serial                  not null
        constraint entretienprofessionnel_campagne_configuration_recopie_pk
            primary key,
    from_champ_id         integer                 not null
        constraint epccr_unicaen_autoform_champ_id_fk references unicaen_autoform_champ on delete cascade,
    to_champ_id           integer                 not null
        constraint epccr_unicaen_autoform_champ_id_fk_2 references unicaen_autoform_champ on delete cascade,
    description           text,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint epccr_unicaen_utilisateur_user_id_fk references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint epccr_unicaen_utilisateur_user_id_fk_2 references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint epccr_unicaen_utilisateur_user_id_fk_3 references unicaen_utilisateur_user
);

alter table entretienprofessionnel_agent_force add structure_id varchar(1024)
    constraint entretienprofessionnel_agent_force_structure_id_fk references structure on delete set null;

drop table entretienprofessionnel_agent_force_sansobligation;

alter table entretienprofessionnel_campagne add date_fixe date;
```

## Modification des données

```postgresql
INSERT INTO unicaen_privilege_categorie (code, libelle, namespace, ordre) VALUES
('emploirepere', 'Gestion des Emploi-Repères', 'EmploiRepere\Provider\Privilege', 100);
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'emploirepere_index', 'Accéder à l''index', 10 UNION
    SELECT 'emploirepere_afficher', 'Afficher', 20 UNION
    SELECT 'emploirepere_ajouter', 'Ajouter', 30 UNION
    SELECT 'emploirepere_modifier', 'Modifier', 40 UNION
    SELECT 'emploirepere_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'emploirepere_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'emploirepere';


INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'observationinstance_afficher_historiser', 'Afficher les observations historisées', 100
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'observationinstance';

INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'entretienpro_reinitialiser', 'Réinitialiser les compte-rendus', 100
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
         JOIN unicaen_privilege_categorie cp ON cp.CODE = 'entretienpro';

drop table configuration_entretienpro cascade;


INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace, engine) VALUES ('NOTIFICATION_ENTRETIEN_INVITATION', '<p>Courrier électronique faisant suivre l''invitation au formation ICS pour l''agent après l''acceptation de la convocation.</p>', 'mail', 'Invitation au rendez-vous pour votre entretien professionnel du VAR[ENTRETIEN#date]', e'<p>Bonjour,</p>
<p>Ce courrier électronique fait suivre l\'invitation à votre entretien professionnel du VAR[ENTRETIEN#date].<br>Vous pouvez utiliser cette invitation pour ajouter celui-ci à votre agenda.</p>
<p>Bonne journée,<br>VAR[Macro#Parametre|GLOBAL;APP_NAME]</p>', null, 'EntretienProfessionnel\Provider\Template', 'default');


INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'DISPLAY_INTITULE', 'Affichage du module - Intitulé des postes -', null, 'Boolean', 36 UNION
    SELECT 'DISPLAY_FICHEPOSTE', 'Affichage du module - Fiches de poste -', null, 'Boolean', 37
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'FICHE_METIER';

-- Changement de libellés pour certains paramètres "parlant" encore de Correspondance
update unicaen_parametre_parametre set libelle='Affichage seulement des spécialités ayant un agent' where code='CorrespondanceAvecAgent'
update unicaen_parametre_parametre set libelle='Ne considérer que les Corps/Spécialités/Grades actifs' where code='ACTIF_ONLY'

```


## Évolution des librairies

