# Version 4.4.12 (10/07/2024)

## Évolution

- [EMC2 - Mes Formations] Les agents ayant une absence justifiée sont mentionnées sur les émargements
- [EMC2 - Mes Formations] Ajout d'un complément sur les actions de formation pour affichage sur les convocations
- [EMC2 - Mes Formations] Ajout de la possibilité de lier des gestionnaires aux demandes externes
- [EMC2 - Mes Formations] Adaptation de l'index gestionnaire à l'ajout des gestionnaire sur les demandes
- [EMC2 - Mes Formations] Ajout du nom de famille sur les tableaux des inscrits et sur l'exportation CSV
- [EMC2 - Mes Formations] Ajout des constats d'absence
- [EMC2 - Element] Correction de la saisie des niveaux pour les acquis des agents
- [EMC2 - EntretienProfessionnel] Ajout sur l'écran des campagnes d'action pour notifier un·e supérieur·e (ou un·e autorité) de l'avancement de sa campagne
- [EMC2 - EntretienProfessionnel] Levé des blocages de validation pour les cas ou on a aucun·e autorité ou que le supérieur·e est unique et identique à l'autorité
- [EMC2 - EntretienProfessionnel] Blocage des notifications d'avancement si tous les entretiens (obligatoires et facultatifs initiés) sont à l'état final.

## Modification de la configuration

## Modification en BD

```postgresql

-- ---------------------------------------------------------------------------------------------------------------------
-- AJOUT DE COMPLEMENT SUR LES ACTIONS DE FORMATION A DES FIN D'AFFICHAGE SUR LES CONVOCATIONS -------------------------
-- ---------------------------------------------------------------------------------------------------------------------

alter table formation add complement text;
comment on column formation.complement is 'Information à faire figurer sur les convocations';

-- ---------------------------------------------------------------------------------------------------------------------
-- AJOUT DES GESTIONNAIRES POUR LES DEMANDES EXTERNES ------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

create table formation_demande_externe_gestionnaire
(
    demande_externe_id integer not null
        constraint fdeg_formation_demande_externe_id_fk
            references formation_demande_externe
            on delete cascade,
    gestionnaire_id    integer not null
        constraint fdeg_unicaen_utilisateur_user_id_fk
            references unicaen_utilisateur_user
            on delete cascade,
    constraint formation_demande_externe_gestionnaire_pk
        primary key (demande_externe_id, gestionnaire_id)
);

-- ---------------------------------------------------------------------------------------------------------------------
-- RQTH - INSCRIPTION AU PLAN DE FORMATION -----------------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

alter table formation_inscription add rqth boolean default false not null;
alter table formation_inscription add precision_rqth text;

-- ---------------------------------------------------------------------------------------------------------------------
-- MACRO - QoL ---------------------------------------------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('SESSION#id', '<p>Retroune l''id numérique de la session</p>', 'session', 'getId');

-- ---------------------------------------------------------------------------------------------------------------------
-- TEMPLATE ET MACRO POUR CONVOCATION ET ATTESTATION -------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

-- Template notification
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('FORMATION_SESSION_ATTESTATION', '<p>Mail pour l''attestation envoyé aux agents</p>', 'mail', 'La session de formation VAR[SESSION#libelle] du VAR[SESSION#periode] va est maintenant terminée', e'<p><strong>Université de démonstration</strong><br />DRH - Bureau des formations<br /><br />le VAR[EMC2#date]<br /><br /> <br />Bonjour VAR[AGENT#Denomination],<br /> <br />La session de formation VAR[SESSION#libelle] (VAR[SESSION#identification]) du VAR[SESSION#periode] à laquelle vous avez participé est maintenant terminée.</p><p>Vous pouvez récupérer votre attestation à l\'adresse suivante : VAR[URL#Attestation].<br />Cette attestation est aussi disponible (et restera disponible) directement sur l\'application VAR[MesFormations#AppLink] dans la rubrique "Mes Formations" &gt; "Mes formations réalisées".<br /><br /> <br />Le bureau conseil, carrière, compétences.<br />drh.formation@unicaen.fr<br /><br /><br /></p>', null, 'Formation\Provider\Template');
-- Nouvelles macros
INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('URL#Attestation', '<p>Retroune le lien vers le téléchargement de l''inscription</p>', 'UrlService', 'getUrlAttestation'),
('URL#Convocation', '<p>Retroune le lien vers le téléchargement de la convocation</p>', 'UrlService', 'getUrlConvocation');

-- ---------------------------------------------------------------------------------------------------------------------
-- CONSTAT D'ABSENCE ---------------------------------------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

-- Template PDF
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('FORMATION_ABSENCE', '<p>Document émis pour les inscrit·es qui ont été absent·es à une formation</p>', 'pdf', 'constat_absence_session_VAR[SESSION#id]', e'<p><strong>Université de démonstration</strong><br />DRH - Bureau des formations</p>
<h1 style="text-align: center;">Constat d\'absence à un stage</h1>
<p><br />le VAR[EMC2#date]</p>
<p><br />Je soussigné, Prenom NOM, Président de l’Université de démonstration, certifie que VAR[AGENT#Denomination] n\'a pas participé au stage de formation suivant : </p>
<p>VAR[SESSION#libelle]</p>
<p>qui s\'est déroulé du VAR[SESSION#periode] ayant une durée de VAR[SESSION#duree].</p>
<p> </p>
<p>VAR[AGENT#Denomination] a suivi une durée de VAR[INSCRIPTION#duree].</p>
<p> </p>
<p>Je vous prie de bien vouloir justifier votre absence auprès du bureau de la formation.</p>
<p> </p>
<p><br />Le bureau de formation<br />drh.formation@univ-demo.fr<br /><br /><br /><br /></p>
<p> </p>', null, 'Formation\Provider\Template');
-- Template notification
INSERT INTO public.unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('FORMATION_SESSION_ABSENCE', '<p>Mail pour le constat d''absence envoyé aux agents</p>', 'mail', 'La session de formation VAR[SESSION#libelle] du VAR[SESSION#periode] va est maintenant terminée', e'<p><strong>Université de démonstration</strong><br />DRH - Bureau des formations<br /><br />le VAR[EMC2#date]<br /><br /> <br />Bonjour VAR[AGENT#Denomination],<br /> <br />La session de formation VAR[SESSION#libelle] (VAR[SESSION#identification]) du VAR[SESSION#periode] à laquelle vous avez participé est maintenant terminée.</p>
<p>Des absences ont été renseignées pour cette session de formation. Vous pouvez récupérer votre constat d\'absence à l\'adresse suivante : VAR[URL#Absence].<br />Ce constat est aussi disponible (et restera disponible) directement sur l\'application VAR[MesFormations#AppLink] dans la rubrique "Mes Formations" &gt; "Mes formations réalisées".<br /><br /> <br />Le bureau conseil, carrière, compétences.<br />drh.formation@unicaen.fr<br /><br /><br /><br /></p>
<p> </p>', null, 'Formation\Provider\Template');
-- Nouvelle macro
INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES ('URL#Absence', '<p>Retroune le lien vers le téléchargement du constat d''absence</p>', 'UrlService', 'getUrlAbsence');

-- Privilege
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'formationinstancedocument_absence', 'Génération des constats d''absence', 35
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'formationinstancedocument';

-- ---------------------------------------------------------------------------------------------------------------------
-- CHARTE POUR LA PARTIE FORMATION -------------------------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

-- table pour les validations à attacher à l'agents
create table agent_validation
(
    agent_id               varchar(40) not null
        constraint agent_validation_agent_c_individu_fk references agent on delete cascade,
    validation_instance_id integer     not null
        constraint agent_validation_unicaen_validation_instance_id_fk references unicaen_validation_instance on delete cascade,
    constraint fagent_validation_pk primary key (agent_id, validation_instance_id)
);

-- template

-- validation
INSERT INTO unicaen_validation_type (code, libelle, refusable) VALUES
('FORMATION_CHARTE_SIGNEE', 'Signature de la charte de formation', false);

-- ---------------------------------------------------------------------------------------------------------------------
-- LIEU DE FORMATION ---------------------------------------------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

-- table
create table formation_lieu
(
    id                    serial                  not null
        constraint formation_lieu_pk
            primary key,
    libelle               varchar(1024),
    batiment              varchar(1024),
    campus                varchar(1024),
    ville                 varchar(1024),
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint formation_lieu_unicaen_utilisateur_user_id_fk
            references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint formation_lieu_unicaen_utilisateur_user_id_fk_2
            references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint formation_lieu_unicaen_utilisateur_user_id_fk_3
            references unicaen_utilisateur_user
);

-- changement sur les seances
alter table formation_seance rename column lieu to lieu_old;
alter table formation_seance alter column lieu_old drop not null;   
alter table formation_seance add lieu_id integer;
alter table formation_seance add constraint formation_seance_formation_lieu_id_fk foreign key (lieu_id) references formation_lieu on delete set null;

-- privilege
INSERT INTO unicaen_privilege_categorie (code, libelle, ordre, namespace)
VALUES ('formationlieu','Gestion des lieus',360,'Formation\Provider\Privilege');
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'formationlieu_index', 'Accéder à l''index', 10 UNION
    SELECT 'formationlieu_afficher', 'Afficher', 20 UNION
    SELECT 'formationlieu_ajouter', 'Ajouter', 30 UNION
    SELECT 'formationlieu_modifier', 'Modifier', 40 UNION
    SELECT 'formationlieu_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'formationlieu_supprimer', 'Supprimer', 60 
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'formationlieu';

```
## Évolution des librairies

Nouvelle version de unicaen/synchro (6.0.6) pour meilleur gestion des synchrnoisations avec de multiples sources
Nouvelle version de unicaen/synchro (6.1.7) correction du bégémment et mention "re-expedition du mail du XX/XX/XXXX"

```bash
composer update unicaen/mail
composer update unicaen/synchro
```

ou

```bash
rm -fr vendor
rm -fr composer.lock
composer install
```

## Évolution des macros et templates

### Amélioration des notifications pour les convocations et les attestations

Un nouveau template _dupliquant_ le template de notification de la convocation a été ajouté pour les attestations `FORMATION_SESSION_ATTESTATION`.
Afin d'améliorer aussi le contenu de ces templates deux nouvelles macros ont été ajoutées pour fornir le lien vers le téléchargement de la convocation `URL#Convocation` et de l'attestation `URL#Attestation` (attention elle utilise une inscription comme élément de base).

### Constat d'absence 

Un nouveau template a été ajouté pour la génération des constats d'absence `FORMATION_ABSENCE`, et pour la notification `FORMATION_SESSION_ABSENCE`.
Comme pour les convoctation et attestation une macro permet de retourner le lien du téléchargement de celui-ci `URL#Absence`.

## Évolution des paramètres

### Gestion des constats d'absence 

Un nouveau privilège a été ajouter pour le contrôle de la gestion de la génération des constats d'absence : Gestion des formations - Documents > Génération des constats d'absence.
Par défaut il est recommandé de l'attribuer aux administrateurs, gestionnaires de formations et aux inscrits (agent·es et stagiaire·s externe·s).

## Évolution de la liste des privileges
