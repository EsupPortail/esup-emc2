# Version 5.1.0 RC (14/05/2025) 

## Changements 

[NOUVEAUTE]
* Ajout de l'importation en masse depuis REFERENS3 avec création des données connexes
* Possibilité de clôturer les chaînes hiérarchiques lors de la saisie d'une nouvelle
* Ajout de boutons pour faire l'extraction des chaines hiérarchiques depuis l'écran de gestion dédié
* Possibilité de renseigner une durée estimée pour un entretien professionnel afin de mieux paramètres l'ICS associé
* Importation depuis un csv des observateurs
* Ajout de la possibilité de déclarer des types de contact
* Ajout de la possibilité de déclarer des contacts au niveau des structures

[EVOLUTION]
* Ajout d'une limite d'appel concurrent pour la vue stratégique par structures de la campagne d'entretien professionnel
* Changement de la gestion des campagnes d'entretien professionnel pour les SHD, AH et les structures.
* La notion de domaine est absence de référence et est subsititué par la notion de famille d'activité professionnelle (FAP)
* Amélioration du comportement du 'Search&Select' de la page agent réagissant au cas où aucune sélection est faite.

[CORRECTION]
* Changement de l'affichage des 'select' associée à la fiche métier pour les compétences, les compétences spécifiques et les applications
* Problème de modal non fermé après la saisie d'une chaine hiérarchique depuis la page de gestion des chaînes hiérarchiques

## Modification de la configuration

Aucun

## Modification en BD

[SANS BDDADMIN] Modification des tables associées aux métiers
```postgresql
drop table metier_domaine_famille;

create table metier_metier_domaine
(
    metier_id  integer not null
        constraint metier_domaine_metier_id_fk
            references metier_metier
            on delete cascade,
    domaine_id integer not null
        constraint metier_domaine_domaine_id_fk
            references metier_domaine
            on delete cascade,
    constraint metier_domaine_pk
        primary key (domaine_id, metier_id)
);
create index metier_metier_domaine_domaine_id_index on metier_metier_domaine (domaine_id);
create index metier_metier_domaine_metier_id_index on metier_metier_domaine (metier_id);

create table metier_metier_correspondance
(
    metier_id         integer not null
        constraint metier_metier_correspondance_metier_metier_id_fk
            references metier_metier
            on delete cascade,
    correspondance_id integer not null
        constraint metier_metier_correspondance_carriere_correspondance_id_fk
            references carriere_correspondance
            on delete cascade,
    constraint metier_metier_correspondance_pk
        primary key (metier_id, correspondance_id)
);

create table metier_metier_famille
(
    metier_id  integer not null
        constraint metier_metier_famille_metier_metier_id_fk
            references metier_metier on delete cascade,
    famille_id integer not null
        constraint metier_metier_famille_metier_familleprofessionnelle_id_fk
            references metier_familleprofessionnelle on delete cascade,
    constraint metier_metier_famille_pk primary key (metier_id, famille_id)
);
create index metier_metier_famille_famille_id_index on metier_metier_famille (famille_id);
create index metier_metier_famille_metier_id_index on metier_metier_famille (metier_id);

alter table fichemetier add column raw text;
```

[SANS BDDADMIN] Tables associées à la bibliothèque unicaen/contact
```postgresql

create table unicaen_contact_type
(
    id                    serial
        constraint unicaen_contact_type_pk
            primary key,
    code                  varchar(256)            not null
        constraint unicaen_contact_type_pk_2
            unique,
    libelle               varchar(1024)           not null,
    description           text,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint unicaen_contact_type_unicaen_utilisateur_user_id_fk
            references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint unicaen_contact_type_unicaen_utilisateur_user_id_fk_2
            references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint unicaen_contact_type_unicaen_utilisateur_user_id_fk_3
            references unicaen_utilisateur_user
);

create table unicaen_contact_contact
(
    id                    serial
        constraint unicaen_contact_contact_pk
            primary key,
    type_id               integer                 not null
        constraint unicaen_contact_contact_unicaen_contact_contact_id_fk
            references unicaen_contact_contact,
    service               varchar(1024),
    prenom                varchar(1024),
    nom                   varchar(1024),
    telephone             varchar(64),
    email                 varchar(1024)           not null,
    histo_creation        timestamp default now() not null,
    histo_createur_id     integer   default 0     not null
        constraint unicaen_contact_contact_unicaen_utilisateur_user_id_fk_3
            references unicaen_utilisateur_user,
    histo_modification    timestamp,
    histo_modificateur_id integer
        constraint unicaen_contact_contact_unicaen_utilisateur_user_id_fk_2
            references unicaen_utilisateur_user,
    histo_destruction     timestamp,
    histo_destructeur_id  integer
        constraint unicaen_contact_contact_unicaen_utilisateur_user_id_fk
            references unicaen_utilisateur_user
);
```

Ajout des privilèges pour unicaen/contact
```postgresql

INSERT INTO unicaen_privilege_categorie (code, libelle, ordre, namespace)
VALUES ('contacttype', 'Gestion des types de contact', 1000, 'UnicaenContact\Provider\Privilege');
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'contacttype_index', 'Afficher l''index ', 10 UNION
    SELECT 'contacttype_afficher', 'Afficher', 20 UNION
    SELECT 'contacttype_ajouter', 'Ajouter', 30 UNION
    SELECT 'contacttype_modifier', 'Modifier', 40 UNION
    SELECT 'contacttype_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'contacttype_supprimer', 'Supprimer', 60
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'contacttype';

INSERT INTO unicaen_privilege_categorie (code, libelle, ordre, namespace)
VALUES ('contact', 'Gestion des contacts', 1100, 'UnicaenContact\Provider\Privilege');
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'contact_index', 'Afficher l''index ', 10 UNION
    SELECT 'contact_afficher', 'Afficher', 20 UNION
    SELECT 'contact_ajouter', 'Ajouter', 30 UNION
    SELECT 'contact_modifier', 'Modifier', 40 UNION
    SELECT 'contact_historiser', 'Historiser/Restaurer', 50 UNION
    SELECT 'contact_supprimer', 'Supprimer', 60
)
```

Nouveau privilège pour les chaines
```postgresql
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'chaine_afficher_historique', 'Afficher l''historique', 25
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'chaine';
```

[SANS BDDADMIN] Ajout de la table de jointure entre les contacts et les structures
```postgresql
create table structure_contact
(
    structure_id integer not null
        constraint structure_contact_structure_id_fk
            references structure
            on delete cascade,
    contact_id   integer not null
        constraint structure_contact_unicaen_contact_contact_id_fk
            references unicaen_contact_contact
            on delete cascade,
    constraint structure_contact_pk
        primary key (structure_id, contact_id)
);
```

Paramètre associé à l'affichage du bloc contact sur la fiche de la structure
```postgresql
INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'BLOC_CONTACT', 'Affichage du bloc - Contacts -', null, 'Boolean', 12
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'STRUCTURE';
```

Paramètre associé à l'affichage des emploi-types avec agent
```postgresql
INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'EmploitypeAvecAgent', 'Affichage seulement des emploi-types avec agent·e', null, 'Boolean', 400
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'CARRIERE';
```

Nouveau paramètre associé aux délai d'émission des observations
```postgresql
INSERT INTO unicaen_parametre_parametre(CATEGORIE_ID, CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE)
WITH d(CODE, LIBELLE, DESCRIPTION, VALEURS_POSSIBLES, ORDRE) AS (
    SELECT 'DELAI_OBSERVATION_AGENT', 'Durée de la période d''observation des agent·es (en jours)', '<p>Dur&eacute;e de la p&eacute;riode durant laquelle les agent&middot;es peuvent &agrave; l''issu de la validation du responsable d''entretien professionnel exprimer des observations.<br>La valeur prescrite est de 8 jours.</p>', 'Number', 120
)
SELECT cp.id, d.CODE, d.LIBELLE, d.DESCRIPTION, d.VALEURS_POSSIBLES,  d.ORDRE
FROM d
JOIN unicaen_parametre_categorie cp ON cp.CODE = 'ENTRETIEN_PROFESSIONNEL';
```

Modification des paramètres décrivant la version
```postgresql
update unicaen_parametre_parametre set valeur='5.1.0 RC' where code='VERSION';
update unicaen_parametre_parametre set valeur='16/07/2025' where code='RELEASE_DATE';
```

## Évolution des librairies

Ajout d'unicaen/contact 
Montée en version d'unicaen/aide
Montée en version `unicaen/indicateur` (6.4.0) permettant la gestion des périmétres `_ALL`

## Évolution des macros et templates

Aucune

## Évolution des paramètres

* `ENTRETIEN_PROFESSIONNEL|DELAI_OBSERVATION_AGENT` : paramètre pour permettre de configurer la durée de la période permettant aux agent·es de faire leurs observations (la valeur recommandée pour ce paramètre est 8 jours).
* `CARRIERE|EmploitypeAvecAgent` : paramètre pour contrôler si l'affichage des emploi-types présente ou non les emploi-types sans agent.
* `STRUCTURE|BLOC_CONTACT` : paramètre pour contrôler l'affichage du bloc contact.

## Évolution de la liste des privileges

L'arrivée d'unicaen/contact amène deux nouvelles catégories de privilèges :
1. `conctacttype` pour la déclaration des différents types de contact ;
2. `contact` pour la gestion des contacts eux-mêmes.

chaine_afficher_historique