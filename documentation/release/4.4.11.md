# Version 4.4.11 (XX/06/2024)

## Évolution

- [EMC2 - Entretien Professionnel] Correction de l'export des campagnes traitant incorrectement les agents sans obligation ayant un entretien
- [EMC2 - Entretien Professionnel] Rattachement des événements associés "aux entretiens" à leurs entretiens
- [EMC2 - Entretien Professionnel] Changement de la règle pour la remontée des EPs des supérieur·es et autorités(récupération des EPs précédents même sans responsabilité lors de la campagne précédente)
- [EMC2 - Mes Formations] Ajout de la notion de recette TTC sur les sessions de formation
- [EMC2 - Mes Formations] Nouveau template pour le message sur la page d'inscription des agents aux formations du plan de formation
- [EMC2 - Mes Formations] Affichage d'un résumé dans le listing des formations de l'années (supérieur, autorité, structure)
- [EMC2 - Agent] Changement du terme 'Quotité travaillée' par 'Modalité de service'
- [EMC2 - Agent] Ajout d'un champ modalité de service (chaine de caractère) sur les agents quotités

## Modification de la configuration

## Modification en BD

```postgresql
-- Nouvelles données pour les sessions
alter table formation_instance add recette_ttc double precision;

-- Nouveaux templates textuelles et renommages
update unicaen_renderer_template set code='INSCRIPTION_STAGE_HORS_PLAN' where code='STAGE_HORS_PLAN';
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('INSCRIPTION_FORMATION_DU_PLAN', '<p>Bloc en haut de la page d''inscription à une formation du plan de formation sur la page des agents</p>', 'texte', '.', '<p><strong>La demande d''inscription ne vaut pas acceptation.</strong> Votre inscription est soumise à validation et en fonction des places disponibles.</p>', null, 'Formation\Provider\Template');

-- ---------------------------------------------------------------------------------------------------------------------
-- RATTACHEMENT DES INSTANCES D'EVENEMENT AUX ENTRETIENS PROFESSIONNELS ------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

-- TABLE 
create table entretienprofessionnel_evenement
(
    entretien_id integer not null 
        constraint epe_entretienprofessionnel_id_fk references entretienprofessionnel on delete cascade,
    evenement_id integer not null
        constraint epe_unicaen_evenement_instance_id_fk references unicaen_evenement_instance on delete cascade,
    constraint entretienprofessionnel_evenement_pk primary key (entretien_id, evenement_id)
);
create index entretienprofessionnel_evenement_entretien_id_index on entretienprofessionnel_evenement (entretien_id);
create index entretienprofessionnel_evenement_evenement_id_index on entretienprofessionnel_evenement (evenement_id);
comment on table entretienprofessionnel_agent_force is 'Table de jointure reliant les entretiens professionnels aux événements qui leurs sont associés';

-- REMPLISSAGE POUR LES EVENEMENTS DE RAPPEL DE L'ENTRETIEN 
insert into entretienprofessionnel_evenement (entretien_id, evenement_id)
select cast(SUBSTRING(uei.parametres, 2+12, length(uei.parametres) - (2+12) ) as int) as entretien_id, uei.id as evenement_id
from unicaen_evenement_instance uei
         join unicaen_evenement_type uet on uei.type_id = uet.id
where uet.code in ('rappel_entretienpro') and cast(SUBSTRING(uei.parametres, 2+12, length(uei.parametres) - (2+12) ) as int) in (select id from entretienprofessionnel);

-- REMPLISSAGE POUR LES EVENEMENTS ASSOCIÉS AUX OBSERVATIONS DES AGENTS
insert into entretienprofessionnel_evenement (entretien_id, evenement_id)
select cast(SUBSTRING(uei.parametres, 2+12, length(uei.parametres) - (2+12) ) as int) as entretien_id, uei.id as evenement_id
from unicaen_evenement_instance uei
         join unicaen_evenement_type uet on uei.type_id = uet.id
where uet.code in ('rappel_pas_observation_entretienpro') and cast(SUBSTRING(uei.parametres, 2+12, length(uei.parametres) - (2+12) ) as int) in (select id from entretienprofessionnel);

-- ---------------------------------------------------------------------------------------------------------------------
-- NOUVEAUX PRIVILEGES POUR LA GESTION FINE DES PRIVILEGES -------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

INSERT INTO unicaen_privilege_categorie (code, libelle, ordre, namespace)
VALUES ('inscription','Gestion des inscriptions',400,'Formation\Provider\Privilege');
INSERT INTO unicaen_privilege_privilege(CATEGORIE_ID, CODE, LIBELLE, ORDRE)
WITH d(code, lib, ordre) AS (
    SELECT 'inscription_afficher', 'Afficher', 20
)
SELECT cp.id, d.code, d.lib, d.ordre
FROM d
JOIN unicaen_privilege_categorie cp ON cp.CODE = 'inscription';

-- ---------------------------------------------------------------------------------------------------------------------
-- AUGMENTATION DES INFORMATIONS A PROPOS DES QUOTITES -----------------------------------------------------------------
-- ---------------------------------------------------------------------------------------------------------------------

alter table agent_carriere_quotite add modalite_de_service varchar(1024);

```

## Évolution des librairies

Nouvelle version de unicaen/autoform (6.0.15) pour correction du fonctionnement du bouton 'Bas'
Nouvelle version de unicaen/evenement (6.0.9) pour meilleur gestion des événements associés à des entités internes

```bash
composer update unicaen/autoform
composer update unicaen/evenement
```

ou

```bash
rm -fr vendor
rm -fr composer.lock
composer install
```

## Évolution des macros et templates

### Template `INSCRIPTION_STAGE_HORS_PLAN` (Mes formations)

Ce template est correspond au message informatif affiché en haut de la page d'inscription des agents à des formations du plan de formation

### Template `STAGE_HORS_PLAN` devient `INSCRIPTION_STAGE_HORS_PLAN` 

Le changement ici est à des fins de clareté et pour faire à l'identique du template `INSCRIPTION_FORMATION_DU_PLAN`

### Modification des templates `CREP` ET `CREF`

Il est recommandé d'adapté vos templates de l'entretien professionnelle pour adapter la section descriptive de l'agent.
Le terme 'Quotité travaillée' peut être remplacé par 'Modalité de service'

## Évolution des paramètres

## Évolution de la liste des privileges

### Nouveau privilège pour l'affichage des inscriptions a des formations du plan de formation

La catégorie `Gestion des inscriptions` a été ajouter un prévision du refactoring de `FormationInstanceInscrit`.
Dans cette catégorie on retrouve le privilège `Afficher` qui peut être accordé à tous les rôles.
